<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Z21 LAN Protocol Specification</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="generator" content="pdftohtml 0.36"/>
<meta name="author" content="Roco"/>
<meta name="date" content="2023-11-06T17:56:01+00:00"/>
<meta name="subject" content="Z21 LAN Protocol Specification"/>
<style type="text/css">
<!--
.xflip {
    -moz-transform: scaleX(-1);
    -webkit-transform: scaleX(-1);
    -o-transform: scaleX(-1);
    transform: scaleX(-1);
    filter: fliph;
}
.yflip {
    -moz-transform: scaleY(-1);
    -webkit-transform: scaleY(-1);
    -o-transform: scaleY(-1);
    transform: scaleY(-1);
    filter: flipv;
}
.xyflip {
    -moz-transform: scaleX(-1) scaleY(-1);
    -webkit-transform: scaleX(-1) scaleY(-1);
    -o-transform: scaleX(-1) scaleY(-1);
    transform: scaleX(-1) scaleY(-1);
    filter: fliph + flipv;
}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<a name=1></a><img src="docs/z21-1_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>
<b>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;</b><br/>
<b>Z21 LAN Protocol&#160;</b><br/>
<b>Specification</b>&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
1/78&#160;<br/>
<hr/>
<a name=2></a><img src="docs/z21-2_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/><b>Legal&#160;notices,&#160;exclusion&#160;of liability</b>&#160;<br/>&#160;<br/>Modelleisenbahn&#160;GmbH&#160;expressly&#160;states&#160;that it&#160;shall&#160;under no circumstances&#160;be&#160;legally&#160;liable&#160;for&#160;the&#160;<br/>content&#160;in&#160;this&#160;document&#160;or&#160;for&#160;any&#160;additional&#160;information&#160;specified&#160;in this&#160;document.&#160;<br/>&#160;<br/>The&#160;legal&#160;responsibility&#160;exclusively&#160;lies&#160;with&#160;the&#160;user of&#160;the&#160;data&#160;provided&#160;or with the publisher&#160;of&#160;the&#160;<br/>additional&#160;information&#160;in&#160;question.&#160;<br/>&#160;<br/>The&#160;company&#160;Modelleisenbahn GmbH (of&#160;Plainbachstrasse 4, A-5101 Bergheim,&#160;Austria)&#160;expressly&#160;<br/>accepts&#160;no&#160;liability&#160;for&#160;any&#160;and&#160;all&#160;damages&#160;caused&#160;by&#160;the&#160;use or&#160;by&#160;the&#160;non-use&#160;of&#160;the information&#160;<br/>provided.&#160;<br/>&#160;<br/>Modelleisenbahn&#160;GmbH,&#160;Plainbachstrasse 4,&#160;A-5101&#160;Bergheim,&#160;Austria, accepts&#160;no&#160;responsibility&#160;for&#160;the&#160;<br/>up-to-dateness, correctness, completeness&#160;or&#160;quality&#160;of&#160;the information&#160;provided.&#160;No liability&#160;claims&#160;<br/>relating&#160;to&#160;damages&#160;of a&#160;material,&#160;immaterial&#160;or conceptual&#160;nature&#160;due&#160;to&#160;the&#160;use&#160;or non-use&#160;of&#160;the&#160;<br/>information&#160;shall&#160;be accepted.&#160;<br/>&#160;<br/>Modelleisenbahn&#160;GmbH,&#160;Plainbachstrasse 4,&#160;A-5101&#160;Bergheim,&#160;Austria, reserves&#160;the right&#160;to modify,&#160;<br/>supplement&#160;or&#160;delete&#160;the&#160;information&#160;provided&#160;without&#160;prior&#160;notice.&#160;<br/>&#160;<br/>All&#160;brand&#160;names&#160;and&#160;trademarks&#160;mentioned&#160;in&#160;the&#160;document&#160;and&#160;where applicable protected&#160;by&#160;third&#160;<br/>parties,&#160;are subject without&#160;restriction&#160;to&#160;the&#160;provisions&#160;of&#160;the applicable trademark&#160;law&#160;and&#160;the&#160;ownership&#160;<br/>rights&#160;of&#160;the&#160;respective&#160;registered owners.&#160;<br/>&#160;<br/>The&#160;copyright&#160;for published&#160;information&#160;provided&#160;by&#160;Modelleisenbahn GmbH,&#160;Plainbachstrasse 4,&#160;A-5101&#160;<br/>Bergheim,&#160;Austria&#160;remains&#160;with&#160;Modelleisenbahn&#160;GmbH, Plainbachstrasse 4,&#160;A-5101&#160;Bergheim,&#160;Austria.&#160;<br/>&#160;<br/>Reproduction or&#160;use of the&#160;information&#160;provided&#160;in&#160;other electronic&#160;or&#160;printed&#160;publications&#160;is&#160;not&#160;permitted&#160;<br/>without&#160;express&#160;permission.&#160;<br/>&#160;<br/>Should parts&#160;or&#160;individual&#160;formulations&#160;of&#160;the&#160;liability&#160;disclaimer&#160;not,&#160;no&#160;longer or&#160;not completely&#160;comply&#160;<br/>with&#160;the&#160;applicable legal&#160;position,&#160;the remaining parts&#160;of&#160;the disclaimer&#160;remain unaffected in their&#160;content&#160;<br/>and validity.&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/><b>Publishing info</b>&#160;<br/>&#160;<br/>Apple,&#160;iPad,&#160;iPhone,&#160;iOS&#160;are trademarks&#160;of&#160;Apple&#160;Inc.,&#160;registered in the U.S. and&#160;other&#160;countries.&#160;&#160;<br/>App&#160;Store is&#160;a&#160;service mark&#160;of&#160;Apple Inc.&#160;<br/>Android&#160;is&#160;a&#160;trademark&#160;of&#160;Google Inc.&#160;&#160;<br/>Google Play&#160;is&#160;a&#160;service&#160;mark&#160;of&#160;Google&#160;Inc.&#160;&#160;<br/>RailCom&#160;and&#160;XpressNet&#160;are&#160;registered trademarks&#160;of&#160;the&#160;company&#160;Lenz&#160;Elektronik&#160;GmbH.&#160;<br/>Motorola&#160;is&#160;a&#160;registered trademark&#160;of&#160;Motorola Inc., Tempe-Phoenix,&#160;USA&#160;&#160;<br/>LocoNet&#160;is&#160;a&#160;registered trademark&#160;of Digitrax, Inc.&#160;<br/>&#160;<br/>All&#160;rights&#160;reserved;&#160;errors, omissions&#160;and delivery&#160;options&#160;excepted.&#160;<br/>Specifications&#160;and&#160;illustrations&#160;subject to&#160;amendment.&#160;Subject to alteration.&#160;&#160;<br/>&#160;<br/><i>Publisher: Modelleisenbahn GmbH,&#160;Plainbachstrasse 4, A-5101&#160;Bergheim,&#160;Austria&#160;<br/>&#160;</i><br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
2/78&#160;<br/>
<hr/>
<a name=3></a><img src="docs/z21-3_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/><i>&#160;<br/></i><b>Revision history</b>&#160;<br/>&#160;<br/>
Date&#160;<br/>
Document&#160;version&#160;<br/>
Change&#160;<br/>
06.02.2013&#160;<br/>
1.00&#160;<br/>
Description&#160;of&#160;LAN&#160;interface&#160;&#160;<br/>for&#160;Z21&#160;FW&#160;Version&#160;1.10,&#160;1.11&#160;&#160;<br/>and&#160;SmartRail&#160;FW&#160;Version&#160;1.12&#160;<br/>
20.03.2013&#160;<br/>
1.01&#160;<br/>
<b>Z21&#160;FW&#160;Version&#160;1.20</b>&#160;<br/>LAN_SET_BROADCASTFLAGS:&#160;new&#160;Flags&#160;<br/>LAN_GET_HWINFO:&#160;new&#160;command&#160;<br/>LAN_SET_TURNOUTMODE:&#160;MM&#160;format&#160;<br/>LocoNet:&#160;Gateway&#160;functionality&#160;<br/><b>SmartRail&#160;FW&#160;Version&#160;1.13</b>&#160;<br/>LAN_GET_HWINFO:&#160;new&#160;command&#160;<br/>
29.10.2013&#160;<br/>
1.02<b>&#160;</b><br/>
<b>Z21&#160;FW&#160;Version&#160;1.22:&#160;<br/></b><a href="z21.html#37">Reading&#160;and&#160;writing&#160;Decoder&#160;CVs<b>&#160;<br/></b></a>POM&#160;Read&#160;and&#160;Accessory&#160;Decoder:&#160;new&#160;commands&#160;<br/><b>LocoNet&#160;Dispatch&#160;and&#160;Track&#160;Occupancy&#160;Detector&#160;<br/></b><a href="z21.html#52"><i>LAN_LOCONET_DISPATCH_ADDR</i>:</a>&#160;new&#160;Reply&#160;<br/>LAN_SET_BROADCASTFLAGS:&#160;new&#160;Flags&#160;<br/>LAN_LOCONET_DETECTOR:&#160;new&#160;message&#160;<br/>
12.02.2014&#160;<br/>
1.03<b>&#160;</b><br/>
<b>Z21&#160;FW&#160;Version&#160;1.23</b>&#160;<br/>Correction&#160;of&#160;long&#160;vehicle&#160;address&#160;in&#160;Chapte<a href="z21.html#23">r&#160;4&#160;Driving&#160;<br/></a>LAN_X_MM_WRITE_BYTE&#160;<br/>LAN_LOCONET_DETECTOR:&#160;Extension&#160;for&#160;LISSY&#160;<br/>
25.03.2014&#160;<br/>
1.04<b>&#160;</b><br/>
<b>Z21&#160;FW&#160;Version&#160;1.24&#160;<br/></b>LAN_SET_BROADCASTFLAGS:&#160;Flag&#160;0x00010000&#160;<br/>Chapter<a href="z21.html#30">&#160;5&#160;Switching:&#160;</a>Explanation&#160;Turnout&#160;addressing&#160;<br/>LAN_X_GET_TURNOUT_INFO:&#160;Queue-Bit&#160;Extension&#160;<br/>LAN_X_DCC_WRITE_REGISTER&#160;<br/>
21.01.2015&#160;<br/>
1.05<b>&#160;</b><br/>
<b>Z21&#160;FW&#160;Version&#160;1.25&#160;und&#160;1.26&#160;<br/></b>Chapter<a href="z21.html#23">&#160;4&#160;Driving:&#160;</a>Explanations&#160;about&#160;speed&#160;steps&#160;and&#160;format<b>&#160;<br/></b>LAN_X_DCC_READ_REGISTER&#160;<br/>LAN_X_DCC_WRITE_REGISTER&#160;<br/>LAN_LOCONET_Z21_TX&#160;Binary&#160;State&#160;Control&#160;Instruction&#160;<br/>
05.04.2016&#160;<br/>
1.06<b>&#160;</b><br/>
<b>Z21&#160;FW&#160;Version&#160;1.28&#160;<br/></b>Chapter&#160;2&#160;System&#160;Status&#160;Versions:&#160;z21start&#160;<br/>LAN_GET_HW_INFO&#160;<br/>LAN_GET_CODE&#160;<br/>
19.04.2017&#160;<br/>
1.07<b>&#160;</b><br/>
<b>Z21&#160;FW&#160;Version&#160;1.29&#160;und&#160;1.30&#160;<br/></b>Chapter<a href="z21.html#47">&#160;8&#160;RailCom&#160;<br/></a>Chapter<a href="z21.html#57">&#160;10&#160;CAN&#160;</a><br/>
15.01.2018&#160;<br/>
1.08<b>&#160;</b><br/>
Chapter<a href="z21.html#49">&#160;9&#160;LocoNet&#160;</a>:&#160;Lissy&#160;Examples&#160;<br/>
23.05.2019&#160;<br/>
1.09&#160;en<b>&#160;</b><br/>
First&#160;english&#160;edition&#160;<br/>Chapter&#160;4&#160;Driving:&#160;added&#160;speed&#160;step&#160;coding&#160;infos&#160;<br/>Chapter&#160;7&#160;R-BUS:&#160;added&#160;10808&#160;and&#160;10819&#160;<br/>Chapter&#160;9.3.1&#160;fixed&#160;Binary&#160;State&#160;Control&#160;Instruction&#160;<br/>
28.01.2021&#160;<br/>
1.10&#160;en&#160;<br/>
<b>Z21&#160;FW&#160;Version&#160;1.40&#160;<br/></b>Chapter&#160;4&#160;LAN_GET_HWINFO:&#160;HW-Types&#160;&#160;<br/>Chapter&#160;5&#160;Switching:&#160;Extended&#160;Accessories&#160;DCCext&#160;<br/>Chapter&#160;11&#160;zLink&#160;<br/>
11.08.2021&#160;<br/>
1.11&#160;en&#160;<br/>
<b>Z21&#160;FW&#160;Version&#160;1.41&#160;<br/></b>Chapter&#160;10&#160;CAN:&#160;Booster<b>&#160;</b><br/>
28.02.2022&#160;<br/>
1.12&#160;en&#160;<br/>
<b>Z21&#160;FW&#160;Version&#160;1.42&#160;<br/></b>Chapter&#160;2.18&#160;SystemState:&#160;cseRCN213, Capabilities&#160;<br/>Chapter&#160;4:&#160;DCC&#160;functions&#160;≥&#160;F29,&#160;binary&#160;states&#160;<br/>Chapter&#160;6:&#160;fixed&#160;typo&#160;POM&#160;Read&#160;Byte&#160;„111001MM“&#160;(0xE4)&#160;<br/>Chapter&#160;10.2&#160;and&#160;11.2:&#160;Booster&#160;Management<b>&#160;</b><br/>
08.07.2022&#160;<br/>
1.13&#160;en&#160;<br/>
<b>Z21&#160;FW&#160;Version&#160;1.43&#160;<br/></b>Chapter&#160;4&#160;Driving:&#160;Motorola-Bit&#160;in&#160;LAN_X_LOCO_INFO&#160;<br/>Chapter&#160;4&#160;Driving:&#160;added&#160;commands&#160;for&#160;purging&#160;and&#160;E-STOP&#160;<br/>Chapter&#160;12:&#160;Fastclock&#160;<br/>
&#160;<br/>&#160;<br/><i>&#160;</i><br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
3/78&#160;<br/>
<hr/>
<a name=4></a><img src="docs/z21-4_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/><b>Table&#160;of contents&#160;<br/>&#160;</b><br/>
<a href="z21.html#8"><b>1</b>&#160;</a><br/>
<a href="z21.html#8"><b>BASICS&#160;.................................................................................................................................................&#160;8</b>&#160;</a><br/>
<a href="z21.html#8"><b>1.1</b>&#160;</a><br/>
<a href="z21.html#8"><b>Communication&#160;...............................................................................................................................................&#160;8</b>&#160;</a><br/>
<a href="z21.html#8"><b>1.2</b>&#160;</a><br/>
<a href="z21.html#8"><b>Z21&#160;Dataset&#160;......................................................................................................................................................&#160;8</b>&#160;</a><br/>
<a href="z21.html#8">1.2.1&#160;</a><br/>
<a href="z21.html#8">Structure&#160;....................................................................................................................................................&#160;8&#160;</a><br/>
<a href="z21.html#9">1.2.2&#160;</a><br/>
<a href="z21.html#9">X-BUS Protocol tunneling&#160;........................................................................................................................&#160;9&#160;</a><br/>
<a href="z21.html#9">1.2.3&#160;</a><br/>
<a href="z21.html#9">LocoNet&#160;tunneling&#160;.....................................................................................................................................&#160;9&#160;</a><br/>
<a href="z21.html#10"><b>1.3</b>&#160;</a><br/>
<a href="z21.html#10"><b>Combining&#160;datasets&#160;in one&#160;UDP&#160;packet&#160;......................................................................................................&#160;10</b>&#160;</a><br/>
<a href="z21.html#11"><b>2</b>&#160;</a><br/>
<a href="z21.html#11"><b>SYSTEM,&#160;STATUS, VERSIONS&#160;........................................................................................................&#160;11</b>&#160;</a><br/>
<a href="z21.html#11"><b>2.1</b>&#160;</a><br/>
<a href="z21.html#11"><b>LAN_GET_SERIAL_NUMBER&#160;.................................................................................................................&#160;11</b>&#160;</a><br/>
<a href="z21.html#11"><b>2.2</b>&#160;</a><br/>
<a href="z21.html#11"><b>LAN_LOGOFF&#160;.............................................................................................................................................&#160;11</b>&#160;</a><br/>
<a href="z21.html#11"><b>2.3</b>&#160;</a><br/>
<a href="z21.html#11"><b>LAN_X_GET_VERSION&#160;.............................................................................................................................&#160;11</b>&#160;</a><br/>
<a href="z21.html#12"><b>2.4</b>&#160;</a><br/>
<a href="z21.html#12"><b>LAN_X_GET_STATUS&#160;...............................................................................................................................&#160;12</b>&#160;</a><br/>
<a href="z21.html#12"><b>2.5</b>&#160;</a><br/>
<a href="z21.html#12"><b>LAN_X_SET_TRACK_POWER_OFF&#160;.......................................................................................................&#160;12</b>&#160;</a><br/>
<a href="z21.html#12"><b>2.6</b>&#160;</a><br/>
<a href="z21.html#12"><b>LAN_X_SET_TRACK_POWER_ON.........................................................................................................&#160;12</b>&#160;</a><br/>
<a href="z21.html#13"><b>2.7</b>&#160;</a><br/>
<a href="z21.html#13"><b>LAN_X_BC_TRACK_POWER_OFF.........................................................................................................&#160;13</b>&#160;</a><br/>
<a href="z21.html#13"><b>2.8</b>&#160;</a><br/>
<a href="z21.html#13"><b>LAN_X_BC_TRACK_POWER_ON...........................................................................................................&#160;13</b>&#160;</a><br/>
<a href="z21.html#13"><b>2.9</b>&#160;</a><br/>
<a href="z21.html#13"><b>LAN_X_BC_PROGRAMMING_MODE&#160;...................................................................................................&#160;13</b>&#160;</a><br/>
<a href="z21.html#13"><b>2.10</b>&#160;</a><br/>
<a href="z21.html#13"><b>LAN_X_BC_TRACK_SHORT_CIRCUIT&#160;................................................................................................&#160;13</b>&#160;</a><br/>
<a href="z21.html#14"><b>2.11</b>&#160;</a><br/>
<a href="z21.html#14"><b>LAN_X_UNKNOWN_COMMAND&#160;............................................................................................................&#160;14</b>&#160;</a><br/>
<a href="z21.html#14"><b>2.12</b>&#160;</a><br/>
<a href="z21.html#14"><b>LAN_X_STATUS_CHANGED....................................................................................................................&#160;14</b>&#160;</a><br/>
<a href="z21.html#15"><b>2.13</b>&#160;</a><br/>
<a href="z21.html#15"><b>LAN_X_SET_STOP&#160;.....................................................................................................................................&#160;15</b>&#160;</a><br/>
<a href="z21.html#15"><b>2.14</b>&#160;</a><br/>
<a href="z21.html#15"><b>LAN_X_BC_STOPPED&#160;...............................................................................................................................&#160;15</b>&#160;</a><br/>
<a href="z21.html#15"><b>2.15</b>&#160;</a><br/>
<a href="z21.html#15"><b>LAN_X_GET_FIRMWARE_VERSION&#160;....................................................................................................&#160;15</b>&#160;</a><br/>
<a href="z21.html#16"><b>2.16</b>&#160;</a><br/>
<a href="z21.html#16"><b>LAN_SET_BROADCASTFLAGS&#160;..............................................................................................................&#160;16</b>&#160;</a><br/>
<a href="z21.html#17"><b>2.17</b>&#160;</a><br/>
<a href="z21.html#17"><b>LAN_GET_BROADCASTFLAGS&#160;..............................................................................................................&#160;17</b>&#160;</a><br/>
<a href="z21.html#18"><b>2.18</b>&#160;</a><br/>
<a href="z21.html#18"><b>LAN_SYSTEMSTATE_DATACHANGED&#160;...............................................................................................&#160;18</b>&#160;</a><br/>
<a href="z21.html#19"><b>2.19</b>&#160;</a><br/>
<a href="z21.html#19"><b>LAN_SYSTEMSTATE_GETDATA&#160;...........................................................................................................&#160;19</b>&#160;</a><br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
4/78&#160;<br/>
<hr/>
<a name=5></a><img src="docs/z21-5_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/><a href="z21.html#19"><b>2.20</b>&#160;</a><br/>
<a href="z21.html#19"><b>LAN_GET_HWINFO&#160;...................................................................................................................................&#160;19</b>&#160;</a><br/>
<a href="z21.html#20"><b>2.21</b>&#160;</a><br/>
<a href="z21.html#20"><b>LAN_GET_CODE&#160;........................................................................................................................................&#160;20</b>&#160;</a><br/>
<a href="z21.html#21"><b>3</b>&#160;</a><br/>
<a href="z21.html#21"><b>SETTINGS&#160;..........................................................................................................................................&#160;21</b>&#160;</a><br/>
<a href="z21.html#21"><b>3.1</b>&#160;</a><br/>
<a href="z21.html#21"><b>LAN_GET_LOCOMODE&#160;............................................................................................................................&#160;21</b>&#160;</a><br/>
<a href="z21.html#21"><b>3.2</b>&#160;</a><br/>
<a href="z21.html#21"><b>LAN_SET_LOCOMODE&#160;.............................................................................................................................&#160;21</b>&#160;</a><br/>
<a href="z21.html#22"><b>3.3</b>&#160;</a><br/>
<a href="z21.html#22"><b>LAN_GET_TURNOUTMODE....................................................................................................................&#160;22</b>&#160;</a><br/>
<a href="z21.html#22"><b>3.4</b>&#160;</a><br/>
<a href="z21.html#22"><b>LAN_SET_TURNOUTMODE&#160;....................................................................................................................&#160;22</b>&#160;</a><br/>
<a href="z21.html#23"><b>4</b>&#160;</a><br/>
<a href="z21.html#23"><b>DRIVING&#160;.............................................................................................................................................&#160;23</b>&#160;</a><br/>
<a href="z21.html#23"><b>4.1</b>&#160;</a><br/>
<a href="z21.html#23"><b>LAN_X_GET_LOCO_INFO&#160;.......................................................................................................................&#160;23</b>&#160;</a><br/>
<a href="z21.html#24"><b>4.2</b>&#160;</a><br/>
<a href="z21.html#24"><b>LAN_X_SET_LOCO_DRIVE&#160;.....................................................................................................................&#160;24</b>&#160;</a><br/>
<a href="z21.html#25"><b>4.3</b>&#160;</a><br/>
<a href="z21.html#25"><b>Functions&#160;for&#160;locomotive&#160;decoder&#160;................................................................................................................&#160;25</b>&#160;</a><br/>
<a href="z21.html#25">4.3.1&#160;</a><br/>
<a href="z21.html#25">LAN_X_SET_LOCO_FUNCTION&#160;........................................................................................................&#160;25&#160;</a><br/>
<a href="z21.html#26">4.3.2&#160;</a><br/>
<a href="z21.html#26">LAN_X_SET_LOCO_FUNCTION_GROUP&#160;........................................................................................&#160;26&#160;</a><br/>
<a href="z21.html#27">4.3.3&#160;</a><br/>
<a href="z21.html#27">LAN_X_SET_LOCO_BINARY_STATE&#160;..............................................................................................&#160;27&#160;</a><br/>
<a href="z21.html#28"><b>4.4</b>&#160;</a><br/>
<a href="z21.html#28"><b>LAN_X_LOCO_INFO&#160;..................................................................................................................................&#160;28</b>&#160;</a><br/>
<a href="z21.html#29"><b>4.5</b>&#160;</a><br/>
<a href="z21.html#29"><b>LAN_X_SET_LOCO_E_STOP&#160;...................................................................................................................&#160;29</b>&#160;</a><br/>
<a href="z21.html#29"><b>4.6</b>&#160;</a><br/>
<a href="z21.html#29"><b>LAN_X_PURGE_LOCO&#160;..............................................................................................................................&#160;29</b>&#160;</a><br/>
<a href="z21.html#30"><b>5</b>&#160;</a><br/>
<a href="z21.html#30"><b>SWITCHING&#160;........................................................................................................................................&#160;30</b>&#160;</a><br/>
<a href="z21.html#31"><b>5.1</b>&#160;</a><br/>
<a href="z21.html#31"><b>LAN_X_GET_TURNOUT_INFO&#160;...............................................................................................................&#160;31</b>&#160;</a><br/>
<a href="z21.html#31"><b>5.2</b>&#160;</a><br/>
<a href="z21.html#31"><b>LAN_X_SET_TURNOUT&#160;............................................................................................................................&#160;31</b>&#160;</a><br/>
<a href="z21.html#31">5.2.1&#160;</a><br/>
<a href="z21.html#31">LAN_X_SET_TURNOUT&#160;with&#160;Q=0&#160;.....................................................................................................&#160;31&#160;</a><br/>
<a href="z21.html#33">5.2.2&#160;</a><br/>
<a href="z21.html#33">LAN_X_SET_TURNOUT&#160;with&#160;Q=1&#160;.....................................................................................................&#160;33&#160;</a><br/>
<a href="z21.html#34"><b>5.3</b>&#160;</a><br/>
<a href="z21.html#34"><b>LAN_X_TURNOUT_INFO..........................................................................................................................&#160;34</b>&#160;</a><br/>
<a href="z21.html#35"><b>5.4</b>&#160;</a><br/>
<a href="z21.html#35"><b>LAN_X_SET_EXT_ACCESSORY&#160;.............................................................................................................&#160;35</b>&#160;</a><br/>
<a href="z21.html#36"><b>5.5</b>&#160;</a><br/>
<a href="z21.html#36"><b>LAN_X_GET_EXT_ACCESSORY_INFO&#160;................................................................................................&#160;36</b>&#160;</a><br/>
<a href="z21.html#36"><b>5.6</b>&#160;</a><br/>
<a href="z21.html#36"><b>LAN_X_EXT_ACCESSORY_INFO&#160;...........................................................................................................&#160;36</b>&#160;</a><br/>
<a href="z21.html#37"><b>6</b>&#160;</a><br/>
<a href="z21.html#37"><b>READING&#160;AND&#160;WRITING&#160;DECODER CVS&#160;.......................................................................................&#160;37</b>&#160;</a><br/>
<a href="z21.html#37"><b>6.1</b>&#160;</a><br/>
<a href="z21.html#37"><b>LAN_X_CV_READ&#160;......................................................................................................................................&#160;37</b>&#160;</a><br/>
<a href="z21.html#37"><b>6.2</b>&#160;</a><br/>
<a href="z21.html#37"><b>LAN_X_CV_WRITE&#160;....................................................................................................................................&#160;37</b>&#160;</a><br/>
<a href="z21.html#37"><b>6.3</b>&#160;</a><br/>
<a href="z21.html#37"><b>LAN_X_CV_NACK_SC&#160;...............................................................................................................................&#160;37</b>&#160;</a><br/>
<a href="z21.html#38"><b>6.4</b>&#160;</a><br/>
<a href="z21.html#38"><b>LAN_X_CV_NACK&#160;......................................................................................................................................&#160;38</b>&#160;</a><br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
5/78&#160;<br/>
<hr/>
<a name=6></a><img src="docs/z21-6_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/><a href="z21.html#38"><b>6.5</b>&#160;</a><br/>
<a href="z21.html#38"><b>LAN_X_CV_RESULT&#160;..................................................................................................................................&#160;38</b>&#160;</a><br/>
<a href="z21.html#39"><b>6.6</b>&#160;</a><br/>
<a href="z21.html#39"><b>LAN_X_CV_POM_WRITE_BYTE&#160;............................................................................................................&#160;39</b>&#160;</a><br/>
<a href="z21.html#39"><b>6.7</b>&#160;</a><br/>
<a href="z21.html#39"><b>LAN_X_CV_POM_WRITE_BIT&#160;................................................................................................................&#160;39</b>&#160;</a><br/>
<a href="z21.html#40"><b>6.8</b>&#160;</a><br/>
<a href="z21.html#40"><b>LAN_X_CV_POM_READ_BYTE&#160;..............................................................................................................&#160;40</b>&#160;</a><br/>
<a href="z21.html#41"><b>6.9</b>&#160;</a><br/>
<a href="z21.html#41"><b>LAN_X_CV_POM_ACCESSORY_WRITE_BYTE&#160;.................................................................................&#160;41</b>&#160;</a><br/>
<a href="z21.html#41"><b>6.10</b>&#160;</a><br/>
<a href="z21.html#41"><b>LAN_X_CV_POM_&#160;ACCESSORY_WRITE_BIT&#160;....................................................................................&#160;41</b>&#160;</a><br/>
<a href="z21.html#42"><b>6.11</b>&#160;</a><br/>
<a href="z21.html#42"><b>LAN_X_CV_POM_&#160;ACCESSORY_READ_BYTE&#160;...................................................................................&#160;42</b>&#160;</a><br/>
<a href="z21.html#43"><b>6.12</b>&#160;</a><br/>
<a href="z21.html#43"><b>LAN_X_MM_WRITE_BYTE&#160;.....................................................................................................................&#160;43</b>&#160;</a><br/>
<a href="z21.html#44"><b>6.13</b>&#160;</a><br/>
<a href="z21.html#44"><b>LAN_X_DCC_READ_REGISTER&#160;.............................................................................................................&#160;44</b>&#160;</a><br/>
<a href="z21.html#44"><b>6.14</b>&#160;</a><br/>
<a href="z21.html#44"><b>LAN_X_DCC_WRITE_REGISTER...........................................................................................................&#160;44</b>&#160;</a><br/>
<a href="z21.html#45"><b>7</b>&#160;</a><br/>
<a href="z21.html#45"><b>FEEDBACK&#160;–&#160;R-BUS&#160;.........................................................................................................................&#160;45</b>&#160;</a><br/>
<a href="z21.html#45"><b>7.1</b>&#160;</a><br/>
<a href="z21.html#45"><b>LAN_RMBUS_DATACHANGED&#160;..............................................................................................................&#160;45</b>&#160;</a><br/>
<a href="z21.html#45"><b>7.2</b>&#160;</a><br/>
<a href="z21.html#45"><b>LAN_RMBUS_GETDATA&#160;..........................................................................................................................&#160;45</b>&#160;</a><br/>
<a href="z21.html#46"><b>7.3</b>&#160;</a><br/>
<a href="z21.html#46"><b>LAN_RMBUS_PROGRAMMODULE&#160;.......................................................................................................&#160;46</b>&#160;</a><br/>
<a href="z21.html#47"><b>8</b>&#160;</a><br/>
<a href="z21.html#47"><b>RAILCOM&#160;............................................................................................................................................&#160;47</b>&#160;</a><br/>
<a href="z21.html#47"><b>8.1</b>&#160;</a><br/>
<a href="z21.html#47"><b>LAN_RAILCOM_DATACHANGED&#160;.........................................................................................................&#160;47</b>&#160;</a><br/>
<a href="z21.html#48"><b>8.2</b>&#160;</a><br/>
<a href="z21.html#48"><b>LAN_RAILCOM_GETDATA&#160;.....................................................................................................................&#160;48</b>&#160;</a><br/>
<a href="z21.html#49"><b>9</b>&#160;</a><br/>
<a href="z21.html#49"><b>LOCONET&#160;...........................................................................................................................................&#160;49</b>&#160;</a><br/>
<a href="z21.html#50"><b>9.1</b>&#160;</a><br/>
<a href="z21.html#50"><b>LAN_LOCONET_Z21_RX&#160;..........................................................................................................................&#160;50</b>&#160;</a><br/>
<a href="z21.html#50"><b>9.2</b>&#160;</a><br/>
<a href="z21.html#50"><b>LAN_LOCONET_Z21_TX&#160;..........................................................................................................................&#160;50</b>&#160;</a><br/>
<a href="z21.html#51"><b>9.3</b>&#160;</a><br/>
<a href="z21.html#51"><b>LAN_LOCONET_FROM_LAN&#160;..................................................................................................................&#160;51</b>&#160;</a><br/>
<a href="z21.html#51">9.3.1&#160;</a><br/>
<a href="z21.html#51">DCC&#160;Binary&#160;State&#160;Control Instruction&#160;via&#160;LocoNet&#160;OPC_IMM_PACKET&#160;...........................................&#160;51&#160;</a><br/>
<a href="z21.html#52"><b>9.4</b>&#160;</a><br/>
<a href="z21.html#52"><b>LAN_LOCONET_DISPATCH_ADDR&#160;......................................................................................................&#160;52</b>&#160;</a><br/>
<a href="z21.html#53"><b>9.5</b>&#160;</a><br/>
<a href="z21.html#53"><b>LAN_LOCONET_DETECTOR&#160;..................................................................................................................&#160;53</b>&#160;</a><br/>
<a href="z21.html#57"><b>10</b>&#160;</a><br/>
<a href="z21.html#57"><b>CAN&#160;.................................................................................................................................................&#160;57</b>&#160;</a><br/>
<a href="z21.html#57"><b>10.1</b>&#160;</a><br/>
<a href="z21.html#57"><b>LAN_CAN_DETECTOR&#160;.............................................................................................................................&#160;57</b>&#160;</a><br/>
<a href="z21.html#59"><b>10.2</b>&#160;</a><br/>
<a href="z21.html#59"><b>CAN&#160;Booster&#160;..................................................................................................................................................&#160;59</b>&#160;</a><br/>
<a href="z21.html#59">10.2.1&#160;</a><br/>
<a href="z21.html#59">LAN_CAN_DEVICE_GET_DESCRIPTION&#160;........................................................................................&#160;59&#160;</a><br/>
<a href="z21.html#59">10.2.2&#160;</a><br/>
<a href="z21.html#59">LAN_CAN_DEVICE_SET_DESCRIPTION&#160;.........................................................................................&#160;59&#160;</a><br/>
<a href="z21.html#60">10.2.3&#160;</a><br/>
<a href="z21.html#60">LAN_CAN_BOOSTER_SYSTEMSTATE_CHGD&#160;...............................................................................&#160;60&#160;</a><br/>
<a href="z21.html#61">10.2.4&#160;</a><br/>
<a href="z21.html#61">LAN_CAN_BOOSTER_SET_TRACKPOWER&#160;....................................................................................&#160;61&#160;</a><br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
6/78&#160;<br/>
<hr/>
<a name=7></a><img src="docs/z21-7_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/><a href="z21.html#62"><b>11</b>&#160;</a><br/>
<a href="z21.html#62"><b>ZLINK&#160;..............................................................................................................................................&#160;62</b>&#160;</a><br/>
<a href="z21.html#62"><b>11.1</b>&#160;</a><br/>
<a href="z21.html#62"><b>Adapter&#160;..........................................................................................................................................................&#160;62</b>&#160;</a><br/>
<a href="z21.html#62">11.1.1&#160;</a><br/>
<a href="z21.html#62">10838&#160;Z21&#160;pro&#160;LINK&#160;..............................................................................................................................&#160;62&#160;</a><br/>
<a href="z21.html#63">11.1.1.1&#160;</a><br/>
<a href="z21.html#63">LAN_ZLINK_GET_HWINFO&#160;.......................................................................................................&#160;63&#160;</a><br/>
<a href="z21.html#64"><b>11.2</b>&#160;</a><br/>
<a href="z21.html#64"><b>Booster&#160;10806,&#160;10807&#160;und 10869&#160;..................................................................................................................&#160;64</b>&#160;</a><br/>
<a href="z21.html#64">11.2.1&#160;</a><br/>
<a href="z21.html#64">LAN_BOOSTER_GET_DESCRIPTION&#160;...............................................................................................&#160;64&#160;</a><br/>
<a href="z21.html#64">11.2.2&#160;</a><br/>
<a href="z21.html#64">LAN_BOOSTER_SET_DESCRIPTION&#160;...............................................................................................&#160;64&#160;</a><br/>
<a href="z21.html#65">11.2.3&#160;</a><br/>
<a href="z21.html#65">LAN_BOOSTER_SYSTEMSTATE_GETDATA&#160;..................................................................................&#160;65&#160;</a><br/>
<a href="z21.html#65">11.2.4&#160;</a><br/>
<a href="z21.html#65">LAN_BOOSTER_SYSTEMSTATE_DATACHANGED&#160;......................................................................&#160;65&#160;</a><br/>
<a href="z21.html#66">11.2.5&#160;</a><br/>
<a href="z21.html#66">LAN_BOOSTER_SET_POWER&#160;...........................................................................................................&#160;66&#160;</a><br/>
<a href="z21.html#67"><b>11.3</b>&#160;</a><br/>
<a href="z21.html#67"><b>Decoder&#160;10836&#160;und 10837&#160;.............................................................................................................................&#160;67</b>&#160;</a><br/>
<a href="z21.html#67">11.3.1&#160;</a><br/>
<a href="z21.html#67">LAN_DECODER_GET_DESCRIPTION&#160;..............................................................................................&#160;67&#160;</a><br/>
<a href="z21.html#67">11.3.2&#160;</a><br/>
<a href="z21.html#67">LAN_DECODER_SET_DESCRIPTION&#160;...............................................................................................&#160;67&#160;</a><br/>
<a href="z21.html#67">11.3.3&#160;</a><br/>
<a href="z21.html#67">LAN_DECODER_SYSTEMSTATE_GETDATA&#160;.................................................................................&#160;67&#160;</a><br/>
<a href="z21.html#68">11.3.4&#160;</a><br/>
<a href="z21.html#68">LAN_DECODER_SYSTEMSTATE_DATACHANGED&#160;.....................................................................&#160;68&#160;</a><br/>
<a href="z21.html#68">11.3.4.1&#160;</a><br/>
<a href="z21.html#68">SwitchDecoderSystemState.............................................................................................................&#160;68&#160;</a><br/>
<a href="z21.html#70">11.3.4.2&#160;</a><br/>
<a href="z21.html#70">SignalDecoderSystemState&#160;.............................................................................................................&#160;70&#160;</a><br/>
<a href="z21.html#71"><b>12</b>&#160;</a><br/>
<a href="z21.html#71"><b>FAST&#160;CLOCK&#160;..................................................................................................................................&#160;71</b>&#160;</a><br/>
<a href="z21.html#71"><b>12.1</b>&#160;</a><br/>
<a href="z21.html#71"><b>LAN_FAST_CLOCK_CONTROL&#160;.............................................................................................................&#160;71</b>&#160;</a><br/>
<a href="z21.html#71">12.1.1&#160;</a><br/>
<a href="z21.html#71">Get&#160;Fast&#160;Clock&#160;Time&#160;...............................................................................................................................&#160;71&#160;</a><br/>
<a href="z21.html#71">12.1.2&#160;</a><br/>
<a href="z21.html#71">Set Fast&#160;Clock&#160;Time&#160;................................................................................................................................&#160;71&#160;</a><br/>
<a href="z21.html#72">12.1.3&#160;</a><br/>
<a href="z21.html#72">Start Fast&#160;Clock&#160;Time&#160;..............................................................................................................................&#160;72&#160;</a><br/>
<a href="z21.html#72">12.1.4&#160;</a><br/>
<a href="z21.html#72">Stop&#160;Fast Clock&#160;Time&#160;..............................................................................................................................&#160;72&#160;</a><br/>
<a href="z21.html#73"><b>12.2</b>&#160;</a><br/>
<a href="z21.html#73"><b>LAN_FAST_CLOCK_DATA&#160;......................................................................................................................&#160;73</b>&#160;</a><br/>
<a href="z21.html#74"><b>12.3</b>&#160;</a><br/>
<a href="z21.html#74"><b>LAN_FAST_CLOCK_SETTINGS_GET&#160;...................................................................................................&#160;74</b>&#160;</a><br/>
<a href="z21.html#75"><b>12.4</b>&#160;</a><br/>
<a href="z21.html#75"><b>LAN_FAST_CLOCK_SETTINGS_SET&#160;....................................................................................................&#160;75</b>&#160;</a><br/>
<a href="z21.html#76"><b>APPENDIX&#160;A&#160;–&#160;COMMAND OVERVIEW&#160;..................................................................................................&#160;76</b>&#160;</a><br/>
<a href="z21.html#76"><b>Client&#160;to&#160;Z21&#160;..............................................................................................................................................................&#160;76</b>&#160;</a><br/>
<a href="z21.html#77"><b>Z21&#160;to&#160;Client&#160;..............................................................................................................................................................&#160;77</b>&#160;</a><br/>
<a href="z21.html#78"><b>LIST&#160;OF&#160;FIGURES&#160;.....................................................................................................................................&#160;78</b>&#160;</a><br/>
<a href="z21.html#78"><b>LIST&#160;OF&#160;TABLES&#160;......................................................................................................................................&#160;78</b>&#160;<br/></a>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
7/78&#160;<br/>
<hr/>
<a name=8></a><img src="docs/z21-8_1.png"/><br/>
<img src="docs/z21-8_2.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>&#160;<br/>
<b>1&#160;&#160;Basics&#160;<br/></b>&#160;<br/>
<i><b>1.1&#160;</b></i><br/>
<i><b>Communication&#160;</b></i><br/>
&#160;<br/>Communication&#160;with&#160;the&#160;command&#160;station&#160;Z21&#160;is&#160;done&#160;via UDP&#160;by&#160;using&#160;port&#160;21105&#160;or 21106. Control&#160;<br/>applications&#160;on&#160;the&#160;client&#160;(PC, App,&#160;...)&#160;should&#160;primarily&#160;use port&#160;21105.&#160;<br/>&#160;<br/>Communication&#160;is&#160;always&#160;asynchronous, i.e.&#160;broadcast&#160;messages&#160;can occur between&#160;a request and&#160;the&#160;<br/>corresponding&#160;response.&#160;&#160;<br/>
&#160;<br/>
Figure&#160;1&#160;Example&#160;Sequence:&#160;Communication&#160;<br/>
&#160;<br/>
Each client&#160;is&#160;expected&#160;to&#160;communicate&#160;with&#160;the&#160;Z21&#160;once per&#160;minute,&#160;otherwise&#160;it&#160;will&#160;be&#160;removed&#160;from&#160;<br/>the&#160;list of active&#160;participants. If&#160;possible,&#160;a&#160;client should log off from&#160;the&#160;command&#160;station with&#160;the&#160;<br/>command<a href="z21.html#11">&#160;LAN_LOGOFF.</a>&#160;<br/>&#160;<br/>
<i><b>1.2&#160;</b></i><br/>
<i><b>Z21&#160;Dataset&#160;</b></i><br/>
<b>1.2.1&#160;</b><br/>
<b>Structure&#160;</b><br/>
&#160;<br/>A&#160;Z21&#160;data&#160;record,&#160;i.e. a&#160;request or&#160;response,&#160;is&#160;structured&#160;in the following&#160;way:&#160;<br/>&#160;<br/>
<b>DataLen&#160;(2 Byte)&#160;</b><br/>
<b>Header&#160;(2 Byte)&#160;</b><br/>
<b>Data (n&#160;Bytes)</b>&#160;<br/>
&#160;<br/>
•&#160;&#160;<b>DataLen</b>&#160;(little endian):&#160;&#160;<br/>
Total&#160;length&#160;over the entire&#160;data&#160;set including DataLen,&#160;Header and Data,&#160;i.e.&#160;DataLen =&#160;2+2+n.<b>&#160;</b><br/>
•&#160;&#160;<b>Header</b>&#160;(little endian):&#160;&#160;<br/>
Describes&#160;the Command&#160;and&#160;the Protocol’s&#160;group.&#160;<br/>
•&#160;&#160;<b>Data</b>:&#160;&#160;<br/>
Structure&#160;and&#160;number&#160;depend&#160;on the command.&#160;For a&#160;detailed&#160;description, see the respective&#160;<br/>command.&#160;<br/>&#160;<br/>
Unless&#160;otherwise specified,&#160;the&#160;byte&#160;order is&#160;little-endian,&#160;i.e.&#160;first the low byte,&#160;then&#160;the high&#160;byte.&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
8/78&#160;<br/>
<hr/>
<a name=9></a><img src="docs/z21-9_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>1.2.2&#160;</b><br/>
<b>X-BUS&#160;Protocol&#160;tunneling&#160;&#160;</b><br/>
&#160;<br/>Requests&#160;and&#160;responses&#160;<i>based</i>&#160;on the X-BUS&#160;protocol&#160;are transmitted&#160;with&#160;the Z21-LAN-Header&#160;<b>0x40&#160;<br/>(<i>LAN_X</i></b><b>_</b>xxx). This&#160;only&#160;refers&#160;to&#160;the&#160;protocol,&#160;because these&#160;commands&#160;have nothing&#160;to do with&#160;the&#160;<br/>physical&#160;X-BUS&#160;of the&#160;Z21,&#160;but&#160;are&#160;exclusively&#160;addressed to the&#160;LAN&#160;clients&#160;or the Z21.&#160;<br/>&#160;<br/>The&#160;actual&#160;X-BUS&#160;command&#160;is&#160;located&#160;inside&#160;the&#160;Data&#160;field within&#160;the&#160;Z21&#160;data&#160;record.&#160;The&#160;last byte is&#160;a&#160;<br/>checksum&#160;and&#160;is&#160;calculated&#160;as&#160;XOR via the X-BUS&#160;command.&#160;Example:&#160;<br/>&#160;<br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x08&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>h&#160;</b><br/>
<b>x&#160;</b><br/>
<b>y</b>&#160;<br/>
h XOR x&#160;XOR y&#160;<br/>
&#160;<br/>&#160;<br/>
<b>1.2.3&#160;</b><br/>
<b>LocoNet&#160;tunneling&#160;&#160;</b><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.20.&#160;&#160;<br/></b>&#160;<br/>With the&#160;Z21-LAN&#160;headers&#160;0xA0 and&#160;0xA1 (LAN_LOCONET_Z21_RX, LAN_LOCONET_Z21_TX),&#160;<br/>messages&#160;received&#160;or sent&#160;by&#160;the Z21&#160;on the&#160;LocoNet&#160;bus&#160;are forwarded to&#160;the&#160;LAN client. The&#160;LAN&#160;<br/>client&#160;can&#160;subscribe&#160;to&#160;these&#160;LocoNet&#160;messages&#160;by&#160;using&#160;the<a href="z21.html#16">&#160;<i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS.</a>&#160;<br/>&#160;<br/>The&#160;LAN client can&#160;write&#160;messages&#160;to&#160;the&#160;LocoNet bus&#160;via the&#160;Z21-LAN&#160;header&#160;<b>0xA2&#160;<br/>(LAN_LOCONET_FROM_LAN</b>).&#160;&#160;<br/>&#160;<br/>This&#160;way&#160;the Z21&#160;can&#160;be&#160;used&#160;as&#160;an&#160;Ethernet/LocoNet&#160;gateway, where the&#160;Z21&#160;is&#160;also the&#160;LocoNet&#160;<br/>master&#160;managing&#160;the&#160;refresh slots&#160;and&#160;generating&#160;the&#160;DCC packets.&#160;<br/>&#160;<br/>The&#160;actual&#160;LocoNet&#160;message&#160;is&#160;located&#160;inside&#160;the Data field&#160;within the Z21&#160;data record.&#160;<br/>&#160;<br/>Example&#160;Loconet&#160;message&#160;OPC_MOVE_SLOTS&#160;&lt;0&gt;&lt;0&gt;&#160;(„DISPATCH_GET“)&#160;is&#160;sent by&#160;the Z21:&#160;<br/>&#160;<br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>OPC&#160;</b><br/>
<b>ARG1&#160;</b><br/>
<b>ARG2&#160;</b><br/>
<b>CKSUM</b>&#160;<br/>
0x08&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xA0</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xBA&#160;</b><br/>
<b>0x00&#160;</b><br/>
<b>0x00</b>&#160;<br/>
<b>0x45&#160;</b><br/>
&#160;<br/>More&#160;information&#160;about&#160;the&#160;LocoNet&#160;Gateway&#160;can&#160;be found&#160;in&#160;sectio<a href="z21.html#49">n&#160;<i><b>9&#160;</b></i>LocoNet.</a>&#160;<br/>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
9/78&#160;<br/>
<hr/>
<a name=10></a><img src="docs/z21-10_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>1.3&#160;</b></i><br/>
<i><b>Combining&#160;datasets&#160;in&#160;one&#160;UDP&#160;packet&#160;</b></i><br/>
&#160;<br/>In&#160;the&#160;payload&#160;data&#160;of a&#160;UDP&#160;packet,&#160;several&#160;independent&#160;Z21 data&#160;sets&#160;can&#160;also&#160;be&#160;sent&#160;together to&#160;one&#160;<br/>recipient.&#160;Each recipient&#160;must be&#160;able to&#160;interpret&#160;these combined&#160;Z21 dataset&#160;packets.&#160;<br/>&#160;<br/><b>Example</b>&#160;<br/>&#160;<br/>Following&#160;combined&#160;Z21&#160;datasets&#160;in&#160;one&#160;UDP&#160;packet...&#160;<br/>&#160;<br/>
<b>UDP&#160;Paket</b>&#160;<br/><b>IP&#160;Header&#160;</b><br/>
<b>UDP&#160;Header&#160;</b><br/>
<b>UDP&#160;Payload</b>&#160;<br/><b>Z21&#160;Dataset&#160;1&#160;</b><br/>
<b>Z21&#160;Dataset&#160;2&#160;</b><br/>
<b>Z21&#160;Dataset&#160;3</b>&#160;<br/>
LAN_X_GET_TOURNOUT_INFO&#160;#4&#160;<br/>
LAN_X_GET_TOURNOUT_INFO&#160;#5&#160;<br/>
LAN_RMBUS_GETDATA&#160;#0&#160;<br/>
&#160;<br/>...&#160;is&#160;equivalent&#160;to these three&#160;UDP&#160;packets:&#160;<br/>&#160;<br/>
<b>UDP&#160;Paket 1</b>&#160;<br/><b>IP&#160;Header&#160;</b><br/>
<b>UDP&#160;Header&#160;</b><br/>
<b>UDP&#160;Payload</b>&#160;<br/><b>Z21&#160;dataset</b>&#160;<br/>LAN_X_GET_TOURNOUT_INFO&#160;#4&#160;<br/>
&#160;<br/>
<b>UDP&#160;Paket 2</b>&#160;<br/><b>IP&#160;Header&#160;</b><br/>
<b>UDP&#160;Header&#160;</b><br/>
<b>UDP&#160;Payload</b>&#160;<br/><b>Z21&#160;dataset</b>&#160;<br/>LAN_X_GET_TOURNOUT_INFO&#160;#5&#160;<br/>
&#160;<br/>
<b>UDP&#160;Paket 3</b>&#160;<br/><b>IP&#160;Header&#160;</b><br/>
<b>UDP&#160;Header&#160;</b><br/>
<b>UDP&#160;Payload</b>&#160;<br/><b>Z21&#160;dataset</b>&#160;<br/>LAN_RMBUS_GETDATA&#160;#0&#160;<br/>
&#160;<br/>The&#160;UDP&#160;packet&#160;must fit&#160;into an&#160;Ethernet&#160;MTU,&#160;i.e.&#160;considering&#160;IPv4 header and UDP&#160;header&#160;there&#160;is&#160;a&#160;<br/>maximum&#160;of&#160;1500-20-8 =&#160;1472&#160;bytes&#160;of&#160;payload&#160;data.&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
10/78&#160;<br/>
<hr/>
<a name=11></a><img src="docs/z21-11_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>2&#160;&#160;System,&#160;Status,&#160;Versions&#160;</b><br/>
<i><b>2.1&#160;</b></i><br/>
<i><b>LAN_GET_SERIAL_NUMBER&#160;</b></i><br/>
&#160;<br/>Reading&#160;the&#160;serial&#160;number&#160;of the Z21.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x04&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x10</b>&#160;<br/>
0x00&#160;<br/>
-&#160;<br/>
&#160;<br/>Reply&#160;from&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x08&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x10</b>&#160;<br/>
0x00&#160;<br/>
32&#160;Bits&#160;Serial&#160;number&#160;(little&#160;endian)&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>2.2&#160;</b></i><br/>
<i><b>LAN_LOGOFF&#160;</b></i><br/>
&#160;<br/>Logging off&#160;the&#160;client from&#160;the&#160;Z21.&#160;&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x04&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x30</b>&#160;<br/>
0x00&#160;<br/>
-&#160;<br/>
&#160;<br/>Reply&#160;from&#160;Z21:&#160;&#160;<br/>none&#160;<br/>&#160;<br/>Use the&#160;same&#160;port number&#160;when&#160;logging&#160;out&#160;as&#160;when logging&#160;in.&#160;<br/>&#160;<br/><b>Note:</b>&#160;the&#160;login&#160;is&#160;implicitly&#160;done&#160;with&#160;the&#160;first command of the&#160;client&#160;(e.g.&#160;<br/>LAN_SYSTEM_STATE_GETDATA,&#160;...).&#160;<br/>&#160;<br/>&#160;<br/>
<i><b>2.3&#160;</b></i><br/>
<i><b>&#160;LAN_X_GET_VERSION&#160;</b></i><br/>
&#160;<br/>The&#160;X-Bus&#160;version of the&#160;Z21&#160;can&#160;be&#160;read&#160;out&#160;with&#160;the&#160;following&#160;command.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x21&#160;</b><br/>
<b>0x21</b>&#160;<br/>
0x00&#160;<br/>
&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x09&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
0x63&#160;<br/>
0x21<b>&#160;</b><br/>
<b>XBUS_VER&#160;&#160;CMDST_ID</b>&#160;&#160;0x60&#160;<br/>
&#160;<br/><b>XBUS_VER</b>&#160;<br/>
X-Bus&#160;protocol&#160;version&#160;(0x30&#160;=&#160;V3.0,&#160;0x36&#160;=&#160;V3.6,&#160;0x40&#160;=&#160;V4.0,&#160;…&#160;)&#160;<br/>
<b>CMDST_ID</b>&#160;<br/>
Command&#160;station&#160;ID&#160;(0x12&#160;=&#160;Z21&#160;device&#160;family)&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
11/78&#160;<br/>
<hr/>
<a name=12></a><img src="docs/z21-12_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>2.4&#160;</b></i><br/>
<i><b>LAN_X_GET_STATUS&#160;</b></i><br/>
&#160;<br/>This&#160;command can&#160;be&#160;used to request the&#160;Z21&#160;status.&#160;<br/>&#160;<br/>Request&#160;to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x21&#160;</b><br/>
<b>0x24</b>&#160;<br/>
0x05&#160;<br/>
&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>see<a href="z21.html#14">&#160;<i>2.12&#160;</i>LAN_X_STATUS_CHANGED&#160;<br/></a>&#160;<br/>This&#160;command&#160;station&#160;status&#160;is&#160;identical&#160;to the CentralState,&#160;which&#160;is&#160;delivered&#160;in&#160;the&#160;system&#160;status, see&#160;<br/><a href="z21.html#18"><i>2.18&#160;</i>LAN_SYSTEMSTATE_DATACHANGED.</a>&#160;<br/>&#160;<br/>&#160;<br/>
<i><b>2.5&#160;</b></i><br/>
<i><b>LAN_X_SET_TRACK_POWER_OFF&#160;</b></i><br/>
&#160;<br/>This&#160;command switches&#160;off&#160;the track&#160;voltage.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x21&#160;</b><br/>
<b>0x80</b>&#160;<br/>
0xa1&#160;<br/>
&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>see<a href="z21.html#13">&#160;<i>2.7&#160;</i>LAN_X_BC_TRACK_POWER_OFF&#160;<br/></a>&#160;<br/>&#160;<br/>
<i><b>2.6&#160;</b></i><br/>
<i><b>LAN_X_SET_TRACK_POWER_ON&#160;</b></i><br/>
&#160;<br/>This&#160;command switches&#160;on&#160;the track&#160;voltage,&#160;or terminates&#160;either&#160;the&#160;emergency&#160;stop&#160;or&#160;the&#160;<br/>programming&#160;mode.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x21&#160;</b><br/>
<b>0x81</b>&#160;<br/>
0xa0&#160;<br/>
&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>see<a href="z21.html#13">&#160;<i>2.8&#160;</i>LAN_X_BC_TRACK_POWER_ON&#160;<br/></a>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
12/78&#160;<br/>
<hr/>
<a name=13></a><img src="docs/z21-13_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>2.7&#160;</b></i><br/>
<i><b>LAN_X_BC_TRACK_POWER_OFF&#160;</b></i><br/>
&#160;<br/>The&#160;following&#160;packet&#160;is&#160;sent from&#160;the&#160;Z21 to&#160;the&#160;registered clients&#160;when&#160;&#160;<br/>
•&#160;<br/>
a client&#160;has&#160;sent comman<a href="z21.html#12">d&#160;<i>2.5&#160;</i>LAN_X_SET_TRACK_POWER_OFF<i>.</i></a>&#160;<br/>
•&#160;<br/>
or&#160;the&#160;track&#160;voltage has&#160;been&#160;switched&#160;off&#160;by&#160;some&#160;input device&#160;(multiMaus).&#160;<br/>
•&#160;<br/>
and&#160;the&#160;relevant&#160;client&#160;has&#160;activated the corresponding broadcast,&#160;<br/>see<a href="z21.html#16">&#160;<i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;0x00000001&#160;<br/>
&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x61&#160;</b><br/>
<b>0x00</b>&#160;<br/>
0x61&#160;<br/>
&#160;<br/>
<i><b>2.8&#160;</b></i><br/>
<i><b>LAN_X_BC_TRACK_POWER_ON&#160;</b></i><br/>
&#160;<br/>The&#160;following&#160;packet&#160;is&#160;sent from&#160;the&#160;Z21 to&#160;the&#160;registered clients&#160;when&#160;&#160;<br/>
•&#160;&#160;a client&#160;has&#160;sent comman<a href="z21.html#12">d&#160;<i>2.6&#160;</i>LAN_X_SET_TRACK_POWER_ON.</a>&#160;<br/>•&#160;<br/>
or&#160;the&#160;track&#160;voltage has&#160;been&#160;switched&#160;on&#160;by&#160;some&#160;input device (multiMaus).&#160;<br/>
•&#160;<br/>
and&#160;the&#160;relevant&#160;client&#160;has&#160;activated the&#160;corresponding broadcast,&#160;<br/>see<a href="z21.html#16">&#160;<i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;0x00000001&#160;<br/>
&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x61&#160;</b><br/>
<b>0x01</b>&#160;<br/>
0x60&#160;<br/>
&#160;<br/>
<i><b>2.9&#160;</b></i><br/>
<i><b>LAN_X_BC_PROGRAMMING_MODE&#160;</b></i><br/>
&#160;<br/>The&#160;following&#160;packet&#160;is&#160;sent from the&#160;Z21 to&#160;the&#160;registered&#160;clients&#160;if the&#160;Z21 has&#160;been&#160;put&#160;into&#160;CV&#160;<br/>programming&#160;mode by<a href="z21.html#37">&#160;<i><b>6.1&#160;</b></i>LAN_X_CV_READ&#160;</a>or<a href="z21.html#37">&#160;<i><b>6.2&#160;</b></i>LAN_X_CV_WRITE<b>&#160;</b></a>and&#160;the&#160;respective client has&#160;<br/>activated the corresponding broadcast, see&#160;<br/><a href="z21.html#16"><i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;0x00000001&#160;<br/>&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x61&#160;</b><br/>
<b>0x02</b>&#160;<br/>
0x63&#160;<br/>
&#160;<br/>
<i><b>2.10&#160;&#160;LAN_X_BC_TRACK_SHORT_CIRCUIT&#160;</b></i><br/>
&#160;<br/>The&#160;following&#160;packet&#160;is&#160;sent from the&#160;Z21 to&#160;the&#160;registered clients&#160;if&#160;a short circuit&#160;has&#160;occurred&#160;and&#160;the&#160;<br/>relevant&#160;client&#160;has&#160;activated the&#160;corresponding broadcast,&#160;see&#160;<br/><a href="z21.html#16"><i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;0x00000001&#160;<br/>&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x61&#160;</b><br/>
<b>0x08</b>&#160;<br/>
0x69&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
13/78&#160;<br/>
<hr/>
<a name=14></a><img src="docs/z21-14_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>2.11&#160;&#160;LAN_X_UNKNOWN_COMMAND&#160;</b></i><br/>
&#160;<br/>The&#160;following&#160;packet&#160;is&#160;sent from the Z21 to&#160;the&#160;client&#160;in response&#160;to&#160;an&#160;invalid request.&#160;<br/>&#160;<br/>Z21&#160;to&#160;Client:&#160;&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x61&#160;</b><br/>
<b>0x82</b>&#160;<br/>
E3&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>2.12&#160;&#160;LAN_X_STATUS_CHANGED&#160;</b></i><br/>
&#160;<br/>The&#160;following&#160;packet&#160;is&#160;sent from the&#160;Z21 to&#160;the&#160;client&#160;if the client&#160;explicitly&#160;sets&#160;the status&#160;t<a href="z21.html#12">o&#160;<i>2.4&#160;<br/></i>LAN_X_GET_STATUS<i>.</i></a>&#160;<br/>&#160;<br/>Z21&#160;to&#160;Client:&#160;&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x08&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x62&#160;</b><br/>
<b>0x22&#160;</b><br/>
<b>Status</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>DB1&#160;…&#160;command&#160;station&#160;status&#160;<br/>&#160;<br/>Bitmask&#160;for&#160;command&#160;station&#160;status:&#160;<br/>#define csEmergencyStop&#160;<br/>
&#160;<br/>
0x01&#160;&#160;//&#160;The emergency stop is switched on&#160;<br/>
#define csTrackVoltageOff&#160;&#160;&#160;<br/>
0x02&#160;&#160;//&#160;The track voltage is switched off.&#160;<br/>
#define csShortCircuit&#160;<br/>
&#160;<br/>
0x04&#160;&#160;//&#160;Short-circuit&#160;<br/>
#define csProgrammingModeActive&#160;&#160;0x20&#160;&#160;//&#160;The programming mode is active&#160;<br/>&#160;<br/>This&#160;command station&#160;status&#160;is&#160;identical&#160;to the&#160;SystemState.CentralState,&#160;see&#160;&#160;<br/><a href="z21.html#18"><i>2.18&#160;</i>LAN_SYSTEMSTATE_DATACHANGED<i>.</i></a>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
14/78&#160;<br/>
<hr/>
<a name=15></a><img src="docs/z21-15_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>2.13&#160;&#160;LAN_X_SET_STOP&#160;</b></i><br/>
&#160;<br/>With this&#160;command the emergency&#160;stop&#160;is&#160;activated,&#160;i.e.&#160;the&#160;locomotives&#160;are stopped&#160;but&#160;the&#160;track&#160;<br/>voltage remains&#160;switched on.&#160;<br/>&#160;&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x06&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x80&#160;</b><br/>
0x80&#160;<br/>
&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>see<a href="z21.html#15">&#160;<i>2.14&#160;</i>LAN_X_BC_STOPPED&#160;<br/></a>&#160;<br/>&#160;<br/>
<i><b>2.14&#160;&#160;LAN_X_BC_STOPPED&#160;</b></i><br/>
&#160;<br/>The&#160;following&#160;packet&#160;is&#160;sent from the&#160;Z21 to&#160;the&#160;registered clients&#160;when&#160;&#160;<br/>
•&#160;&#160;a client&#160;has&#160;sent comman<a href="z21.html#15">d&#160;<i>2.13&#160;</i>LAN_X_SET_STOP.</a>&#160;<br/>•&#160;<br/>
or&#160;the&#160;emergency&#160;stop&#160;was&#160;triggered&#160;by&#160;some&#160;input&#160;device&#160;(multiMaus).&#160;<br/>
•&#160;<br/>
and&#160;the&#160;relevant&#160;client&#160;has&#160;activated the corresponding broadcast, see&#160;&#160;<br/><a href="z21.html#16"><i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;0x00000001&#160;<br/>
&#160;<br/>Z21&#160;to&#160;Client:&#160;&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x81&#160;</b><br/>
0x00&#160;<br/>
0x81&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>2.15&#160;&#160;LAN_X_GET_FIRMWARE_VERSION&#160;</b></i><br/>
&#160;<br/>The&#160;firmware version&#160;of&#160;the&#160;Z21 can&#160;be read&#160;with&#160;this&#160;command.&#160;<br/>&#160;<br/>Request to Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xF1&#160;</b><br/>
0x0A&#160;<br/>
0xFB&#160;<br/>
&#160;<br/>&#160;<br/>Reply&#160;from&#160;Z21:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x09&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
0xF3&#160;<br/>
0x0A<b>&#160;</b><br/>
<b>V_MSB&#160;</b><br/>
<b>V_LSB</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/><b>DB1</b>&#160;…&#160;MSB&#160;of the&#160;Firmware&#160;version<b>&#160;<br/>DB2</b>&#160;…&#160;LSB&#160;of the Firmware version<b>&#160;<br/></b>&#160;<br/>The&#160;version&#160;is&#160;specified&#160;in&#160;BCD format.&#160;<br/><b>Example</b>:&#160;<br/>0x09 0x00 0x40 0x00&#160;0xf3 0x0a&#160;<b>0x01&#160;0x23</b>&#160;0xdb&#160;…&#160;means: „Firmware&#160;Version&#160;<b>1.23</b>“&#160;<br/>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
15/78&#160;<br/>
<hr/>
<a name=16></a><img src="docs/z21-16_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>2.16&#160;&#160;LAN_SET_BROADCASTFLAGS&#160;</b></i><br/>
&#160;<br/>Set&#160;the&#160;broadcast&#160;flags&#160;in&#160;the&#160;Z21. These&#160;flags&#160;are set&#160;per&#160;client (i.e.&#160;per&#160;IP&#160;+&#160;port number)&#160;and must be&#160;<br/>set&#160;again&#160;the&#160;next time you&#160;log&#160;on.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x08&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x50</b>&#160;<br/>
0x00&#160;<br/>
32&#160;Bits&#160;Broadcast-Flags&#160;(little endian)&#160;<br/>
&#160;<br/>Broadcast&#160;flags&#160;are&#160;an&#160;OR-combination&#160;of the&#160;following values:&#160;<br/>&#160;<br/>0x00000001&#160;<br/>
Broadcasts&#160;and&#160;info&#160;messages&#160;concerning&#160;driving&#160;and&#160;switching are&#160;delivered to&#160;the&#160;<br/>registered clients&#160;automatically.&#160;<br/>The&#160;following&#160;messages&#160;are&#160;concerned:&#160;<br/><a href="z21.html#13"><i><b>2.7&#160;</b></i>LAN_X_BC_TRACK_POWER_OFF<i><b>&#160;<br/>2.8&#160;</b></i>LAN_X_BC_TRACK_POWER_ON&#160;<br/><i><b>2.9&#160;</b></i>LAN_X_BC_PROGRAMMING_MODE&#160;<br/><i><b>2.10&#160;</b></i>LAN_X_BC_TRACK_SHORT_CIRCUIT<i><b>&#160;<br/></b></i></a><a href="z21.html#15"><i><b>2.14&#160;</b></i>LAN_X_BC_STOPPED&#160;<br/></a><a href="z21.html#28"><i><b>4.4&#160;</b></i>LAN_X_LOCO_INFO&#160;</a>(loco address&#160;must&#160;be subscribed&#160;too)&#160;<br/><a href="z21.html#34"><i><b>5.3&#160;</b></i>LAN_X_TURNOUT_INFO&#160;</a><br/>
0x00000002&#160;<br/>
Changes&#160;of&#160;the&#160;feedback&#160;devices&#160;on&#160;the&#160;R-Bus&#160;are&#160;sent automatically.&#160;<br/>
&#160;<br/>
&#160;<br/>
Z21&#160;Broadcast&#160;messages&#160;see<a href="z21.html#45">&#160;<i><b>7.1&#160;</b></i>LAN_RMBUS_DATACHANGED&#160;</a><br/>
0x00000004&#160;<br/>
Changes&#160;of&#160;RailCom&#160;data&#160;of&#160;subscribed&#160;locomotives&#160;are sent&#160;automatically.&#160;<br/>Z21&#160;Broadcast&#160;messages&#160;see&#160;<b>8.1</b>&#160;LAN_RAILCOM_DATACHANGED<i>&#160;</i><br/>
0x00000100&#160;<br/>
Changes&#160;of&#160;the&#160;Z21&#160;system&#160;status&#160;are sent&#160;automatically.&#160;<br/>
&#160;&#160;<br/>
&#160;<br/>
Z21&#160;Broadcast&#160;messages&#160;see<a href="z21.html#18">&#160;<i><b>2.18&#160;</b></i>LAN_SYSTEMSTATE_DATACHANGED&#160;</a><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.20:&#160;<br/></b>0x00010000&#160;<br/>
Extends&#160;flag 0x00000001;&#160;client now gets<a href="z21.html#28">&#160;LAN_X_LOCO_INFO&#160;</a>LAN_X_LOCO_INFO&#160;<br/>without&#160;having to&#160;subscribe&#160;to&#160;the corresponding&#160;locomotive&#160;addresses, i.e. for&#160;all&#160;<br/>controlled&#160;locomotives!&#160;<br/>Due&#160;to the high&#160;network&#160;traffic, this&#160;flag&#160;may&#160;only&#160;be&#160;used&#160;by&#160;adequate&#160;PC&#160;railroad&#160;<br/>automation&#160;software&#160;and&#160;<b>is&#160;NOT&#160;intended for&#160;mobile&#160;hand&#160;controllers</b>&#160;under&#160;any&#160;<br/>circumstances.&#160;<br/>
&#160;<br/>
&#160;<br/>
From&#160;FW&#160;V1.20&#160;bis&#160;V1.23:&#160;LAN_X_LOCO_INFO&#160;is&#160;sent&#160;for&#160;<b>all</b>&#160;locomotives.&#160;<br/>
&#160;<br/>
&#160;<br/>
From&#160;<b>FW&#160;V1.24</b>:&#160;&#160; &#160;&#160;&#160; &#160;&#160; &#160;&#160;&#160;&#160;&#160; &#160;LAN_X_LOCO_INFO&#160;is&#160;sent&#160;for&#160;<b>all modified</b>&#160;locomotives.&#160;<br/>
0x01000000&#160;<br/>
Forwarding&#160;messages&#160;from&#160;LocoNet bus&#160;to LAN client&#160;without&#160;locos&#160;and&#160;switches.&#160;<br/>
0x02000000&#160;<br/>
Forwarding&#160;locomotive-specific&#160;LocoNet&#160;messages&#160;to&#160;LAN Client:&#160;<br/>
&#160;<br/>
&#160;<br/>
OPC_LOCO_SPD, OPC_LOCO_DIRF, OPC_LOCO_SND, OPC_LOCO_F912,&#160;<br/>
&#160;<br/>
&#160;<br/>
OPC_EXP_CMD&#160;<br/>
0x04000000&#160;<br/>
Forwarding&#160;switch-specific&#160;LocoNet&#160;messages&#160;to&#160;LAN&#160;client:&#160;<br/>
&#160;<br/>
&#160;<br/>
OPC_SW_REQ, OPC_SW_REP, OPC_SW_ACK, OPC_SW_STATE&#160;<br/>
See&#160;also chapt<a href="z21.html#49">er&#160;<i><b>9&#160;</b></i>LocoNet.</a>&#160;<br/>&#160;<br/><b>From&#160;Z21 FW&#160;Version&#160;1.22:&#160;<br/></b>0x08000000&#160;<br/>
Sending&#160;status&#160;changes&#160;of&#160;LocoNet&#160;track&#160;occupancy&#160;detectors&#160;to&#160;the&#160;LAN&#160;client.&#160;<br/>See<a href="z21.html#53">&#160;<b>9.5</b>&#160;LAN_LOCONET_DETECTOR&#160;</a><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.29:&#160;<br/></b>0x00040000&#160;<br/>
Sending&#160;changes&#160;of&#160;RailCom data&#160;to&#160;the&#160;LAN Client.&#160;<br/>Client&#160;gets&#160;LAN_RAILCOM_DATACHANGED&#160;without&#160;having to subscribe&#160;to the&#160;<br/>corresponding&#160;locomotive addresses, i.e.&#160;for&#160;all&#160;controlled&#160;locomotives! Due&#160;to the&#160;high&#160;<br/>network&#160;traffic, this&#160;flag&#160;may&#160;only&#160;be used&#160;by&#160;adequate&#160;PC&#160;railroad&#160;automation software&#160;<br/>and&#160;is&#160;NOT&#160;intended&#160;for&#160;mobile&#160;hand controllers&#160;under&#160;any&#160;circumstances.&#160;&#160;<br/>Z21&#160;Broadcast&#160;messages&#160;see<a href="z21.html#47">&#160;<b>8.1&#160;</b>LAN_RAILCOM_DATACHANGED<b>&#160;</b></a><br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
16/78&#160;<br/>
<hr/>
<a name=17></a><img src="docs/z21-17_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.30:&#160;<br/></b>0x00080000&#160;<br/>
Sending&#160;status&#160;changes&#160;of&#160;CAN-Bus&#160;track&#160;occupancy&#160;detectors&#160;to&#160;the&#160;LAN client.&#160;<br/>
&#160;<br/>
&#160;<br/>
See<a href="z21.html#57">&#160;<b>10.1</b>&#160;LAN_CAN_DETECTOR<i>&#160;</i></a><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.41:&#160;<br/></b>0x00020000&#160;<br/>
Forward CAN-Bus&#160;booster&#160;status&#160;messages&#160;to&#160;LAN&#160;Client.&#160;<br/>
&#160;<br/>
&#160;<br/>
See<a href="z21.html#60">&#160;<b>10.2.3</b>LAN_CAN_BOOSTER_SYSTEMSTATE_CHGD<i>&#160;</i></a><br/>
<b>&#160;<br/>From&#160;Z21&#160;FW&#160;Version&#160;1.43:&#160;<br/></b>0x00000010&#160;<br/>
Send fast clock&#160;time messages&#160;to&#160;LAN client.&#160;<br/>
&#160;<br/>
&#160;<br/>
See<a href="z21.html#73">&#160;<b>12.2</b>&#160;LAN_FAST_CLOCK_DATA&#160;</a>&#160;<br/>
&#160;<br/>Reply&#160;from&#160;Z21:&#160;&#160;<br/>none&#160;<br/>&#160;<br/><b>When&#160;preparing&#160;the settings for&#160;the broadcast flags,&#160;always&#160;consider&#160;the effects on&#160;the network&#160;<br/>load.&#160;This&#160;applies&#160;in particular&#160;to&#160;the broadcast&#160;flags 0x00010000,&#160;0x00040000, 0x02000000 and&#160;<br/>0x04000000!</b>&#160;The&#160;IP&#160;packets&#160;may&#160;be&#160;deleted by&#160;the&#160;router in case of&#160;overload&#160;and UDP&#160;does&#160;not&#160;offer&#160;<br/>any&#160;detection mechanisms&#160;for this! For example,&#160;before using&#160;flag&#160;0x00000100 (system&#160;status)&#160;it&#160;is&#160;worth&#160;<br/>considering&#160;whether&#160;0x00000001 with&#160;the&#160;corresponding&#160;LAN_X_BC_xxx&#160;broadcast messages&#160;would&#160;be&#160;<br/>a&#160;more&#160;suitable alternative.&#160;Not every&#160;application&#160;needs&#160;to&#160;be&#160;regularly&#160;informed&#160;in detail&#160;about&#160;the&#160;latest&#160;<br/>voltage,&#160;current&#160;and temperature values&#160;of&#160;the&#160;Z21.&#160;<br/>&#160;<br/>
<i><b>2.17&#160;&#160;LAN_GET_BROADCASTFLAGS&#160;</b></i><br/>
&#160;<br/>Reading&#160;the&#160;broadcast flags&#160;in the Z21.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x04&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x51</b>&#160;<br/>
0x00&#160;<br/>
-&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x08&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x51</b>&#160;<br/>
0x00&#160;<br/>
Broadcast-Flags&#160;32&#160;Bit (little endian)&#160;<br/>
&#160;<br/>Broadcast-Flags&#160;see&#160;above.&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
17/78&#160;<br/>
<hr/>
<a name=18></a><img src="docs/z21-18_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>2.18&#160;&#160;LAN_SYSTEMSTATE_DATACHANGED&#160;</b></i><br/>
&#160;<br/>Reports&#160;a change&#160;in the&#160;system&#160;status&#160;from&#160;the&#160;Z21 to&#160;the client.&#160;<br/>&#160;<br/>This&#160;message is&#160;asynchronously&#160;reported to the&#160;client&#160;by&#160;the Z21 when&#160;the&#160;client&#160;<br/>
•&#160;&#160;activated the corresponding broadcast, se<a href="z21.html#16">e&#160;<i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;<br/>
0x00000100.&#160;<br/>
•&#160;&#160;explicitly&#160;requested the system&#160;status, see<a href="z21.html#19">&#160;<i><b>2.19</b>&#160;</i>LAN_SYSTEMSTATE_GETDATA.</a>&#160;<br/>
&#160;&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x14&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x84</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>SystemState</b>&#160;(16&#160;Bytes)&#160;<br/>
&#160;<br/><b>SystemState&#160;</b>is&#160;structured&#160;as&#160;follows&#160;(the 16-bit values&#160;are&#160;little endian):&#160;<br/>
<b>Byte Offset&#160;</b><br/>
<b>Typ&#160;</b><br/>
<b>Name&#160;</b><br/>
<b>&#160;</b><br/>
<b>&#160;</b><br/>
0&#160;<br/>
INT16&#160;<br/>
MainCurrent&#160;<br/>
mA&#160;<br/>
Current on&#160;the main track&#160;<br/>
2&#160;<br/>
INT16&#160;<br/>
ProgCurrent&#160;<br/>
mA&#160;<br/>
Current on programming&#160;track&#160;<br/>
4&#160;<br/>
INT16&#160;<br/>
FilteredMainCurrent&#160;&#160;mA&#160;<br/>
smoothed&#160;current on&#160;the&#160;main&#160;track&#160;<br/>
6&#160;<br/>
INT16&#160;<br/>
Temperature&#160;<br/>
°C&#160;<br/>
command&#160;station internal&#160;temperature&#160;<br/>
8&#160;<br/>
UINT16&#160;&#160;SupplyVoltage&#160;<br/>
mV&#160;<br/>
supply&#160;voltage&#160;<br/>
10&#160;<br/>
UINT16&#160;&#160;VCCVoltage&#160;<br/>
mV&#160;<br/>
internal&#160;voltage,&#160;identical&#160;to&#160;track&#160;voltage&#160;<br/>
12&#160;<br/>
UINT8&#160;<br/>
CentralState&#160;<br/>
bitmask&#160;&#160;see&#160;below&#160;<br/>
13&#160;<br/>
UINT8&#160;<br/>
CentralStateEx&#160;<br/>
bitmask&#160;&#160;see&#160;below&#160;<br/>
14&#160;<br/>
UINT8&#160;<br/>
reserved&#160;<br/>
&#160;<br/>
&#160;<br/>
15&#160;<br/>
UINT8&#160;<br/>
Capabilities&#160;<br/>
bitmask&#160;&#160;see&#160;below,&#160;from&#160;Z21&#160;FW&#160;Version&#160;1.42&#160;<br/>
&#160;<br/>Bitmask&#160;for&#160;CentralState:&#160;<br/>#define csEmergencyStop&#160;<br/>
&#160;<br/>
0x01&#160;&#160;//&#160;The emergency stop is switched on&#160;<br/>
#define csTrackVoltageOff&#160;&#160;&#160;<br/>
0x02&#160;&#160;//&#160;The track voltage is switched off&#160;<br/>
#define csShortCircuit&#160;<br/>
&#160;<br/>
0x04&#160;&#160;//&#160;Short-circuit&#160;<br/>
#define csProgrammingModeActive&#160;&#160;0x20&#160;&#160;//&#160;The programming mode is active&#160;<br/>&#160;<br/>Bitmask&#160;for&#160;CentralStateEx:&#160;<br/>#define cseHighTemperature&#160;&#160;<br/>
0x01&#160;&#160;//&#160;temperature too&#160;high&#160;<br/>
#define csePowerLost&#160;<br/>
&#160;<br/>
0x02&#160;&#160;//&#160;Input voltage too low&#160;<br/>
#define cseShortCircuitExternal&#160;&#160;0x04&#160;&#160;//&#160;S.C.&#160;at the external booster&#160;output&#160;<br/>#define cseShortCircuitInternal&#160;&#160;0x08&#160;&#160;//&#160;S.C.&#160;at&#160;the main&#160;track&#160;or&#160;programming track&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.42:</b>&#160;<br/>#define&#160;cseRCN213&#160;&#160;&#160;<br/>
&#160;<br/>
0x20&#160;&#160;//&#160;turnout&#160;addresses&#160;according&#160;to&#160;RCN-213&#160;<br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.42:&#160;<br/></b>Bitmask&#160;for&#160;Capabilities:&#160;<br/>#define capDCC&#160;<br/>
&#160;<br/>
&#160;<br/>
0x01&#160;&#160;//&#160;capable&#160;of&#160;DCC&#160;<br/>
#define&#160;capMM&#160;<br/>
&#160;<br/>
&#160;<br/>
0x02&#160;&#160;//&#160;capable&#160;of&#160;MM&#160;<br/>
//#define&#160;capReserved&#160;<br/>
&#160;<br/>
0x04&#160;&#160;//&#160;reserved for future&#160;development&#160;<br/>
#define capRailCom&#160;&#160;&#160;<br/>
&#160;<br/>
0x08&#160;&#160;//&#160;RailCom&#160;is&#160;activated&#160;<br/>
#define capLocoCmds&#160;&#160;<br/>
&#160;<br/>
0x10&#160;&#160;//&#160;accepts&#160;LAN&#160;commands for locomotive&#160;decoders&#160;<br/>
#define capAccessoryCmds&#160;&#160;&#160;&#160;<br/>
0x20&#160;&#160;//&#160;accepts&#160;LAN&#160;commands for accessory decoders&#160;<br/>
#define capDetectorCmds&#160;&#160;&#160;&#160;<br/>
0x40&#160;&#160;//&#160;accepts LAN commands for&#160;detectors&#160;<br/>
#define capNeedsUnlockCode&#160;&#160;<br/>
0x80&#160;&#160;//&#160;device&#160;needs&#160;activate code&#160;(z21start)&#160;<br/>
SystemState.Capabilities&#160;provides&#160;an&#160;overview of&#160;the&#160;device's&#160;range of&#160;features.&#160;&#160;<br/>If SystemState.Capabilities&#160;==&#160;0,&#160;then&#160;&#160;it can&#160;be assumed&#160;that&#160;the&#160;device has&#160;an&#160;older&#160;firmware version.&#160;<br/>SystemState.Capabilities&#160;should not&#160;be evaluated&#160;when using&#160;older&#160;firmware versions!&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
18/78&#160;<br/>
<hr/>
<a name=19></a><img src="docs/z21-19_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>2.19&#160;&#160;LAN_SYSTEMSTATE_GETDATA&#160;</b></i><br/>
&#160;<br/>Request the&#160;current system&#160;status.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x04&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x85</b>&#160;<br/>
0x00&#160;<br/>
-&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>
&#160;<br/>
see&#160;abov<a href="z21.html#18">e&#160;<i><b>2.18</b>&#160;</i>LAN_SYSTEMSTATE_DATACHANGED&#160;<br/></a>&#160;<br/>
<i><b>2.20&#160;&#160;LAN_GET_HWINFO&#160;</b></i><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.20&#160;and&#160;SmartRail&#160;FW&#160;Version&#160;V1.13.&#160;&#160;<br/></b>&#160;<br/>Read&#160;the&#160;hardware&#160;type and&#160;the&#160;firmware version of&#160;the Z21.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x04&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x1A</b>&#160;<br/>
0x00&#160;<br/>
-&#160;<br/>
&#160;<br/>Reply&#160;from Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x0C&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x1A</b>&#160;<br/>
0x00&#160;<br/>
HwType&#160;32 Bit (little&#160;endian)&#160;<br/>
FW&#160;Version&#160;32&#160;Bit (little endian)&#160;<br/>
&#160;<br/><b>HwType</b>:&#160;<br/>#define D_HWT_Z21_OLD&#160;<br/>
0x00000200&#160;<br/>
//&#160;„black&#160;Z21”&#160;(hardware&#160;variant&#160;from&#160;2012)&#160;<br/>
#define&#160;D_HWT_Z21_NEW&#160;<br/>
0x00000201&#160;<br/>
// „black&#160;Z21”(hardware&#160;variant&#160;from&#160;2013)&#160;<br/>
#define D_HWT_SMARTRAIL&#160;<br/>
0x00000202&#160;<br/>
// SmartRail (from&#160;2012)&#160;<br/>
#define D_HWT_z21_SMALL&#160;<br/>
0x00000203&#160;<br/>
//&#160;„white&#160;z21”&#160;starter set variant&#160;(from&#160;2013)&#160;<br/>
#define D_HWT_z21_START&#160;<br/>
0x00000204&#160;<br/>
//&#160;„z21 start”&#160;starter&#160;set variant&#160;(from&#160;2016)&#160;<br/>
&#160;<br/>#define&#160;D_HWT_SINGLE_BOOSTER&#160;<br/>
0x00000205&#160;<br/>
//&#160;10806&#160;„Z21&#160;Single Booster”&#160;(<b>zLink</b>)&#160;<br/>
#define&#160;D_HWT_DUAL_BOOSTER&#160;&#160;<br/>
0x00000206&#160;<br/>
//&#160;10807&#160;„Z21&#160;Dual&#160;Booster”&#160;(<b>zLink</b>)&#160;<br/>
&#160;<br/>#define&#160;D_HWT_Z21_XL&#160;<br/>
0x00000211&#160;<br/>
//&#160;10870&#160;„Z21 XL&#160;Series”&#160;&#160;(from&#160;2020)&#160;<br/>
#define&#160;D_HWT_XL_BOOSTER&#160;&#160;0x00000212&#160;<br/>
//&#160;10869&#160;„Z21&#160;XL&#160;Booster”&#160;(from&#160;2021,&#160;<b>zLink</b>)&#160;<br/>
&#160;<br/>#define&#160;D_HWT_Z21_SWITCH_DECODER&#160;0x00000301&#160;<br/>
//&#160;10836&#160;„Z21&#160;SwitchDecoder”&#160;(<b>zLink</b>)&#160;<br/>
#define&#160;D_HWT_Z21_SIGNAL_DECODER&#160;0x00000302&#160;<br/>
//&#160;10836&#160;„Z21&#160;SignalDecoder”&#160;(<b>zLink</b>)&#160;<br/>
&#160;<br/>&#160;<br/>&#160;<br/>The&#160;<b>FW&#160;version</b>&#160;is&#160;specified in&#160;BCD&#160;format.&#160;<br/>&#160;<br/>Example:<b>&#160;</b><br/>
<b>0x0C 0x00&#160;0x1A 0x00&#160;0x00 0x02 0x00 0x00&#160;0x20 0x01 0x00&#160;0x00</b>&#160;<br/>means: „Hardware&#160;Type&#160;<b>0x200,</b>&#160;Firmware Version&#160;<b>1.20</b>“&#160;<br/>&#160;<br/>To read&#160;out&#160;the&#160;version&#160;of&#160;an&#160;older&#160;firmware, use the&#160;alternative command&#160;<br/><a href="z21.html#15"><i><b>2.15&#160;</b></i>LAN_X_GET_FIRMWARE_VERSION.</a>&#160;Apply&#160;following rules&#160;for&#160;older firmware versions:&#160;<br/>
•&#160;&#160;V1.10 ...&#160;Z21 (hardware variant&#160;from&#160;2012)&#160;<br/>
•&#160;&#160;V1.11 ...&#160;Z21 (hardware&#160;variant&#160;from&#160;2012)&#160;<br/>•&#160;&#160;V1.12 ...&#160;SmartRail&#160;(from&#160;2012)&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
19/78&#160;<br/>
<hr/>
<a name=20></a><img src="docs/z21-20_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>2.21&#160;&#160;LAN_GET_CODE&#160;</b></i><br/>
&#160;<br/>Read&#160;the&#160;software&#160;feature&#160;scope of the&#160;Z21&#160;(and&#160;z21&#160;or&#160;z21start&#160;of&#160;course).&#160;<br/>&#160;<br/>This&#160;command is&#160;of particular interest for&#160;the&#160;hardware&#160;variant&#160;&#34;z21&#160;start&#34;, in&#160;order&#160;to&#160;be able&#160;to&#160;check&#160;<br/>whether driving&#160;and&#160;switching&#160;via&#160;LAN&#160;is&#160;blocked&#160;or permitted.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x04&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x18</b>&#160;<br/>
0x00&#160;<br/>
-&#160;<br/>
&#160;<br/>Reply&#160;from&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x05&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x18</b>&#160;<br/>
0x00&#160;<br/>
Code&#160;(8&#160;Bit)&#160;<br/>
&#160;<br/><b>Code</b>:&#160;<br/>#define Z21_NO_LOCK &#160; &#160; &#160; &#160;0x00&#160;&#160;//&#160;all&#160;features&#160;permitted&#160;<br/>#define&#160;z21_START_LOCKED &#160; 0x01&#160;&#160;//&#160;„z21 start”:&#160;driving and switching&#160;is&#160;blocked&#160;<br/>#define&#160;z21_START_UNLOCKED 0x02 &#160;//&#160;„z21 start”:&#160;driving and switching&#160;is&#160;permitted&#160;<br/>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
20/78&#160;<br/>
<hr/>
<a name=21></a><img src="docs/z21-21_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>3&#160;&#160;Settings&#160;<br/></b>&#160;<br/>The&#160;following&#160;settings&#160;described&#160;here&#160;are stored in the&#160;Z21&#160;persistently.&#160;<br/>These settings&#160;can be&#160;reset by&#160;the&#160;user&#160;to&#160;the&#160;factory&#160;settings&#160;by&#160;keeping&#160;the&#160;STOP&#160;button&#160;on&#160;the&#160;Z21&#160;<br/>pressed&#160;until&#160;the LEDs&#160;flash violet.&#160;<br/>&#160;<br/>
<i><b>3.1&#160;</b></i><br/>
<i><b>LAN_GET_LOCOMODE&#160;</b></i><br/>
&#160;<br/>Read&#160;the&#160;output format&#160;for&#160;a given locomotive&#160;address.&#160;<br/>&#160;<br/>In&#160;the Z21,&#160;the&#160;output&#160;format&#160;(DCC,&#160;MM)&#160;is&#160;persistently&#160;stored for each locomotive&#160;address. A&#160;maximum&#160;<br/>of&#160;256 different&#160;locomotive&#160;addresses&#160;can&#160;be&#160;stored.&#160;Each address&#160;&gt;=&#160;256&#160;is&#160;DCC&#160;automatically.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x06&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x60</b>&#160;<br/>
0x00&#160;<br/>
16 bits&#160;Loco-Address&#160;(<b>big endian</b>)&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x60</b>&#160;<br/>
0x00&#160;<br/>
16&#160;bits&#160;Loco-Address&#160;(<b>big endian</b>)&#160;<br/>
Mode&#160;8 bit&#160;<br/>
&#160;<br/>Loco&#160;Address&#160;&#160;2 Bytes,&#160;<b>big&#160;endian</b>,&#160;i.e.&#160;first&#160;comes&#160;high&#160;byte,&#160;followed by&#160;low byte.&#160;<br/>&#160;<br/>Mode&#160;&#160;&#160;<br/>
0&#160;...&#160;DCC Format&#160;<br/>
&#160;<br/>
&#160;<br/>
1 ...&#160;MM&#160;Format&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>3.2&#160;</b></i><br/>
<i><b>LAN_SET_LOCOMODE&#160;</b></i><br/>
&#160;<br/>Set&#160;the&#160;output&#160;format&#160;for a&#160;given&#160;locomotive address.&#160;The&#160;format&#160;is&#160;stored&#160;in the&#160;Z21persistently.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x61</b>&#160;<br/>
0x00&#160;<br/>
Loco address&#160;16&#160;Bit (<b>big endian</b>)&#160;<br/>
Modus&#160;8 bit&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>none&#160;<br/>&#160;<br/>Meaning of&#160;the&#160;values:&#160;see&#160;above.&#160;<br/>&#160;<br/><b>Note</b>: each&#160;locomotive address&#160;&gt;=&#160;256 is&#160;and remains&#160;&#34;Format DCC&#34;&#160;automatically.&#160;<br/>&#160;<br/><b>Note:&#160;</b>the&#160;speed&#160;steps&#160;(14,&#160;28, 128)&#160;are&#160;also&#160;stored&#160;in&#160;the&#160;command&#160;station&#160;persistently. This&#160;<br/>automatically&#160;happens&#160;with&#160;the&#160;loco&#160;driving&#160;command,&#160;see<a href="z21.html#24"><b>&#160;<i>4.2&#160;</i></b>LAN_X_SET_LOCO_DRIVE.</a>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
21/78&#160;<br/>
<hr/>
<a name=22></a><img src="docs/z21-22_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>3.3&#160;</b></i><br/>
<i><b>LAN_GET_TURNOUTMODE&#160;</b></i><br/>
&#160;<br/>Read&#160;the&#160;settings&#160;for&#160;a given&#160;accessory&#160;decoder address&#160;(&#34;Accessory&#160;Decoder&#34;&#160;RP-9.2.1).&#160;<br/>&#160;<br/>In&#160;the Z21,&#160;the&#160;output&#160;format (DCC,&#160;MM)&#160;is&#160;persistently&#160;stored for each&#160;accessory&#160;decoder address. A&#160;<br/>maximum&#160;of&#160;256&#160;different&#160;accessory&#160;decoder addresses&#160;can&#160;be&#160;stored.&#160;Each&#160;address&#160;&gt;=&#160;256&#160;<br/>automatically&#160;is&#160;DCC.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x06&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x70</b>&#160;<br/>
0x00&#160;<br/>
16&#160;bits&#160;Accessory&#160;Decoder&#160;Address&#160;(<b>big endian</b>)&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x70</b>&#160;<br/>
0x00&#160;<br/>
16&#160;bits&#160;Accessory&#160;Decoder&#160;Address&#160;(<b>big endian</b>)&#160;<br/>
Mode&#160;8 bit&#160;<br/>
&#160;<br/>Accessory&#160;Decoder&#160;Address&#160;<br/>
2 Bytes,&#160;<b>big&#160;endian,</b>&#160;i.e.&#160;first&#160;comes&#160;high&#160;byte,&#160;followed by&#160;low byte.&#160;<br/>
&#160;<br/>Mode&#160;&#160;&#160;<br/>
&#160;<br/>
&#160;<br/>
0 ... DCC Format&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
1 ...&#160;MM&#160;Format<b>&#160;</b><br/>
<b>&#160;<br/></b>At&#160;the LAN&#160;interface and&#160;in&#160;the&#160;Z21,&#160;the&#160;accessory&#160;decoder addresses&#160;are&#160;addressed&#160;from&#160;0,&#160;but&#160;in the&#160;<br/>visualization&#160;in the&#160;apps&#160;or&#160;on&#160;the multiMaus&#160;from&#160;1.&#160;This&#160;is&#160;only&#160;a&#160;decision&#160;of&#160;the&#160;visualization.&#160;&#160;<br/>Example:&#160;multiMaus&#160;switch&#160;address&#160;#3, corresponds&#160;to address&#160;2&#160;on&#160;the&#160;LAN and in&#160;Z21.&#160;<br/>&#160;<br/>
<i><b>3.4&#160;</b></i><br/>
<i><b>LAN_SET_TURNOUTMODE&#160;</b></i><br/>
&#160;<br/>Set&#160;the&#160;output&#160;format&#160;for a&#160;given&#160;accessory&#160;decoder address. The format&#160;is&#160;stored in&#160;the&#160;Z21&#160;persistently.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x71</b>&#160;<br/>
0x00&#160;<br/>
16&#160;bits&#160;Accessory&#160;Decoder&#160;Address&#160;(<b>big&#160;endian</b>)&#160;<br/>
Mode&#160;8 bit&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>
&#160;<br/>
none&#160;<br/>&#160;<br/>Meaning of&#160;the&#160;values: see&#160;above.&#160;<br/>&#160;<br/>MM&#160;accessory&#160;decoders&#160;are supported&#160;by&#160;Z21&#160;firmware version&#160;1.20 and higher.&#160;<br/>MM&#160;accessory&#160;decoders&#160;are not&#160;supported&#160;by&#160;SmartRail.<b>&#160;<br/>&#160;<br/>Note:&#160;</b>Each&#160;accessory&#160;decoder&#160;&gt;=&#160;256&#160;is&#160;and&#160;remains&#160;DCC&#160;automatically.&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
22/78&#160;<br/>
<hr/>
<a name=23></a><img src="docs/z21-23_1.png"/><br/>
<img src="docs/z21-23_2.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>4&#160;&#160;Driving&#160;<br/></b>&#160;<br/>This&#160;chapter&#160;describes&#160;the&#160;messages&#160;that&#160;are required&#160;for&#160;driving&#160;with&#160;locomotive&#160;decoders.&#160;<br/>&#160;<br/>A&#160;client can subscribe to&#160;locomotive&#160;infos&#160;wit<a href="z21.html#23">h&#160;<i>4.1&#160;</i>LAN_X_GET_LOCO_INFO&#160;</a>in&#160;order&#160;to&#160;be&#160;automatically&#160;<br/>informed&#160;about&#160;changes&#160;to&#160;this&#160;locomotive&#160;address&#160;caused&#160;also&#160;by&#160;other&#160;clients&#160;or&#160;handsets.&#160;Furthermore&#160;<br/>the&#160;corresponding&#160;broadcast&#160;must also be&#160;activated&#160;for&#160;the client, see<a href="z21.html#16">&#160;<i><b>2.16&#160;<br/></b></i>LAN_SET_BROADCASTFLAGS, Fl</a>ag 0x00000001.&#160;<br/>&#160;<br/>
&#160;<br/>
<b>Figure&#160;2&#160;Example&#160;sequence:&#160;locomotive&#160;control&#160;</b><br/>
&#160;<br/>In order&#160;to&#160;keep network&#160;traffic&#160;within reasonable&#160;limits, a&#160;maximum of&#160;16&#160;locomotive addresses&#160;per client&#160;<br/>can&#160;be&#160;subscribed&#160;to&#160;(FIFO).&#160;You&#160;could also poll&#160;the locos, but&#160;always&#160;consider&#160;the network&#160;load: the&#160;IP&#160;<br/>packets&#160;may&#160;be deleted&#160;by&#160;the&#160;router in case&#160;of overload&#160;and UDP&#160;does&#160;not&#160;offer&#160;any&#160;detection&#160;<br/>mechanisms.&#160;<br/>
<i><b>4.1&#160;</b></i><br/>
<i><b>LAN_X_GET_LOCO_INFO&#160;</b></i><br/>
&#160;<br/>The&#160;following&#160;command&#160;can be&#160;used&#160;to&#160;poll&#160;the status&#160;of&#160;a&#160;locomotive.&#160;At&#160;the same time, the&#160;client&#160;also&#160;<br/>&#34;subscribes&#34;&#160;to&#160;the&#160;locomotive information&#160;for&#160;this&#160;locomotive&#160;address&#160;(only&#160;in combination&#160;with&#160;<br/><a href="z21.html#16">LAN_SET_BROADCASTFLAGS, Fl</a>ag 0x00000001).&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x09&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xE3&#160;</b><br/>
<b>0xF0&#160;</b><br/>
<b>Adr_MSB&#160;</b><br/>
<b>Adr_LSB</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;loco&#160;address&#160;=&#160;(<b>Adr_MSB</b>&#160;&amp;&#160;0x3F)&#160;&lt;&lt;&#160;8&#160;+&#160;<b>Adr_LSB</b>&#160;<br/>For locomotive addresses&#160;≥&#160;128,&#160;the&#160;two&#160;highest&#160;bits&#160;in&#160;DB1&#160;must&#160;be&#160;set&#160;to&#160;1:&#160;<br/><b>DB1</b>&#160;=&#160;(<b>0xC0</b>&#160;|&#160;<b>Adr_MSB</b>).&#160;For&#160;locomotive addresses&#160;&lt;&#160;128,&#160;these two highest bits&#160;have no&#160;meaning.&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>see<a href="z21.html#28">&#160;<i>4.4&#160;</i>LAN_X_LOCO_INFO&#160;</a><br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
23/78&#160;<br/>
<hr/>
<a name=24></a><img src="docs/z21-24_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>4.2&#160;</b></i><br/>
<i><b>LAN_X_SET_LOCO_DRIVE&#160;</b></i><br/>
&#160;<br/>Change&#160;the speed&#160;and&#160;direction&#160;of&#160;a&#160;locomotive.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0A&#160;&#160;0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xE4&#160;</b><br/>
<b>0x1S&#160;</b><br/>
<b>Adr_MSB&#160;&#160;Adr_LSB&#160;</b><br/>
<b>RVVVVVVV</b>&#160;&#160;XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;loco&#160;address&#160;=&#160;(<b>Adr_MSB</b>&#160;&amp;&#160;0x3F)&#160;&lt;&lt;&#160;8&#160;+&#160;<b>Adr_LSB</b>&#160;<br/>For&#160;locomotive addresses&#160;≥&#160;128,&#160;the&#160;two&#160;highest&#160;bits&#160;in&#160;DB1&#160;must&#160;be&#160;set&#160;to&#160;1:&#160;<br/><b>DB1</b>&#160;=&#160;(<b>0xC0</b>&#160;|&#160;<b>Adr_MSB</b>).&#160;For locomotive addresses&#160;&lt;&#160;128,&#160;these two highest bits&#160;have no&#160;meaning.&#160;<br/>&#160;<br/>&#160;<br/>0x1<b>S</b>&#160;&#160;<br/>
Number of speed steps, depending on&#160;the&#160;rail&#160;format set&#160;<br/>S=0:&#160;DCC&#160;14&#160;speed steps,&#160;or MMI&#160;with 14&#160;speed steps&#160;and F0&#160;<br/>S=2:&#160;DCC&#160;28&#160;speed&#160;steps,&#160;or MMII&#160;with 14 real&#160;speed&#160;steps&#160;and&#160;F0-F4&#160;<br/>S=3:&#160;DCC&#160;128 speed&#160;steps&#160;(aka “126&#160;speed&#160;steps”&#160;when&#160;not&#160;counting&#160;the&#160;stops),&#160;&#160;<br/>&#160; &#160; &#160; &#160; &#160;or MMII with&#160;28&#160;real&#160;speed&#160;steps&#160;(using&#160;light-trit)&#160;and F0-F4&#160;<br/>
<b>&#160;<br/>RVVVVVVV</b>&#160;<br/>
R&#160;... Direction:&#160;1=forward&#160;<br/>V&#160;...&#160;Speed:&#160;depending&#160;on the&#160;speed&#160;steps&#160;S.&#160;Coding&#160;see&#160;below.&#160;&#160;<br/>
If the&#160;format&#160;MM is&#160;configured&#160;for&#160;the&#160;locomotive,&#160;the conversion&#160;of&#160;the&#160;given&#160;DCC&#160;<br/>speed&#160;stage&#160;into the real&#160;MM speed stage takes&#160;place&#160;automatically&#160;in&#160;the&#160;Z21.&#160;<br/>
&#160;<br/>The&#160;coding&#160;of&#160;the&#160;speed&#160;is&#160;similar to&#160;NMRA&#160;S&#160;9.2 and&#160;S&#160;9.2.1.&#160;&#160;<br/>“<b>Stop</b>”&#160;means&#160;“normal&#160;stop”&#160;or “step&#160;0”.&#160;“<b>E-Stop</b>”&#160;means&#160;“immediate&#160;emergency&#160;stop”.&#160;<br/>&#160;<br/>Coding&#160;speed&#160;for&#160;“DCC&#160;14”:&#160;<br/>
<b>R000&#160;VVVV&#160;</b><br/>
<b>Speed&#160;</b><br/>
<b>R000&#160;VVVV&#160;</b><br/>
<b>Speed&#160;</b><br/>
<b>R000&#160;VVVV&#160;</b><br/>
<b>Speed&#160;</b><br/>
<b>R000&#160;VVVV&#160;</b><br/>
<b>Speed&#160;</b><br/>
R000&#160;0000&#160;<br/>
<b>Stop&#160;</b><br/>
R000&#160;0100&#160;<br/>
Step&#160;3&#160;<br/>
R000&#160;1000&#160;<br/>
Step&#160;7&#160;<br/>
R000&#160;1100&#160;<br/>
Step&#160;11&#160;<br/>
R000&#160;0001&#160;<br/>
<b>E-Stop&#160;</b><br/>
R000&#160;0101&#160;<br/>
Step&#160;4&#160;<br/>
R000&#160;1001&#160;<br/>
Step&#160;8&#160;<br/>
R000&#160;1101&#160;<br/>
Step&#160;12&#160;<br/>
R000&#160;0010&#160;<br/>
Step&#160;1&#160;<br/>
R000&#160;0110&#160;<br/>
Step&#160;5&#160;<br/>
R000&#160;1010&#160;<br/>
Step&#160;9&#160;<br/>
R000&#160;1110&#160;<br/>
Step&#160;13&#160;<br/>
R000&#160;0011&#160;<br/>
Step&#160;2&#160;<br/>
R000&#160;0111&#160;<br/>
Step&#160;6&#160;<br/>
R000&#160;1011&#160;<br/>
Step&#160;10&#160;<br/>
R000&#160;1111&#160;<br/>
Step&#160;14&#160;<b>max</b>&#160;<br/>
&#160;<br/>Coding&#160;speed&#160;for&#160;“DCC&#160;28”&#160;(like “DCC&#160;14”,&#160;but&#160;with&#160;additional&#160;intermediate&#160;speed&#160;step&#160;in&#160;the&#160;fifth&#160;bit&#160;<b>V5</b>):&#160;<br/>
<b>R00V5&#160;VVVV&#160;</b><br/>
<b>Speed&#160;</b><br/>
<b>R00V5&#160;VVVV&#160;</b><br/>
<b>Speed&#160;</b><br/>
<b>R00V5&#160;VVVV&#160;</b><br/>
<b>Speed&#160;</b><br/>
<b>R00V5&#160;VVVV&#160;</b><br/>
<b>Speed&#160;</b><br/>
R000&#160;0000&#160;<br/>
<b>Stop&#160;</b><br/>
R000&#160;0100&#160;<br/>
Step&#160;5&#160;<br/>
R000&#160;1000&#160;<br/>
Step&#160;13&#160;<br/>
R000&#160;1100&#160;<br/>
Step&#160;21&#160;<br/>
R001&#160;0000&#160;<br/>
<b>Stop1&#160;</b><br/>
R001&#160;0100&#160;<br/>
Step&#160;6&#160;<br/>
R001&#160;1000&#160;<br/>
Step&#160;14&#160;<br/>
R001&#160;1100&#160;<br/>
Step&#160;22&#160;<br/>
R000&#160;0001&#160;<br/>
<b>E-Stop&#160;</b><br/>
R000&#160;0101&#160;<br/>
Step&#160;7&#160;<br/>
R000&#160;1001&#160;<br/>
Step&#160;15&#160;<br/>
R000&#160;1101&#160;<br/>
Step&#160;23&#160;<br/>
R001&#160;0001&#160;<br/>
<b>E-Sto<a href="z21.html#24">p1&#160;</a></b><br/>
R001&#160;0101&#160;<br/>
Step&#160;8&#160;<br/>
R001&#160;1001&#160;<br/>
Step&#160;16&#160;<br/>
R001&#160;1101&#160;<br/>
Step&#160;24&#160;<br/>
R000&#160;0010&#160;<br/>
Step&#160;1&#160;<br/>
R000&#160;0110&#160;<br/>
Step&#160;9&#160;<br/>
R000&#160;1010&#160;<br/>
Step&#160;17&#160;<br/>
R000&#160;1110&#160;<br/>
Step&#160;25&#160;<br/>
R001&#160;0010&#160;<br/>
Step&#160;2&#160;<br/>
R001&#160;0110&#160;<br/>
Step&#160;10&#160;<br/>
R001&#160;1010&#160;<br/>
Step&#160;18&#160;<br/>
R001&#160;1110&#160;<br/>
Step&#160;26&#160;<br/>
R000&#160;0011&#160;<br/>
Step&#160;3&#160;<br/>
R000&#160;0111&#160;<br/>
Step&#160;11&#160;<br/>
R000&#160;1011&#160;<br/>
Step&#160;19&#160;<br/>
R000&#160;1111&#160;<br/>
Step&#160;27&#160;<br/>
R001&#160;0011&#160;<br/>
Step&#160;4&#160;<br/>
R001&#160;0111&#160;<br/>
Step&#160;12&#160;<br/>
R001&#160;1011&#160;<br/>
Step&#160;20&#160;<br/>
R001&#160;1111&#160;<br/>
Step&#160;28&#160;<b>max</b>&#160;<br/>
&#160;<br/>Coding&#160;speed&#160;for&#160;“DCC&#160;128”:&#160;<br/>
<b>RVVV&#160;VVVV&#160;</b><br/>
<b>Speed&#160;</b><br/>
R000&#160;0000&#160;<br/>
<b>Stop&#160;</b><br/>
R000&#160;0001&#160;<br/>
<b>E-Stop&#160;</b><br/>
R000&#160;0010&#160;<br/>
Step&#160;1&#160;<br/>
R000&#160;0011&#160;<br/>
Step&#160;2&#160;<br/>
R000&#160;0100&#160;<br/>
Step&#160;3&#160;<br/>
R000&#160;0101&#160;<br/>
Step&#160;4&#160;<br/>
…&#160;<br/>
…&#160;<br/>
R111&#160;1110&#160;<br/>
Step&#160;125&#160;<br/>
R111&#160;1111&#160;<br/>
Step&#160;126&#160;<b>max</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
1&#160;Usage&#160;not&#160;recommended&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
24/78&#160;<br/>
<hr/>
<a name=25></a><img src="docs/z21-25_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>No standard reply<a href="z21.html#28">,&#160;<i>4.4&#160;</i>LAN_X_LOCO_INFO&#160;</a>to subscribed clients.&#160;<br/>&#160;<br/><b>Note</b>:&#160;the&#160;number&#160;of&#160;speed&#160;steps&#160;(14/28/128)&#160;is&#160;automatically&#160;stored&#160;for the&#160;given&#160;loco&#160;address&#160;in the&#160;<br/>command&#160;station&#160;persistently.&#160;<br/>&#160;<br/>
<i><b>4.3&#160;</b></i><br/>
<i><b>Functions&#160;for&#160;locomotive&#160;decoder&#160;</b></i><br/>
&#160;<br/>Function commands&#160;from F0 up&#160;to&#160;and&#160;including&#160;F12&#160;are&#160;sent&#160;periodically&#160;(priority&#160;dependent)&#160;on the&#160;<br/>main track,&#160;just like the speed&#160;and&#160;direction.&#160;<br/>&#160;<br/>Function commands&#160;F13&#160;and&#160;above,&#160;on&#160;the&#160;other&#160;hand,&#160;are&#160;sent&#160;three&#160;times&#160;on&#160;the&#160;main&#160;track&#160;after&#160;a&#160;<br/>change&#160;and then,&#160;regarding&#160;the&#160;available&#160;bandwidth&#160;on&#160;the track&#160;and&#160;according&#160;with&#160;RCN-212,&#160;are no&#160;<br/>longer&#160;sent&#160;until&#160;the&#160;next change&#160;of&#160;the&#160;function&#160;state.&#160;<br/>&#160;<br/>
<b>4.3.1&#160;</b><br/>
<b>LAN_X_SET_LOCO_FUNCTION&#160;</b><br/>
&#160;<br/>Change&#160;a&#160;function&#160;of&#160;a&#160;locomotive.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0A&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;&#160;0xE4&#160;</b><br/>
<b>0xF8&#160;</b><br/>
<b>Adr_MSB&#160;&#160;Adr_LSB&#160;</b><br/>
<b>TTNN&#160;NNNN</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;loco&#160;address&#160;=&#160;(<b>Adr_MSB</b>&#160;&amp;&#160;0x3F)&#160;&lt;&lt;&#160;8 +&#160;<b>Adr_LSB</b>&#160;<br/>For&#160;locomotive addresses&#160;≥&#160;128,&#160;the&#160;two&#160;highest&#160;bits&#160;in&#160;DB1&#160;must&#160;be&#160;set&#160;to&#160;1:&#160;<br/><b>DB1</b>&#160;=&#160;(<b>0xC0</b>&#160;|&#160;<b>Adr_MSB</b>).&#160;For locomotive addresses&#160;&lt;&#160;128,&#160;these two highest bits&#160;have no&#160;meaning.&#160;<br/>&#160;<br/><b>TT</b>&#160;&#160;<br/>
&#160;<br/>
switch type:&#160;00=off, 01=on,&#160;10=toggle,11=not&#160;allowed&#160;<br/>
<b>NNNNNN</b>&#160;<br/>
Function index,&#160;0x00=F0 (light),&#160;0x01=F1 etc.&#160;<br/>
&#160;<br/>With Motorola&#160;MMI&#160;only&#160;F0&#160;can&#160;be&#160;switched.&#160;With MMII, F0 to&#160;F4 can&#160;be&#160;used.&#160;<br/>With DCC, F0 to F28&#160;can&#160;be switched here.&#160;<b>From&#160;Z21&#160;FW version&#160;1.42</b>&#160;the extended&#160;range from&#160;<b>F0 to&#160;<br/>F31</b>&#160;can&#160;be&#160;used&#160;here.&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>No standard reply<a href="z21.html#28">,&#160;<i>4.4&#160;</i>LAN_X_LOCO_INFO&#160;</a>to subscribed clients.&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
25/78&#160;<br/>
<hr/>
<a name=26></a><img src="docs/z21-26_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>4.3.2&#160;</b><br/>
<b>LAN_X_SET_LOCO_FUNCTION_GROUP&#160;</b><br/>
&#160;<br/>With the following&#160;command,&#160;a whole function&#160;group&#160;of a&#160;locomotive&#160;decoder can&#160;be&#160;switched. Thus, up&#160;<br/>to&#160;8 functions&#160;can&#160;be switched with&#160;a&#160;single command.&#160;<b>From Z21&#160;FW&#160;version&#160;1.42</b>, DCC functions&#160;can&#160;<br/>be&#160;switched&#160;up&#160;to F31, and&#160;with&#160;some restrictions&#160;even up&#160;to&#160;F68.&#160;<br/>&#160;<br/>The&#160;client should constantly&#160;monitor&#160;the&#160;status&#160;of&#160;all&#160;functions&#160;of&#160;the controlled&#160;locomotive&#160;to&#160;avoid&#160;<br/>accidentally&#160;switching&#160;off&#160;a&#160;function&#160;when sending&#160;this&#160;command, which&#160;may&#160;have&#160;been switched&#160;on&#160;<br/>before&#160;by&#160;another LAN client&#160;or handheld controller. For this&#160;reason, this&#160;command&#160;is&#160;more&#160;suitable&#160;for&#160;<br/>PC&#160;railroad&#160;automation&#160;software,&#160;because&#160;it&#160;&#160;should keep&#160;track&#160;of&#160;all&#160;vehicles&#160;anyway.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0A&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;&#160;0xE4&#160;</b><br/>
<b>Group&#160;</b><br/>
<b>Adr_MSB&#160;&#160;Adr_LSB&#160;</b><br/>
<b>Functions</b>&#160;&#160;XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;loco&#160;address&#160;=&#160;(<b>Adr_MSB</b>&#160;&amp;&#160;0x3F)&#160;&lt;&lt;&#160;8 +&#160;<b>Adr_LSB</b>&#160;<br/>For&#160;locomotive addresses&#160;≥&#160;128,&#160;the&#160;two&#160;highest&#160;bits&#160;in&#160;DB1&#160;must&#160;be&#160;set&#160;to&#160;1:&#160;<br/><b>DB1</b>&#160;=&#160;(<b>0xC0</b>&#160;|&#160;<b>Adr_MSB</b>).&#160;For locomotive addresses&#160;&lt;&#160;128,&#160;these two highest bits&#160;have no&#160;meaning.&#160;<br/>&#160;<br/><b>Groups</b>&#160;and&#160;<b>functions</b>&#160;are&#160;structured as&#160;follows:<b>&#160;</b><br/>
<b>Number&#160;</b><br/>
<b>Group&#160;</b><br/>
<b>Functions&#160;</b><br/>
<b>Remarks&#160;</b><br/>
<b>&#160;</b><br/>
<b>HEX&#160;</b><br/>
<b>Bit&#160;7&#160;</b><br/>
<b>Bit&#160;6&#160;</b><br/>
<b>Bit&#160;5&#160;</b><br/>
<b>Bit&#160;4&#160;</b><br/>
<b>Bit&#160;3&#160;&#160;Bit&#160;2&#160;</b><br/>
<b>Bit&#160;1&#160;</b><br/>
<b>Bit&#160;0&#160;&#160;&#160;</b><br/>
1&#160;<br/>
<b>0x20</b>&#160;<br/>
0&#160;<br/>
0&#160;<br/>
0&#160;<br/>
F0&#160;<br/>
F4&#160;<br/>
F3&#160;<br/>
F2&#160;<br/>
F1&#160;<br/>
(A)&#160;<br/>
2&#160;<br/>
<b>0x21</b>&#160;<br/>
0&#160;<br/>
0&#160;<br/>
0&#160;<br/>
0&#160;<br/>
F8&#160;<br/>
F7&#160;<br/>
F6&#160;<br/>
F5&#160;<br/>
&#160;<br/>
3&#160;<br/>
<b>0x22</b>&#160;<br/>
0&#160;<br/>
0&#160;<br/>
0&#160;<br/>
0&#160;<br/>
F12&#160;<br/>
F11&#160;<br/>
F10&#160;<br/>
F9&#160;<br/>
&#160;<br/>
4&#160;<br/>
<b>0x23</b>&#160;<br/>
F20&#160;<br/>
F19&#160;<br/>
F18&#160;<br/>
F17&#160;<br/>
F16&#160;<br/>
F15&#160;<br/>
F14&#160;<br/>
F13&#160;<br/>
(B)&#160;<br/>
5&#160;<br/>
<b>0x28</b>&#160;<br/>
F28&#160;<br/>
F27&#160;<br/>
F26&#160;<br/>
F25&#160;<br/>
F24&#160;<br/>
F23&#160;<br/>
F22&#160;<br/>
F21&#160;<br/>
(B)&#160;<br/>
6&#160;<br/>
<b>0x29</b>&#160;<br/>
F36&#160;<br/>
F35&#160;<br/>
F34&#160;<br/>
F33&#160;<br/>
F32&#160;<br/>
<b>F31&#160;</b><br/>
<b>F30&#160;</b><br/>
<b>F29&#160;</b><br/>
<b>(C)</b>&#160;(D)&#160;(E)&#160;<br/>
7&#160;<br/>
<b>0x2A</b>&#160;<br/>
F44&#160;<br/>
F43&#160;<br/>
F42&#160;<br/>
F41&#160;<br/>
F40&#160;<br/>
F39&#160;<br/>
F38&#160;<br/>
F37&#160;<br/>
(D)&#160;(E)&#160;<br/>
8&#160;<br/>
<b>0x2B</b>&#160;<br/>
F52&#160;<br/>
F51&#160;<br/>
F50&#160;<br/>
F49&#160;<br/>
F48&#160;<br/>
F47&#160;<br/>
F46&#160;<br/>
F45&#160;<br/>
(D)&#160;(E)&#160;<br/>
9&#160;<br/>
<b>0x50</b>&#160;<br/>
F60&#160;<br/>
F59&#160;<br/>
F58&#160;<br/>
F57&#160;<br/>
F56&#160;<br/>
F55&#160;<br/>
F54&#160;<br/>
F53&#160;<br/>
(D)&#160;(E)&#160;<br/>
10&#160;<br/>
<b>0x51</b>&#160;<br/>
F68&#160;<br/>
F67&#160;<br/>
F66&#160;<br/>
F65&#160;<br/>
F64&#160;<br/>
F63&#160;<br/>
F62&#160;<br/>
F61&#160;<br/>
(D)&#160;(E)&#160;<br/>
&#160;<br/><b>Remarks:&#160;<br/></b>(A)&#160;&#160;With&#160;Motorola&#160;MMI&#160;only&#160;F0&#160;can&#160;be&#160;used,&#160;with&#160;MMII&#160;F0&#160;up&#160;to&#160;F4&#160;can&#160;be&#160;used.&#160;&#160;<br/>(B)&#160;&#160;DCC F13&#160;to&#160;F28&#160;with&#160;this&#160;command&#160;only&#160;<b>from Z21&#160;FW V1.24</b>&#160;and higher.&#160;<br/>(C)&#160;&#160;DCC F29&#160;to&#160;F31&#160;<b>from Z21&#160;FW&#160;V1.42</b>,&#160;including feedback&#160;to&#160;the&#160;LAN clients, see&#160;also&#160;below.&#160;<br/>(D)&#160;&#160;DCC F32&#160;to&#160;F68&#160;<b>from Z21&#160;FW&#160;V1.42</b>, however, there&#160;is&#160;no&#160;feedback&#160;to&#160;the LAN&#160;clients.&#160;The&#160;DCC&#160;<br/>
function&#160;commands&#160;are&#160;only&#160;sent&#160;on&#160;the&#160;track.&#160;<br/>
(E)&#160;&#160;We cannot&#160;guarantee&#160;that the&#160;DCC&#160;function&#160;commands&#160;from F29&#160;and&#160;higher will&#160;actually&#160;be&#160;<br/>
understood&#160;by&#160;all&#160;decoders!&#160;Currently&#160;(2022) only&#160;very&#160;few DCC decoder&#160;types&#160;understand&#160;the&#160;<br/>function&#160;commands&#160;from&#160;F29&#160;(F29&#160;to&#160;F31 were&#160;tested&#160;successfully&#160;with &#34;Loksound 5&#34;&#160;decoder).&#160;<br/>Nowadays,&#160;some&#160;manufacturers&#160;also offer&#160;sound&#160;functions&#160;on F29, F30&#160;or F31, but&#160;they&#160;often do&#160;not&#160;<br/>work&#160;with&#160;DCC&#160;in&#160;practice,&#160;because their&#160;multi-protocol&#160;decoders&#160;do&#160;not&#160;yet&#160;understand the&#160;<br/>corresponding&#160;new&#160;DCC commands.&#160;<br/>&#160;<br/>&#160;<br/>
Reply&#160;from Z21:&#160;&#160;<br/>No standard reply,&#160;for function&#160;<b>F0 to&#160;F31</b>&#160;the&#160;feedback&#160;<a href="z21.html#28">&#160;<i>4.4&#160;</i>LAN_X_LOCO_INFO&#160;</a>is&#160;sent&#160;to&#160;subscribed&#160;<br/>clients.&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
26/78&#160;<br/>
<hr/>
<a name=27></a><img src="docs/z21-27_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>4.3.3&#160;</b><br/>
<b>LAN_X_SET_LOCO_BINARY_STATE&#160;</b><br/>
&#160;<br/><b>From Z21&#160;FW&#160;Version&#160;1.42</b>, a&#160;DCC &#34;Binary&#160;State&#34;&#160;command&#160;can&#160;be&#160;sent&#160;to a&#160;locomotive&#160;decoder&#160;with&#160;<br/>the&#160;following&#160;command.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;&#160;DB2&#160;&#160;DB3&#160;</b><br/>
<b>DB4&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0A&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;&#160;0xE5&#160;</b><br/>
<b>0x5F&#160;</b><br/>
<b>AH&#160;</b><br/>
<b>AL&#160;</b><br/>
<b>FLLL&#160;LLLL&#160;</b><br/>
<b>HHHH&#160;HHHH</b>&#160;&#160;XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;loco&#160;address&#160;=&#160;(<b>Adr_MSB</b>&#160;&amp;&#160;0x3F)&#160;&lt;&lt;&#160;8 +&#160;<b>Adr_LSB</b>&#160;<br/>For&#160;locomotive addresses&#160;≥&#160;128,&#160;the&#160;two&#160;highest&#160;bits&#160;in&#160;DB1&#160;must&#160;be&#160;set&#160;to&#160;1:&#160;<br/><b>DB1</b>&#160;=&#160;(<b>0xC0</b>&#160;|&#160;<b>Adr_MSB</b>).&#160;For locomotive addresses&#160;&lt;&#160;128,&#160;these two highest bits&#160;have no&#160;meaning.&#160;<br/>&#160;<br/><b>F&#160;</b><br/>
&#160;<br/>
The&#160;most&#160;significant&#160;bit&#160;<b>F</b>&#160;determines&#160;whether the binary&#160;state is&#160;on&#160;or&#160;off.&#160;<br/>
<b>LLLLLLL</b>&#160;<br/>
The&#160;low-order&#160;<b>seven</b>&#160;(!)&#160;bits&#160;of&#160;the&#160;binary&#160;state&#160;address.<b>&#160;</b><br/>
<b>HHHHHHHH</b>&#160;<br/>
The&#160;high&#160;eight&#160;bits&#160;of&#160;the binary&#160;state address.&#160;<br/>
&#160;<br/>Note:&#160;The&#160;following&#160;applies: the&#160;15-bit binary&#160;state address&#160;=&#160;(<b>HHHHHHHH&#160;</b>&lt;&lt;&#160;<b>7</b>)&#160;+&#160;(<b>LLLLLLL</b>&#160;&amp;&#160;0x7F)&#160;<br/>&#160;<br/>The&#160;binary&#160;states&#160;address&#160;range&#160;from&#160;29&#160;to 32767&#160;is&#160;permitted.&#160;<br/>Only&#160;binary&#160;state&#160;addresses&#160;≥&#160;29&#160;may&#160;be&#160;used for&#160;general&#160;switching&#160;functions.&#160;<br/>The&#160;binary&#160;state addresses&#160;from 1&#160;to&#160;28&#160;are&#160;reserved&#160;for special&#160;applications.&#160;<br/>Binary&#160;state&#160;address&#160;0&#160;is&#160;reserved&#160;as&#160;broadcast.&#160;<br/>&#160;<br/>Binary&#160;state&#160;addresses&#160;&lt;&#160;128&#160;(i.e.,&#160;if&#160;<b>HHHHHHHH</b>&#160;==&#160;0) are&#160;<b>automatically</b>&#160;issued on&#160;the&#160;track&#160;as&#160;DCC&#160;<br/>&#34;binary&#160;state&#160;control&#160;command&#160;<b>short&#160;form</b>&#34;&#160;according&#160;to&#160;RCN-212, from&#160;≥&#160;128&#160;as&#160;DCC &#34;binary&#160;state&#160;<br/>control&#160;command&#160;<b>long&#160;form</b>&#34;.&#160;<br/>&#160;<br/>DCC binary&#160;state control&#160;commands&#160;are&#160;sent&#160;three times&#160;on&#160;the&#160;main&#160;track, and&#160;according&#160;to RCN-212,&#160;<br/>thereafter no&#160;more&#160;repeated regularly.&#160;<br/>&#160;<br/>There is&#160;no&#160;response to the&#160;caller&#160;and no&#160;notification&#160;to&#160;other&#160;clients.&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>None.&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
27/78&#160;<br/>
<hr/>
<a name=28></a><img src="docs/z21-28_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>4.4&#160;</b></i><br/>
<i><b>LAN_X_LOCO_INFO&#160;</b></i><br/>
&#160;<br/>This&#160;message is&#160;sent&#160;from the&#160;Z21&#160;to&#160;the&#160;clients&#160;in response to the command<a href="z21.html#23">&#160;<i>4.1&#160;<br/></i>LAN_X_GET_LOCO_INFO. Howe</a>ver,&#160;it&#160;is&#160;also unsolicitedly&#160;sent&#160;to an associated&#160;client&#160;if&#160;<br/>
•&#160;<br/>
the&#160;locomotive&#160;status&#160;has&#160;been changed&#160;by&#160;one&#160;of&#160;the&#160;(other)&#160;clients&#160;or&#160;handset&#160;controls&#160;<br/>
•&#160;<br/>
and&#160;the&#160;associated&#160;client&#160;has&#160;activated the corresponding broadcast,&#160;&#160;<br/>see<a href="z21.html#16">&#160;<i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;0x00000001&#160;<br/>
•&#160;<br/>
and the&#160;associated&#160;client&#160;has&#160;subscribed&#160;to&#160;the&#160;locomotive&#160;address&#160;with<a href="z21.html#23"><i>&#160;4.1&#160;<br/></i>LAN_X_GET_LOCO_INFO.</a>&#160;<br/>
&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>...&#160;&#160;...&#160;&#160;...&#160;&#160;...&#160;&#160;...&#160;&#160;...&#160;&#160;...&#160;&#160;DB<i>n</i></b><b>&#160;&#160;XOR-Byte</b>&#160;<br/>
7 +&#160;<i><b>n</b></i>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
0xEF<b>&#160;</b><br/>
<b>Locomotive&#160;Information</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>The&#160;actual&#160;packet&#160;length&#160;<i>n</i>&#160;may&#160;vary&#160;depending on&#160;the&#160;data&#160;actually&#160;sent,&#160;with&#160;<i><b>7&#160;</b></i><i><b>&#160;n&#160;</b></i><i><b>&#160;14.&#160;<br/></b></i><b>From Z21&#160;FW&#160;version&#160;1.42&#160;</b>DataLen is&#160;≥&#160;15&#160;(<b>n&#160;≥&#160;8</b>)&#160;for&#160;also transferring&#160;the&#160;status&#160;of&#160;F29, F30&#160;and F31!<b>&#160;<br/></b>&#160;<br/>The&#160;data&#160;for locomotive&#160;information&#160;is&#160;structured&#160;as&#160;follows:<b>&#160;</b><br/>
<b>Position&#160;&#160;Data&#160;</b><br/>
<b>Meaning</b>&#160;<br/>
DB0<b>&#160;</b><br/>
<b>Adr_MSB</b>&#160;<br/>
The&#160;two&#160;highest&#160;bits&#160;in&#160;Adr_MSB&#160;must be&#160;ignored.&#160;<br/>
DB1<b>&#160;</b><br/>
<b>Adr_LSB</b>&#160;<br/>
Loco address&#160;=&#160;(<b>Adr_MSB</b>&#160;&amp;&#160;0x3F)&#160;&lt;&lt;&#160;8 +&#160;<b>Adr_LSB</b>&#160;<br/>
DB2&#160;<br/>
0000<b>BKKK&#160;</b><br/>
<b>M</b>=1&#160;…&#160;<b>From&#160;Z21 FW&#160;version&#160;1.43&#160;</b>identifies&#160;loco&#160;with&#160;MM&#160;output&#160;format&#160;<br/>&#160;<br/><b>B</b>=1&#160;...&#160;the&#160;locomotive&#160;is&#160;controlled&#160;by&#160;another X-BUS&#160;handset controller&#160;(&#34;busy&#34;)&#160;<br/><b>&#160;<br/>KKK</b>&#160;...&#160;Speed&#160;steps&#160;information: 0=14,&#160;2=28,&#160;4=128&#160;<br/>
&#160;<br/>
&#160;<br/>
0:&#160;DCC&#160;14&#160;speed steps,&#160;or&#160;MMI with&#160;14 speed&#160;steps&#160;and&#160;F0&#160;<br/>&#160;<br/>2:&#160;DCC&#160;28&#160;speed&#160;steps,&#160;or&#160;MMII with&#160;14&#160;real&#160;speed stages&#160;and F0-F4&#160;<br/>&#160;<br/><b>4</b>:&#160;DCC&#160;128&#160;speed&#160;steps,&#160;or&#160;MMII with&#160;28&#160;real&#160;speed stages&#160;(light-trit)&#160;&#160;<br/>&#160; &#160;&#160;and F0-F4&#160;<br/>
DB3<b>&#160;</b><br/>
<b>RVVVVVVV&#160;&#160;R</b>&#160;...&#160;Directon:&#160;1=forward&#160;<br/>
<b>&#160;<br/>V</b>&#160;...&#160;Speed.&#160;&#160;<br/>&#160; &#160; &#160; &#160;Coding&#160;also&#160;depends&#160;on the&#160;speed steps&#160;information&#160;KKK.&#160;&#160;<br/>&#160;&#160; &#160; &#160;&#160;See&#160;also&#160;above sectio<a href="z21.html#24">n&#160;<i>4.2&#160;</i>LAN_X_SET_LOCO_DRIVE.</a>&#160;<br/>&#160;<br/>&#160; &#160; &#160; &#160;If&#160;the&#160;format&#160;MM is&#160;configured for&#160;the&#160;locomotive,&#160;then the&#160;conversion&#160;of&#160;the&#160;<br/>&#160; &#160;&#160; &#160;&#160;real&#160;MM&#160;speed step&#160;into the&#160;presented&#160;DCC speed&#160;step&#160;has&#160;already&#160;been&#160;<br/>&#160; &#160; &#160; &#160;done&#160;in&#160;the&#160;Z21.&#160;<br/>
DB4&#160;<br/>
0<b>DSLFGHJ&#160;&#160;D</b>&#160;...&#160;double&#160;traction: 1=Loco&#160;included&#160;in a&#160;double&#160;traction<b>&#160;</b><br/>
<b>S</b>&#160;...&#160;Smartsearch<b>&#160;<br/>L</b>&#160;...&#160;F0 (Licht)<b>&#160;<br/>F</b>&#160;...&#160;F4<b>&#160;<br/>G</b>&#160;...&#160;F3<b>&#160;<br/>H</b>&#160;...&#160;F2<b>&#160;<br/>J&#160;</b>...&#160;F1&#160;<br/>
DB5&#160;<br/>
F5-F12&#160;<br/>
Function&#160;F5&#160;is&#160;bit0&#160;(LSB)&#160;<br/>
DB6&#160;<br/>
F13-F20&#160;<br/>
Function&#160;F13&#160;is&#160;bit0&#160;(LSB)&#160;<br/>
DB7&#160;<br/>
F21-F28&#160;<br/>
Function&#160;F21&#160;is&#160;bit0&#160;(LSB)&#160;<br/>
DB8&#160;<br/>
F29-F31&#160;<br/>
<b>From Z21&#160;FW&#160;version&#160;1.42</b>&#160;and if&#160;DataLen ≥ 15;&#160;Function&#160;F29 is&#160;bit0 (LSB)&#160;<br/>
DB<i><b>n</b></i>&#160;<br/>
&#160;<br/>
optional, for future extensions&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
28/78&#160;<br/>
<hr/>
<a name=29></a><img src="docs/z21-29_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>4.5&#160;</b></i><br/>
<i><b>LAN_X_SET_LOCO_E_STOP&#160;</b></i><br/>
&#160;<br/><b>From Z21&#160;FW&#160;version&#160;1.43,&#160;</b>a&#160;locomotive can&#160;be&#160;stopped with&#160;the&#160;following&#160;command. In&#160;the&#160;case&#160;of&#160;a&#160;<br/>DCC locomotive,&#160;the&#160;speed&#160;step&#160;&#34;<b>E-STOP</b>&#34;&#160;(&#34;emergency&#160;stop&#34;&#160;according&#160;to RCN-212) is&#160;then&#160;sent&#160;in&#160;the&#160;<br/>DCC speed command&#160;onto&#160;the&#160;track,&#160;i.e.,&#160;the&#160;decoder&#160;should stop&#160;the&#160;engine&#160;as&#160;quickly&#160;as&#160;possible. In&#160;<br/>the&#160;case&#160;of&#160;an MM locomotive,&#160;the&#160;speed&#160;step&#160;0 (&#34;Stop&#34;)&#160;is&#160;sent onto&#160;the track.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x08&#160;&#160;0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x92&#160;</b><br/>
<b>Adr_MSB&#160;</b><br/>
<b>Adr_LSB</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;loco&#160;address&#160;=&#160;(<b>Adr_MSB</b>&#160;&amp;&#160;0x3F)&#160;&lt;&lt;&#160;8 +&#160;<b>Adr_LSB</b>&#160;<br/>For&#160;locomotive addresses&#160;≥&#160;128,&#160;the&#160;two&#160;highest&#160;bits&#160;in&#160;DB1&#160;must&#160;be&#160;set&#160;to&#160;1:&#160;<br/><b>DB1</b>&#160;=&#160;(<b>0xC0</b>&#160;|&#160;<b>Adr_MSB</b>).&#160;For locomotive&#160;addresses&#160;&lt;&#160;128,&#160;these two highest bits&#160;have no&#160;meaning.&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>No standard reply<a href="z21.html#28">,&#160;<i>4.4&#160;</i>LAN_X_LOCO_INFO&#160;</a>to subscribed clients.&#160;<br/>&#160;<br/>
<i><b>4.6&#160;</b></i><br/>
<i><b>LAN_X_PURGE_LOCO&#160;</b></i><br/>
&#160;<br/><b>From Z21&#160;FW&#160;version&#160;1.43,&#160;</b>a&#160;locomotive can&#160;be&#160;removed&#160;from the Z21&#160;with the&#160;following&#160;command.&#160;<br/>This&#160;also&#160;cancels&#160;the sending&#160;of&#160;the&#160;loco&#160;commands&#160;for this&#160;locomotive&#160;on&#160;the&#160;track. Sending&#160;will&#160;start&#160;<br/>again as&#160;soon&#160;as&#160;a new drive or&#160;function&#160;command&#160;is&#160;sent&#160;to&#160;the&#160;same&#160;locomotive address.&#160;<br/>&#160;<br/>In&#160;this&#160;way,&#160;it is&#160;possible,&#160;for&#160;example,&#160;for a&#160;PC&#160;railroad&#160;automation&#160;software&#160;to&#160;influence the&#160;number&#160;of&#160;<br/>locomotives&#160;in the&#160;system&#160;and thus&#160;also the data&#160;throughput&#160;on the track.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x09&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xE3&#160;</b><br/>
<b>0x44&#160;</b><br/>
<b>Adr_MSB&#160;</b><br/>
<b>Adr_LSB</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;loco&#160;address&#160;=&#160;(<b>Adr_MSB</b>&#160;&amp;&#160;0x3F)&#160;&lt;&lt;&#160;8 +&#160;<b>Adr_LSB</b>&#160;<br/>For&#160;locomotive addresses&#160;≥&#160;128,&#160;the&#160;two&#160;highest&#160;bits&#160;in&#160;DB1&#160;must&#160;be&#160;set&#160;to&#160;1:&#160;<br/><b>DB1</b>&#160;=&#160;(<b>0xC0</b>&#160;|&#160;<b>Adr_MSB</b>).&#160;For locomotive addresses&#160;&lt;&#160;128,&#160;these two highest bits&#160;have no&#160;meaning.&#160;<br/>&#160;<br/>There is&#160;no&#160;response to the&#160;caller&#160;and no&#160;notification&#160;to&#160;other&#160;clients.&#160;<br/>&#160;<br/>Reply&#160;from&#160;Z21:&#160;&#160;<br/>None.&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
29/78&#160;<br/>
<hr/>
<a name=30></a><img src="docs/z21-30_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>5&#160;&#160;Switching&#160;<br/></b>This&#160;chapter deals&#160;with&#160;messages&#160;which&#160;are required&#160;for&#160;switching&#160;accessory&#160;decoders&#160;(&#34;Accessory&#160;<br/>Decoder&#34;&#160;according&#160;RP-9.2.1, e.g.&#160;decoder&#160;for turnouts,&#160;...).&#160;&#160;<br/>&#160;<br/>The&#160;visualization of&#160;the&#160;turnout number on&#160;the&#160;user interface is&#160;differently&#160;solved&#160;in&#160;some&#160;DCC systems&#160;<br/>and can&#160;significantly&#160;differ&#160;from&#160;the&#160;real&#160;DCC&#160;accessory&#160;decoder address&#160;plus&#160;port actually&#160;used in&#160;the&#160;<br/>track&#160;signal. According&#160;to&#160;DCC, there are&#160;four&#160;ports&#160;with two&#160;outputs&#160;each&#160;per&#160;accessory&#160;decoder&#160;<br/>address. One&#160;turnout&#160;can&#160;be connected&#160;per&#160;port. Usually&#160;one&#160;of the following&#160;options&#160;is&#160;used to visualize&#160;<br/>the&#160;turnout&#160;number:&#160;<br/>&#160;&#160;<br/>1.&#160;&#160;Numbering from&#160;1&#160;with&#160;DCC address&#160;at&#160;1&#160;starting&#160;with&#160;4&#160;ports&#160;each (ESU,&#160;Uhlenbrock, ...)&#160;<br/>
Switch&#160;#1:&#160;DCC-Addr=1&#160;Port=0;&#160;Switch #5:&#160;DCC-Addr=2 Port=0;&#160;Switch #6:&#160;DCC-Addr=2&#160;Port=1&#160;<br/>&#160;<br/>
2.&#160;&#160;Numbering&#160;from&#160;1&#160;with&#160;DCC address&#160;at&#160;0&#160;starting&#160;with&#160;4&#160;ports&#160;each (Roco)&#160;<br/>
Switch&#160;#1:&#160;DCC-Addr=0&#160;Port=0;&#160;Switch #5:&#160;DCC-Addr=1 Port=0;&#160;Switch #6:&#160;DCC-Addr=1&#160;Port=1&#160;<br/>&#160;<br/>
3.&#160;&#160;Virtual&#160;switch number&#160;with&#160;freely&#160;configurable DCC address&#160;and&#160;port (Twin Center)&#160;<br/>
&#160;<br/>
4.&#160;&#160;Displaying&#160;real&#160;DCC-address&#160;and&#160;port&#160;number&#160;(Zimo)&#160;<br/>
&#160;<br/>
None&#160;of&#160;these visualization&#160;options&#160;can&#160;be&#160;described&#160;as&#160;“wrong”&#160;due to&#160;lack&#160;of&#160;specification&#160;in RP-9.2.1,&#160;<br/>where the&#160;visualization&#160;to the&#160;user&#160;is&#160;not&#160;mentioned at&#160;all.&#160;For the&#160;user,&#160;however,&#160;this&#160;can&#160;mean&#160;in&#160;<br/>consequence&#160;getting&#160;used&#160;to the&#160;fact that&#160;one&#160;and&#160;the&#160;same turnout&#160;at&#160;an&#160;ESU&#160;control&#160;panel&#160;is&#160;controlled&#160;<br/>under&#160;number&#160;1, while it&#160;is&#160;switched&#160;on&#160;the&#160;Roco&#160;multiMaus&#160;and&#160;Z21 under&#160;number 5 (&#34;shift by&#160;4&#34;).&#160;<br/>&#160;<br/>In&#160;order&#160;to&#160;be able&#160;to&#160;implement&#160;the&#160;visualization&#160;of&#160;your choice&#160;in&#160;your application,&#160;it&#160;helps&#160;to&#160;know&#160;how&#160;<br/>the&#160;Z21 converts&#160;the input&#160;parameters&#160;for&#160;the&#160;switching commands&#160;(<b>FAdr_MSB</b>,&#160;<b>FAdr_LSB</b>,&#160;<b>A</b>,&#160;<b>P</b>,&#160;see&#160;<br/>below)&#160;into&#160;the&#160;corresponding&#160;DCC&#160;accessory&#160;command:&#160;<br/>&#160;<br/>DCC&#160;basic&#160;accessory&#160;decoder&#160;packet&#160;format: {preamble} 0&#160;10AAAAAA&#160;0&#160;1aaaCDDd&#160;0&#160;EEEEEEEE&#160;1&#160;<br/>&#160;<br/>
UINT16&#160;<i>FAdr</i>&#160;=&#160;(<b>FAdr_MSB</b>&#160;&lt;&lt;&#160;8) +&#160;<b>FAdr_LSB;</b>&#160;<br/>UINT16&#160;<i>Dcc_Addr</i>&#160;=&#160;<i>FAdr</i>&#160;&gt;&gt;&#160;2;&#160;<br/>&#160;<br/>aaaAAAAAA&#160;=&#160;(~<i>Dcc_Addr</i>&#160;&amp;&#160;0x1C0)&#160;|&#160;(<i>Dcc_Addr</i>&#160;&amp;&#160;0x003F);&#160;//&#160;DCC&#160;Address&#160;<br/>C =&#160;<b>A</b>;&#160;//&#160;Activate or&#160;deactivate&#160;output&#160;<br/>DD =&#160;<i>FAdr</i>&#160;&amp;&#160;0x03;&#160;//&#160;Port&#160;<br/>d&#160;=&#160;<b>P</b>;&#160;//&#160;Switch to the&#160;left&#160;or to the right&#160;<br/>
&#160;<br/>Example:&#160;<br/>FAdr=0&#160;equals&#160;DCC-Addr=0 Port=0;&#160;&#160;<br/>FAdr=3&#160;equals&#160;DCC-Addr=0 Port=3;&#160;&#160;<br/>FAdr=4&#160;equals&#160;DCC-Addr=1 Port=0;&#160;etc.&#160;<br/>&#160;<br/>On the&#160;other hand,&#160;for MM&#160;Format&#160;note:&#160;FAdr&#160;starts&#160;with&#160;0,&#160;i.e.&#160;FAdr=0:&#160;MM-Addr=1;&#160;FAdr=1:&#160;MM-<br/>Addr=2;&#160;...&#160;<br/>&#160;<br/>A&#160;client can subscribe to&#160;accessory&#160;info&#160;in order&#160;to&#160;be&#160;automatically&#160;notified&#160;of&#160;changes&#160;to&#160;accessory&#160;<br/>decoders&#160;caused by&#160;other&#160;clients&#160;or&#160;handsets. For&#160;this&#160;purpose,&#160;the&#160;corresponding broadcast must&#160;be&#160;<br/>activated for the&#160;client,&#160;see<a href="z21.html#16">&#160;<i><b>2.16&#160;</b>LAN_SET_BROADCASTFLAGS,&#160;</i></a>Flag&#160;0x00000001.&#160;<br/>&#160;<br/>The&#160;actual&#160;position of&#160;the&#160;turnout&#160;depends&#160;on&#160;the&#160;cabling&#160;and&#160;possibly&#160;also on the configuration in the&#160;<br/>client's&#160;application.&#160;The&#160;command&#160;station&#160;cannot&#160;know anything&#160;about this,&#160;and&#160;that&#160;is&#160;why&#160;the following&#160;<br/>description&#160;deliberately&#160;omits&#160;the&#160;terms&#160;&#34;<i>straight</i>&#34;&#160;and&#160;&#34;<i>branching</i>&#34;.&#160;Instead&#160;we will&#160;speak&#160;about “output&#160;1”&#160;<br/>and “output&#160;2”.<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
30/78&#160;<br/>
<hr/>
<a name=31></a><img src="docs/z21-31_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>5.1&#160;</b></i><br/>
<i><b>LAN_X_GET_TURNOUT_INFO&#160;</b></i><br/>
&#160;<br/>The&#160;following&#160;command&#160;can be&#160;used&#160;to&#160;poll&#160;the status&#160;of a&#160;turnout (or&#160;any&#160;accessory&#160;function).&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x08&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x43&#160;</b><br/>
<b>FAdr_MSB&#160;</b><br/>
<b>FAdr_LSB</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note: Function&#160;address&#160;=&#160;(<b>FAdr_MSB</b>&#160;&lt;&lt;&#160;8) +&#160;<b>FAdr_LSB</b>&#160;<br/>&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>see<a href="z21.html#34">&#160;<i>5.3&#160;</i>LAN_X_TURNOUT_INFO&#160;</a><br/>
<i><b>5.2&#160;</b></i><br/>
<i><b>LAN_X_SET_TURNOUT&#160;</b></i><br/>
&#160;<br/>A&#160;turnout&#160;(or&#160;any&#160;accessory&#160;function)&#160;can&#160;be&#160;switched&#160;with&#160;the&#160;following command.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x09&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x53&#160;</b><br/>
<b>FAdr_MSB&#160;</b><br/>
<b>FAdr_LSB</b>&#160;<br/>
10<b>Q</b>0<b>A</b>00<b>P</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note: Function&#160;address&#160;=&#160;(<b>FAdr_MSB</b>&#160;&lt;&lt;&#160;8) +&#160;<b>FAdr_LSB</b>&#160;<br/>&#160;<br/>1000<b>A</b>00<b>P&#160;</b><br/>
<b>A</b>=0 ...&#160;Deactivate turnout&#160;output&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>A</b>=1 ...&#160;Activate&#160;turnout&#160;output&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>P</b>=0 ...&#160;Select&#160;output&#160;1&#160;of&#160;the turnout&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>P</b>=1 ...&#160;Select&#160;output&#160;2&#160;of&#160;the turnout&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>Q</b>=0 …&#160;Execute command immediately&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>Q</b>=1 …&#160;<b>From&#160;Z21 FW&#160;V1.24</b>:&#160;Insert turnout&#160;command into&#160;the&#160;queue of&#160;Z21&#160;and&#160;deliver&#160;it&#160;&#160;<br/>
&#160; &#160; &#160; &#160; &#160;&#160; &#160;&#160; &#160;&#160;&#160; &#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160; &#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; &#160;&#160;<br/>
&#160; &#160; &#160; &#160; &#160;&#160;as&#160;soon&#160;as&#160;possible to the&#160;track.&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>No standard&#160;answer<a href="z21.html#34">,&#160;<i>5.3&#160;</i>LAN_X_TURNOUT_INFO&#160;</a>to&#160;subscribed clients.&#160;<br/>&#160;<br/>&#160;<br/><b>From Z21&#160;FW&#160;V1.24</b>&#160;the Q&#160;flag&#160;(&#34;Queue&#34;)&#160;was&#160;introduced.&#160;<br/>
<b>5.2.1&#160;</b><br/>
<b>LAN_X_SET_TURNOUT&#160;with&#160;Q=0&#160;</b><br/>
&#160;<br/>With&#160;<b>Q=0</b>&#160;the Z21&#160;behaves&#160;compatible to the previous&#160;versions: the&#160;turnout&#160;switching&#160;command&#160;is&#160;<br/>immediately&#160;sent&#160;on&#160;the&#160;track&#160;by&#160;being mixed&#160;into the running&#160;loco&#160;driving&#160;commands.&#160;<b>The Activate&#160;<br/>(A=1) is output&#160;until the LAN client&#160;sends the&#160;corresponding&#160;Deactivate. Only one switching&#160;<br/>command&#160;may be active&#160;at&#160;the same&#160;time</b>. This&#160;behavior&#160;corresponds, for&#160;example,&#160;to&#160;pressing and&#160;<br/>releasing&#160;the&#160;multiMaus&#160;key.&#160;<br/>&#160;<br/>Please note&#160;that&#160;with Q=0 the&#160;correct sequence&#160;of&#160;the&#160;switching commands&#160;(i.e. Activate&#160;followed by&#160;<br/>Deactivate) must&#160;be&#160;observed&#160;strictly. Otherwise, undefined end&#160;positions&#160;may&#160;occur depending&#160;on&#160;the&#160;<br/>turnout&#160;decoder&#160;used.&#160;<br/>&#160;<br/><b>The LAN client&#160;is&#160;responsible for&#160;the correct&#160;serialization&#160;and&#160;the timing&#160;of&#160;the switching&#160;duration!&#160;</b><br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
31/78&#160;<br/>
<hr/>
<a name=32></a><img src="docs/z21-32_1.png"/><br/>
<img src="docs/z21-32_2.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/><b>Wrong</b>:&#160;<br/>Activate&#160;turnout&#160;#5/A2 (4,0x89);&#160;Activate&#160;turnout&#160;#6/A2 (5,0x89);&#160;&#160;<br/>Activate&#160;turnout&#160;#3/A1 (2,0x88); Deactivate&#160;turnout&#160;#3/A1 (2,0x80);&#160;&#160;<br/>Deactivate turnout&#160;#5/A2 (4,0x81); Deactivate turnout&#160;#6/A2 (5,0x81);&#160;<br/><b>&#160;<br/>Correct</b>:&#160;<br/>Activate&#160;turnout&#160;#5/A2 (4,0x89); wait 100ms;&#160;deactivate turnout&#160;#5/A2 (4,0x81); wait&#160;50ms;&#160;<br/>Activate&#160;turnout&#160;#6/A2 (5,0x89); wait 100ms;&#160;deactivate turnout&#160;#6/A2 (5,0x81); wait&#160;50ms;&#160;<br/>Activate&#160;turnout&#160;#3/A1 (2,0x88); wait 100ms;&#160;deactivate turnout&#160;#3/A1 (2,0x80); wait&#160;50ms;&#160;<br/>&#160;<br/>Example:&#160;<br/>Activate&#160;turnout&#160;#7&#160;/&#160;A2 (6,0x89); wait&#160;150ms; deactivate&#160;turnout&#160;#7&#160;/ A2 (6,0x81)&#160;<br/>&#160;<br/>
&#160;<br/>
<b>Figure&#160;3&#160;DCC&#160;Sniff&#160;on&#160;track&#160;with&#160;Q=0&#160;</b><br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
32/78&#160;<br/>
<hr/>
<a name=33></a><img src="docs/z21-33_1.png"/><br/>
<img src="docs/z21-33_2.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/><b>5.2.2&#160;</b><br/>
<b>LAN_X_SET_TURNOUT&#160;with&#160;Q=1&#160;</b><br/>
&#160;<br/>If&#160;<b>Q=1</b>, the&#160;following&#160;behavior&#160;occurs:&#160;in&#160;the&#160;Z21&#160;the switching&#160;command&#160;is&#160;first&#160;put&#160;into&#160;an&#160;internal&#160;queue&#160;<br/>(FIFO).&#160;When&#160;generating&#160;the track&#160;signal, this&#160;queue&#160;is&#160;constantly&#160;checked&#160;whether a switching&#160;<br/>command&#160;is&#160;available&#160;for&#160;output. This&#160;switching&#160;command&#160;is&#160;then&#160;taken out&#160;of&#160;the&#160;queue&#160;and&#160;is&#160;written&#160;<br/>four times&#160;onto&#160;the&#160;track. This&#160;liberates&#160;the LAN client&#160;from&#160;the&#160;obligation of strict&#160;serialization,&#160;i.e. the&#160;<br/>switching commands&#160;may&#160;be&#160;sent&#160;mixed to&#160;the Z21&#160;with&#160;Q=1 (very&#160;useful&#160;routes!). The LAN client&#160;only&#160;<br/>needs&#160;to take&#160;care of&#160;the&#160;Deactivate timing.&#160;Depending on&#160;the&#160;DCC decoder,&#160;the&#160;Deactivate may&#160;even&#160;be&#160;<br/>omitted.&#160;With&#160;MM&#160;you should not&#160;do&#160;without&#160;Deactivate, because e.g.&#160;the&#160;k83&#160;and&#160;some&#160;older&#160;turnout&#160;<br/>decoders&#160;do not&#160;have&#160;an&#160;automatic&#160;shut-off.&#160;<br/>&#160;<br/>Example:&#160;<br/>Activate&#160;turnout&#160;#25&#160;/ A2 (24,&#160;0xA9); Activate&#160;turnout&#160;#5 /&#160;A2 (4,&#160;0xA9);&#160;<br/>Wait 150ms;&#160;&#160;<br/>Deactivate turnout&#160;#25 /&#160;A2&#160;(24, 0xA1)&#160;<br/>
&#160;<br/>
<b>Figure&#160;4&#160;DCC&#160;Sniff&#160;on&#160;track&#160;with&#160;Q=1&#160;</b><br/>
&#160;<br/>&#160;<br/>Never mix&#160;switching&#160;commands&#160;with&#160;Q=0&#160;and switching commands&#160;with&#160;Q=1&#160;in&#160;your&#160;application.&#160;&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
33/78&#160;<br/>
<hr/>
<a name=34></a><img src="docs/z21-34_1.png"/><br/>
<img src="docs/z21-34_2.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>5.3&#160;</b></i><br/>
<i><b>LAN_X_TURNOUT_INFO&#160;</b></i><br/>
&#160;<br/>This&#160;message is&#160;sent&#160;from the&#160;Z21&#160;to&#160;the&#160;clients&#160;in response&#160;to the command&#160;&#160;<br/><a href="z21.html#31"><i>5.1&#160;</i>LAN_X_GET_TURNOUT_INFO<i>.&#160;</i></a>However, it is&#160;also sent to&#160;an&#160;associated&#160;client&#160;unsolicitedly&#160;if&#160;<br/>
•&#160;<br/>
the&#160;function&#160;status&#160;has&#160;been changed&#160;by&#160;one of&#160;the&#160;(other)&#160;clients&#160;or&#160;a&#160;handset&#160;controller&#160;&#160;<br/>
•&#160;<br/>
and the&#160;associated&#160;client&#160;has&#160;activated the corresponding broadcast,&#160;&#160;<br/>see<a href="z21.html#16"><i><b>&#160;2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;0x00000001&#160;<br/>
&#160;<br/>&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x09&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x43&#160;</b><br/>
<b>FAdr_MSB&#160;</b><br/>
<b>FAdr_LSB</b>&#160;<br/>
000000<b>ZZ</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note: Function&#160;address&#160;=&#160;(<b>FAdr_MSB</b>&#160;&lt;&lt;&#160;8) +&#160;<b>FAdr_LSB</b>&#160;<br/>&#160;<br/>000000<b>ZZ&#160;</b><br/>
<b>ZZ</b>=00&#160;...&#160;Turnout&#160;not switched yet&#160;<br/><b>ZZ</b>=01&#160;...&#160;Turnout&#160;is&#160;in position&#160;according to&#160;switching&#160;command &#34;P=0&#34;, see<a href="z21.html#31">&#160;<i>5.2&#160;</i></a><i>&#160;<br/>&#160; &#160; &#160; &#160; &#160;<a href="z21.html#31">&#160; &#160; &#160; &#160;</i>LAN_X_SET_TURNOUT&#160;</a><br/>
&#160;<br/>
&#160;<br/>
<b>ZZ</b>=10&#160;...&#160;Turnout&#160;is&#160;in position&#160;according to&#160;switching&#160;command &#34;P=1&#34;, see<a href="z21.html#31">&#160;<i>5.2&#160;</i></a><i>&#160;<br/>&#160; &#160; &#160; &#160; &#160;<a href="z21.html#31">&#160; &#160; &#160; &#160;</i>LAN_X_SET_TURNOUT&#160;</a><br/>
&#160;<br/>
&#160;<br/>
<b>ZZ</b>=11&#160;...&#160;Invalid combination&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>Figure&#160;5&#160;Example&#160;Sequence:&#160;Turnout&#160;switching&#160;</b><br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
34/78&#160;<br/>
<hr/>
<a name=35></a><img src="docs/z21-35_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>5.4&#160;</b></i><br/>
<i><b>LAN_X_SET_EXT_ACCESSORY&#160;</b></i><br/>
&#160;<br/><b>From Z21&#160;FW&#160;V1.&#160;40,</b>&#160;&#160;a DCC command&#160;in&#160;the&#160;&#34;<b>extended&#160;accessory&#160;decoder&#160;package format</b>&#34;&#160;<br/>(DCCext)&#160;can&#160;be&#160;sent&#160;to&#160;an&#160;<b>extended&#160;accessory decoder</b>&#160;with&#160;the&#160;following&#160;request.&#160;It&#160;allows&#160;to send&#160;<br/>even&#160;switching times&#160;for&#160;turnouts&#160;or&#160;complex&#160;signal&#160;aspects&#160;with&#160;just&#160;one&#160;single&#160;command.&#160;See&#160;also&#160;<br/>RCN-213&#160;&#160;(Section&#160;2.3).&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0A&#160;&#160;0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x54&#160;</b><br/>
<b>Adr_MSB&#160;&#160;Adr_LSB</b>&#160;<br/>
DDDDDDDD&#160;<br/>
0x00&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;<b>RawAddress</b>&#160;=&#160;(<b>Adr_MSB</b>&#160;&lt;&lt;&#160;8) +&#160;<b>Adr_LSB&#160;<br/>&#160;<br/>RawAddress&#160;&#160;</b>The&#160;RawAddress&#160;for&#160;the first extended&#160;accessory&#160;decoder is&#160;4 according&#160;to RCN-213.&#160;<br/>
This&#160;address&#160;is&#160;usually&#160;displayed&#160;as&#160;&#34;Address&#160;1&#34;&#160;in user&#160;interfaces. The&#160;address&#160;<br/>calculation&#160;is&#160;strictly&#160;compliant&#160;with&#160;RCN-213,&#160;i.e.&#160;there is&#160;no longer&#160;any&#160;different&#160;address&#160;<br/>calculation&#160;compared with&#160;other&#160;compliant&#160;systems.&#160;<br/>
&#160;<br/><b>DDDDDDDD&#160;</b><br/>
256&#160;different&#160;states&#160;can&#160;be&#160;transmitted via bits&#160;0&#160;to&#160;7&#160;in&#160;DB2.&#160;&#160;<br/>The&#160;content&#160;is&#160;transferred to the&#160;decoder&#160;on the track&#160;in the&#160;<i><b>extended&#160;accessory&#160;<br/>decoder&#160;package format</b></i>&#160;according&#160;to&#160;RCN-213.&#160;<br/>&#160;<br/><b>Note</b>:&#160;&#160;<br/>Ter&#160;&#160;<b>10836&#160;Z21&#160;switch&#160;DECODER</b>&#160;&#160;interprets&#160;DDDDDDDD&#160;as&#160;&#34;switch&#160;decoder&#160;with&#160;reception&#160;of&#160;switching&#160;time&#34;&#160;<br/>as&#160;&#160;<b>RZZZZZZZ</b>.&#160;The&#160;following&#160;applies:&#160;<br/>
•&#160;<br/>
<b>ZZZZZZZ</b>&#160;defines&#160;the&#160;power-on time&#160;with&#160;a resolution&#160;of&#160;<b>100&#160;ms.</b>&#160;<br/>
o&#160;<br/>
A&#160;value&#160;of&#160;0&#160;means&#160;that&#160;the&#160;output&#160;is&#160;switched&#160;off.&#160;&#160;<br/>
o&#160;<br/>
a&#160;value&#160;of&#160;127&#160;means&#160;that&#160;the&#160;output&#160;is&#160;switched&#160;on&#160;permanently,&#160;i.e.&#160;until&#160;the&#160;next&#160;<br/>
command&#160;to&#160;this&#160;address.&#160;<br/>
•&#160;<br/>
Bit&#160;7&#160;<b>R</b>&#160;&#160;is&#160;used&#160;to&#160;select&#160;the&#160;output&#160;within&#160;the&#160;output&#160;pair:&#160;&#160;<br/>
o&#160;<br/>
&#160;R=1&#160;means&#160;&#34;green&#34;&#160;(straight).&#160;&#160;<br/>
o&#160;<br/>
R=0&#160;means&#160;&#34;red&#34;&#160;(branched).&#160;<br/>
&#160;<br/>
The<b>&#160;10837</b>&#160;<b>&#160;Z21&#160;</b>&#160;<b>signaldecoder</b>&#160;&#160;interprets&#160;DDDDDDDDD&#160;as&#160;one&#160;of&#160;256&#160;theoretically&#160;possible&#160;signal&#160;<br/>aspects.&#160;The&#160;actual&#160;value&#160;range&#160;depends&#160;to&#160;a&#160;large&#160;extent&#160;on&#160;the&#160;signal&#160;type&#160;set&#160;in&#160;the&#160;signal&#160;decoder.&#160;Common&#160;&#160;<br/>values&#160;are,&#160;for&#160;example:&#160;<br/>
•&#160;<br/>
0&#160;...&#160;Stop&#160;<br/>
•&#160;<br/>
4&#160;...&#160;Clear&#160;with&#160;speed&#160;limit&#160;max&#160;40&#160;km/h&#160;<br/>
•&#160;<br/>
16&#160;...&#160;Clear&#160;<br/>
•&#160;<br/>
65&#160;(0x41)&#160;...&#160;shunting&#160;allowed&#160;<br/>
•&#160;<br/>
66&#160;(0x42)&#160;...&#160;turn&#160;all&#160;lights&#160;off&#160;(e.g.&#160;for&#160;distant&#160;signals)&#160;<br/>
•&#160;<br/>
69&#160;(0x45)&#160;...&#160;substitution&#160;(permission&#160;to&#160;pass&#160;a&#160;defect&#160;signal)&#160;<br/>
The&#160;suitable&#160;value&#160;for&#160;the&#160;desired&#160;signal&#160;aspect&#160;for&#160;a&#160;given&#160;signal&#160;can&#160;be&#160;found&#160;for&#160;the&#160;Z21&#160;signal&#160;DECODER&#160;<br/>u<a href="https://www.z21.eu/en/products/z21-signal-decoder/signaltypen">nder&#160;https://www.z21.eu/en/products/z21-signal-decoder/signaltypen.</a>&#160;<br/>&#160;<br/>
Reply&#160;from Z21:&#160;&#160;<br/>No standard&#160;answer,&#160;or<a href="z21.html#36">&#160;<i>5.6&#160;LAN_X_EXT_ACCESSORY_INFO</i>&#160;</a>to subscribed&#160;clients.&#160;<br/>&#160;<br/>Example:<b>&#160;</b><br/>
<b>0x0A 0x00 0x40 0x00 0x54&#160;0x00&#160;0x04&#160;0x05&#160;0x00&#160;0x55&#160;</b>&#160;<br/>meaning:&#160;&#34;send&#160;to&#160;decoder with&#160;RawAddress=4&#160;&#160;(this&#160;address&#160;is&#160;displayed as&#160;address&#160;1&#160;in&#160;user dialogs!)&#160;<br/>a&#160;value&#160;of&#160;DDDDDDDD=5.&#34;&#160;<br/>If the receiver&#160;is&#160;a 10836 Z21&#160;switch&#160;DECODER,&#160;then&#160;the&#160;output&#160;&#160;1&#160;&#34;red&#34;&#160;&#160;(clamp&#160;1A)&#160;will&#160;be&#160;switched on&#160;<br/>and&#160;switched&#160;off&#160;again&#160;after&#160;5*100ms&#160;automatically.&#160;<br/>&#160;<br/>
&#160;<br/>
With this&#160;command,&#160;it is&#160;also possible&#160;to&#160;send the &#34;emergency&#160;stop&#160;command&#160;for&#160;extended&#160;accessory&#160;<br/>decoders&#34;&#160;according&#160;to RCN-213&#160;(Section&#160;2.4). This&#160;corresponds&#160;to the value&#160;0&#160;(&#34;Stop&#34;)&#160;for&#160;the&#160;<br/>RawAddress=2047:&#160;<br/>
<b>0x0A 0x00 0x40 0x00 0x54&#160;0x07&#160;0xFF&#160;0x00&#160;0x00&#160;0xAC&#160;</b>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
35/78&#160;<br/>
<hr/>
<a name=36></a><img src="docs/z21-36_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>
<i><b>5.5&#160;</b></i><br/>
<i><b>LAN_X_GET_EXT_ACCESSORY_INFO&#160;</b></i><br/>
&#160;<br/><b>From Z21&#160;FW&#160;V1.&#160;40,</b>&#160;the&#160;following&#160;request&#160;can be used&#160;to&#160;poll&#160;the&#160;last command&#160;transferred&#160;to an&#160;<br/><b>extended&#160;accessory decoder</b>.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x09&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x44&#160;</b><br/>
<b>Adr_MSB&#160;</b><br/>
<b>Adr_LSB</b>&#160;<br/>
0x00&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;<b>RawAddress</b>&#160;=&#160;(<b>Adr_MSB</b>&#160;&lt;&lt;&#160;8)&#160;+&#160;<b>Adr_LSB&#160;<br/></b>&#160;<br/><b>RawAddress</b>&#160;&#160;&#160;The&#160;address&#160;of&#160;the&#160;accessory&#160;decoder&#160;according to&#160;RCN-213.&#160;&#160;<br/>
See&#160;section<a href="z21.html#35">&#160;<i>5.4&#160;</i>LAN_X_SET_EXT_ACCESSORY&#160;</a><br/>
&#160;<br/><b>DB2</b>&#160;&#160;<br/>
&#160;<br/>
Reserved&#160;for&#160;future&#160;extensions, should remain&#160;initialized&#160;with&#160;0&#160;until&#160;further&#160;notice.&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>see<a href="z21.html#36">&#160;<i>5.6</i>LAN_X_EXT_ACCESSORY_INFO<i>&#160;</i></a><i>&#160;<br/></i>&#160;<br/>
<i><b>5.6&#160;</b></i><br/>
<i><b>LAN_X_EXT_ACCESSORY_INFO&#160;</b></i><br/>
&#160;<br/>This&#160;message is&#160;sent&#160;from the&#160;Z21&#160;to&#160;the&#160;clients&#160;in response to command&#160;&#160;<br/><a href="z21.html#36"><i>5.5&#160;LAN_X_GET_EXT_ACCESSORY_INFO</i>.&#160;</a>&#160;<br/>However,&#160;it is&#160;also sent&#160;to&#160;an associated&#160;client&#160;unsolicitedly&#160;if&#160;<br/>
•&#160;<br/>
the&#160;accessory&#160;status&#160;has&#160;been changed&#160;by&#160;one&#160;of&#160;the&#160;(other)&#160;clients&#160;or&#160;a&#160;handset&#160;controller&#160;&#160;<br/>
•&#160;<br/>
and the&#160;associated&#160;client&#160;has&#160;activated&#160;the corresponding broadcast,&#160;&#160;<br/>see<a href="z21.html#16"><i><b>&#160;2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;0x00000001&#160;<br/>
&#160;<br/>Z21&#160;to&#160;Client:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0A&#160;&#160;0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x44&#160;</b><br/>
<b>Adr_MSB&#160;&#160;Adr_LSB</b>&#160;<br/>
<b>DDDDDDDD&#160;</b><br/>
<b>Status&#160;</b><br/>
XOR-Byte&#160;<br/>
<b>&#160;<br/></b>Note:&#160;<b>RawAddress</b>&#160;=&#160;(<b>Adr_MSB</b>&#160;&lt;&lt;&#160;8) +&#160;<b>Adr_LSB&#160;<br/></b>&#160;<br/><b>RawAddress</b>&#160;&#160;&#160;The address&#160;of&#160;the&#160;accessory&#160;decoder&#160;according to&#160;RCN-213.&#160;&#160;<br/>
See&#160;section<a href="z21.html#35">&#160;<i>5.4</i>LAN_X_SET_EXT_ACCESSORY&#160;</a><br/>
&#160;<br/><b>DDDDDDDD&#160;</b><br/>
Up to&#160;256&#160;possible states&#160;encoded&#160;in&#160;<i><b>extended accessory&#160;decoder&#160;package&#160;format</b></i>&#160;<br/>according&#160;to&#160;RCN-213.&#160;&#160;<br/>See&#160;section<a href="z21.html#35">&#160;<i>5.4&#160;</i>LAN_X_SET_EXT_ACCESSORY.</a><i><b>&#160;</b></i><br/>
&#160;<br/><b>Status</b>&#160;&#160;&#160;<br/>
0x00&#160;…&#160;&#160;Data Valid&#160;<br/>
&#160;<br/>
&#160;<br/>
0xFF&#160;…&#160;Data Unknown&#160;<br/>
&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
36/78&#160;<br/>
<hr/>
<a name=37></a><img src="docs/z21-37_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>6&#160;&#160;Reading&#160;and&#160;writing&#160;Decoder CVs&#160;<br/></b>&#160;<br/>This&#160;chapter deals&#160;with&#160;messages&#160;required for reading&#160;and&#160;writing&#160;decoder CVs&#160;(Configuration Variable,&#160;<br/>RP-9.2.2,&#160;RP-9.2.3).&#160;<br/>&#160;<br/>Whether&#160;the&#160;decoder&#160;is&#160;accessed&#160;bit-wise&#160;or byte-wise&#160;depends&#160;on the settings&#160;in&#160;the&#160;Z21.&#160;<br/>&#160;<br/>
<i><b>6.1&#160;</b></i><br/>
<i><b>LAN_X_CV_READ&#160;</b></i><br/>
&#160;<br/>Read&#160;a CV&#160;in direct mode.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x09&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x23&#160;</b><br/>
<b>0x11&#160;</b><br/>
<b>CVAdr_MSB&#160;&#160;CVAdr_LSB</b>&#160;&#160;XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;CV&#160;Address&#160;=&#160;(<b>CVAdr_MSB</b>&#160;&lt;&lt;&#160;8) +&#160;<b>CVAdr_LSB</b>,&#160;where&#160;0=CV1, 1=CV2,&#160;255=CV256,&#160;etc.&#160;<br/>&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/><a href="z21.html#13"><i>2.9&#160;</i>LAN_X_BC_PROGRAMMING_MODE&#160;</a>to&#160;subscribed&#160;clients,&#160;as&#160;well&#160;as&#160;the result&#160;<br/><a href="z21.html#37"><i>6.3&#160;</i>LAN_X_CV_NACK_SC<i>,&#160;</i></a><a href="z21.html#38"><i>6.4&#160;</i>LAN_X_CV_NACK<i>&#160;</i>or&#160;<i>6.5&#160;</i>LAN_X_CV_RESULT<i>.</i></a>&#160;<br/>&#160;<br/>&#160;<br/>
&#160;<br/>
<i><b>6.2&#160;</b></i><br/>
<i><b>LAN_X_CV_WRITE&#160;</b></i><br/>
&#160;<br/>Write&#160;a&#160;CV&#160;in direct mode.&#160;<br/>&#160;<br/>Request&#160;to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;&#160;DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0A&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x24&#160;</b><br/>
<b>0x12&#160;</b><br/>
<b>CVAdr_MSB&#160;&#160;CVAdr_LSB&#160;</b><br/>
<b>Value</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;CV-Address&#160;=&#160;(<b>CVAdr_MSB</b>&#160;&lt;&lt;&#160;8) +&#160;<b>CVAdr_LSB</b>,&#160;where&#160;0=CV1,&#160;1=CV2,&#160;255=CV256,&#160;etc.&#160;<br/>&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/><a href="z21.html#13"><i>2.9&#160;</i>LAN_X_BC_PROGRAMMING_MODE&#160;</a>to&#160;subscribed&#160;clients,&#160;as&#160;well&#160;as&#160;the&#160;result&#160;<br/><a href="z21.html#37"><i>6.3&#160;</i>LAN_X_CV_NACK_SC<i>,&#160;</i></a><a href="z21.html#38"><i>6.4&#160;</i>LAN_X_CV_NACK<i>&#160;</i>or&#160;<i>6.5&#160;</i>LAN_X_CV_RESULT<i>.</i></a>&#160;<br/>&#160;<br/>&#160;<br/>
<i><b>6.3&#160;</b></i><br/>
<i><b>LAN_X_CV_NACK_SC&#160;</b></i><br/>
&#160;<br/>If the&#160;programming&#160;failed&#160;due&#160;to&#160;a&#160;short&#160;circuit&#160;on&#160;the&#160;track, this&#160;message is&#160;automatically&#160;sent&#160;to&#160;the&#160;<br/>client that&#160;initiated&#160;the&#160;programming&#160;by<a href="z21.html#37">&#160;<i>6.1&#160;</i>LAN_X_CV_READ&#160;</a>or<a href="z21.html#37">&#160;<i>6.2&#160;</i>LAN_X_CV_WRITE.</a>&#160;<br/>&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x61&#160;</b><br/>
<b>0x12</b>&#160;<br/>
0x73&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
37/78&#160;<br/>
<hr/>
<a name=38></a><img src="docs/z21-38_1.png"/><br/>
<img src="docs/z21-38_2.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>6.4&#160;</b></i><br/>
<i><b>LAN_X_CV_NACK&#160;</b></i><br/>
&#160;<br/>If the&#160;ACK&#160;is&#160;missing from the&#160;decoder, this&#160;message&#160;is&#160;automatically&#160;sent to the&#160;client that&#160;initiated&#160;the&#160;<br/>programming&#160;by<a href="z21.html#37">&#160;<i>6.1&#160;</i>LAN_X_CV_READ&#160;</a>or<a href="z21.html#37">&#160;<i>6.2&#160;</i>LAN_X_CV_WRITE.</a>&#160;<br/>When reading&#160;with&#160;byte-wise access, the time until&#160;<i>LAN_X_CV_NACK</i>&#160;can be very&#160;long.&#160;<br/>&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x61&#160;</b><br/>
<b>0x13</b>&#160;<br/>
0x72&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>6.5&#160;</b></i><br/>
<i><b>LAN_X_CV_RESULT&#160;</b></i><br/>
&#160;<br/>This&#160;message is&#160;also&#160;a &#34;positive&#160;ACK&#34;&#160;and&#160;is&#160;automatically&#160;sent&#160;to&#160;the&#160;client&#160;that&#160;initiated the&#160;<br/>programming&#160;by<a href="z21.html#37">&#160;<i>6.1&#160;</i>LAN_X_CV_READ&#160;</a>or<a href="z21.html#37">&#160;<i>6.2&#160;</i>LAN_X_CV_WRITE.&#160;</a>&#160;<br/>When reading&#160;with&#160;byte-wise access, the time until&#160;<i>LAN_X_CV_RESULT&#160;</i>can&#160;be&#160;very&#160;long.&#160;<br/>&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;&#160;DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0A&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x64&#160;</b><br/>
<b>0x14&#160;</b><br/>
<b>CVAdr_MSB&#160;&#160;CVAdr_LSB&#160;</b><br/>
<b>Value</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;CV&#160;Address&#160;=&#160;(<b>CVAdr_MSB</b>&#160;&lt;&lt;&#160;8) +&#160;<b>CVAdr_LSB</b>,&#160;where&#160;0=CV1,&#160;1=CV2,&#160;255=CV256,&#160;etc.&#160;<br/>&#160;<br/>
&#160;<br/>
<b>Figure&#160;6&#160;Example&#160;Sequence:&#160;CV&#160;Reading&#160;</b><br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
38/78&#160;<br/>
<hr/>
<a name=39></a><img src="docs/z21-39_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>6.6&#160;</b></i><br/>
<i><b>LAN_X_CV_POM_WRITE_BYTE&#160;</b></i><br/>
&#160;<br/>With the following&#160;command a&#160;CV&#160;of&#160;a&#160;locomotive&#160;decoder (“Multi&#160;Function&#160;Digital&#160;Decoders”&#160;according&#160;to&#160;<br/>NMRA&#160;S-9.2.1&#160;Section&#160;C;&#160;Configuration Variable Access&#160;Instruction&#160;-&#160;Long Form)&#160;can&#160;be&#160;written on the&#160;<br/>main track&#160;(POM &#34;Programming on&#160;the&#160;Main&#34;). This&#160;is&#160;done&#160;in&#160;normal&#160;operating&#160;mode,&#160;i.e. the track&#160;<br/>voltage must be&#160;already&#160;switched&#160;on&#160;and&#160;the&#160;service&#160;mode&#160;is&#160;not&#160;activated. There&#160;is&#160;no&#160;feedback.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;&#160;DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>DB4&#160;</b><br/>
<b>DB5&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0C&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xE6&#160;</b><br/>
<b>0x30&#160;</b><br/>
<b>POM-Parameter</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>The&#160;data&#160;for&#160;<b>POM&#160;parameters</b>&#160;is&#160;structured&#160;as&#160;follows:<b>&#160;</b><br/>
<b>Position&#160;</b><br/>
<b>Data&#160;</b><br/>
<b>Meaning</b>&#160;<br/>
DB1<b>&#160;</b><br/>
<b>Adr_MSB</b>&#160;<br/>
&#160;<br/>
DB2<b>&#160;</b><br/>
<b>Adr_LSB</b>&#160;<br/>
Loco Address&#160;=&#160;(<b>Adr_MSB</b>&#160;&amp;&#160;0x3F)&#160;&lt;&lt;&#160;8&#160;+&#160;<b>Adr_LSB</b>&#160;<br/>
DB3<b>&#160;</b><br/>
<b>111011MM&#160;</b><br/>
<b>Option</b>&#160;...&#160;<b>0xEC&#160;<br/>MM</b>&#160;...&#160;CVAdr_MSB&#160;<br/>
DB4<b>&#160;</b><br/>
<b>CVAdr_LSB</b>&#160;<br/>
CV&#160;Address&#160;=&#160;(<b>MM</b>&#160;&lt;&lt;&#160;8) +&#160;<b>CVAdr_LSB</b>&#160;<br/>(0=CV1.,&#160;1=CV2, 255=CV256, etc.)&#160;<br/>
DB5<b>&#160;</b><br/>
<b>Value</b>&#160;<br/>
New CV&#160;Value&#160;<br/>
&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>none&#160;<br/>&#160;<br/>
<i><b>6.7&#160;</b></i><br/>
<i><b>LAN_X_CV_POM_WRITE_BIT&#160;</b></i><br/>
&#160;<br/>With the following&#160;command one bit&#160;of&#160;a&#160;CV&#160;of&#160;a&#160;locomotive&#160;decoder&#160;(“Multi&#160;Function&#160;Digital&#160;Decoders”&#160;<br/>according&#160;to&#160;NMRA&#160;S-9.2.1&#160;Section&#160;C; Configuration Variable&#160;Access&#160;Instruction&#160;-&#160;Long Form) can&#160;be&#160;<br/>written&#160;on&#160;the&#160;main track&#160;(POM). This&#160;is&#160;done in normal&#160;operating&#160;mode,&#160;i.e.&#160;the&#160;track&#160;voltage must be&#160;<br/>already&#160;switched on&#160;and the&#160;service&#160;mode&#160;is&#160;not&#160;activated.&#160;There&#160;is&#160;no&#160;feedback.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;&#160;DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>DB4&#160;</b><br/>
<b>DB5&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0C&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xE6&#160;</b><br/>
<b>0x30&#160;</b><br/>
<b>POM-Parameter</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>The&#160;data&#160;for&#160;<b>POM&#160;parameters</b>&#160;is&#160;structured&#160;as&#160;follows:<b>&#160;</b><br/>
<b>Position&#160;</b><br/>
<b>Data&#160;</b><br/>
<b>Meaning</b>&#160;<br/>
DB1<b>&#160;</b><br/>
<b>Adr_MSB</b>&#160;<br/>
&#160;<br/>
DB2<b>&#160;</b><br/>
<b>Adr_LSB</b>&#160;<br/>
Loco Address&#160;=&#160;(<b>Adr_MSB</b>&#160;&amp;&#160;0x3F)&#160;&lt;&lt;&#160;8&#160;+&#160;<b>Adr_LSB</b>&#160;<br/>
DB3<b>&#160;</b><br/>
<b>111010MM&#160;</b><br/>
<b>Option</b>&#160;...&#160;<b>0xE8&#160;<br/>MM</b>&#160;...&#160;CVAdr_MSB&#160;<br/>
DB4<b>&#160;</b><br/>
<b>CVAdr_LSB</b>&#160;<br/>
CV&#160;Address&#160;=&#160;(<b>MM</b>&#160;&lt;&lt;&#160;8) +&#160;<b>CVAdr_LSB</b>&#160;<br/>(0=CV1.,&#160;1=CV2, 255=CV256,&#160;etc.)&#160;<br/>
DB5&#160;<br/>
0000<b>VPPP&#160;</b><br/>
<b>PPP</b>&#160;...&#160;Bit-Position&#160;in CV<b>&#160;<br/>V</b>&#160;...&#160;New&#160;CV&#160;Value&#160;<br/>
&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>none&#160;<br/>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
39/78&#160;<br/>
<hr/>
<a name=40></a><img src="docs/z21-40_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>6.8&#160;</b></i><br/>
<i><b>LAN_X_CV_POM_READ_BYTE&#160;</b></i><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.22.</b>&#160;<br/>&#160;<br/>With the following&#160;command a&#160;CV&#160;of&#160;a&#160;locomotive&#160;decoder (“Multi&#160;Function&#160;Digital&#160;Decoders”&#160;according&#160;to&#160;<br/>NMRA&#160;S-9.2.1&#160;Section&#160;C;&#160;Configuration Variable Access&#160;Instruction&#160;-&#160;Long Form)&#160;can&#160;be&#160;read&#160;on&#160;the&#160;<br/>main track&#160;(POM). This&#160;is&#160;done&#160;in&#160;normal&#160;operating mode,&#160;i.e.&#160;the&#160;track&#160;voltage must be&#160;already&#160;switched&#160;<br/>on&#160;and&#160;the&#160;service&#160;mode&#160;is&#160;not activated.&#160;RailCom&#160;must be&#160;activated in the Z21.&#160;The&#160;vehicle&#160;decoder to&#160;<br/>be&#160;read must&#160;be&#160;capable&#160;of&#160;RailCom,&#160;CV28&#160;bit 0&#160;and&#160;1&#160;as&#160;well&#160;as&#160;CV29 bit 3&#160;must&#160;be&#160;set&#160;to 1&#160;in&#160;the&#160;<br/>locomotive&#160;decoder&#160;(Zimo).&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;&#160;DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>DB4&#160;</b><br/>
<b>DB5&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0C&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xE6&#160;</b><br/>
<b>0x30&#160;</b><br/>
<b>POM-Parameter</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>The&#160;data&#160;for&#160;<b>POM&#160;parameters</b>&#160;is&#160;structured&#160;as&#160;follows:<b>&#160;</b><br/>
<b>Position&#160;</b><br/>
<b>Data&#160;</b><br/>
<b>Meaning</b>&#160;<br/>
DB1<b>&#160;</b><br/>
<b>Adr_MSB</b>&#160;<br/>
&#160;<br/>
DB2<b>&#160;</b><br/>
<b>Adr_LSB</b>&#160;<br/>
Loco Address&#160;=&#160;(<b>Adr_MSB</b>&#160;&amp;&#160;0x3F)&#160;&lt;&lt;&#160;8 +&#160;<b>Adr_LSB</b>&#160;<br/>
DB3<b>&#160;</b><br/>
<b>111001MM&#160;</b><br/>
<b>Option</b>&#160;...&#160;<b>0xE4&#160;<br/>MM</b>&#160;...&#160;CVAdr_MSB&#160;<br/>
DB4<b>&#160;</b><br/>
<b>CVAdr_LSB</b>&#160;<br/>
CV&#160;Address&#160;=&#160;(<b>MM</b>&#160;&lt;&lt;&#160;8) +&#160;<b>CVAdr_LSB</b>&#160;<br/>(0=CV1.,&#160;1=CV2, 255=CV256,&#160;etc.)&#160;<br/>
DB5<b>&#160;</b><br/>
<b>0</b>&#160;<br/>
&#160;<br/>
&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/><a href="z21.html#38"><i>6.4&#160;</i>LAN_X_CV_NACK<i>&#160;</i></a>or<a href="z21.html#38"><i>&#160;6.5&#160;</i>LAN_X_CV_RESULT<i>.</i></a>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
40/78&#160;<br/>
<hr/>
<a name=41></a><img src="docs/z21-41_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>6.9&#160;</b></i><br/>
<i><b>LAN_X_CV_POM_ACCESSORY_WRITE_BYTE&#160;</b></i><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.22.</b>&#160;<br/>&#160;<br/>With the following&#160;command a&#160;CV&#160;of&#160;an&#160;accessory&#160;decoder (according&#160;to NMRA&#160;S-9.2.1&#160;Section&#160;D,&#160;<br/>“Basic&#160;Accessory&#160;Decoder&#160;Packet&#160;address&#160;for&#160;operations&#160;mode programming”)&#160;can&#160;be&#160;written on the&#160;<br/>main track&#160;(POM). This&#160;happens&#160;in normal&#160;operating&#160;mode,&#160;i.e. the track&#160;voltage&#160;must be&#160;already&#160;<br/>switched&#160;on&#160;and&#160;the&#160;service&#160;mode&#160;is&#160;not&#160;activated. There is&#160;no feedback.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;&#160;DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>DB4&#160;</b><br/>
<b>DB5&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0C&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xE6&#160;</b><br/>
<b>0x31&#160;</b><br/>
<b>POM-Parameter</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>The&#160;data for&#160;<b>POM&#160;parameters</b>&#160;is&#160;structured&#160;as&#160;follows:<b>&#160;</b><br/>
<b>Position&#160;</b><br/>
<b>Data&#160;</b><br/>
<b>Meaning</b>&#160;<br/>
DB1<b>&#160;</b><br/>
<b>aaaaa</b>&#160;<br/>
Decoder_Address&#160;MSB&#160;<br/>
DB2<b>&#160;</b><br/>
<b>AAAACDDD</b>&#160;<br/>
Note:&#160;<b>aaaaaAAAACDDD</b>&#160;=&#160;((Decoder_Address&#160;&amp;&#160;0x1FF)&#160;&lt;&lt;&#160;4) |&#160;CDDD;&#160;<br/>In&#160;case&#160;<b>CDDD</b>=0000,&#160;then&#160;the&#160;CV&#160;refers&#160;to&#160;the&#160;whole&#160;decoder.&#160;<br/>In&#160;case&#160;<b>C</b>=1,&#160;then&#160;<b>DDD</b>&#160;is&#160;the&#160;number of the&#160;output&#160;to&#160;be&#160;programmed.&#160;<br/>
DB3<b>&#160;</b><br/>
<b>111011MM&#160;</b><br/>
<b>Option</b>&#160;...&#160;<b>0xEC&#160;<br/>MM</b>&#160;...&#160;CVAdr_MSB&#160;<br/>
DB4<b>&#160;</b><br/>
<b>CVAdr_LSB</b>&#160;<br/>
CV&#160;Address&#160;=&#160;(<b>MM</b>&#160;&lt;&lt;&#160;8) +&#160;<b>CVAdr_LSB</b>&#160;<br/>(0=CV1,&#160;1=CV2,&#160;255=CV256,&#160;etc.)&#160;<br/>
DB5<b>&#160;</b><br/>
<b>Value</b>&#160;<br/>
new CV&#160;value&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>none&#160;<br/>
<i><b>6.10&#160;&#160;LAN_X_CV_POM_&#160;ACCESSORY_WRITE_BIT&#160;</b></i><br/>
<b>&#160;<br/>From&#160;Z21&#160;FW&#160;Version&#160;1.22.</b>&#160;<br/>&#160;<br/>With the following&#160;command a&#160;CV&#160;of&#160;an&#160;accessory&#160;decoder (according&#160;to NMRA&#160;S-9.2.1&#160;Section&#160;D,&#160;<br/>“Basic&#160;Accessory&#160;Decoder&#160;Packet&#160;address&#160;for&#160;operations&#160;mode programming”)&#160;can&#160;be&#160;written on the&#160;<br/>main track&#160;(POM). This&#160;happens&#160;in normal&#160;operating&#160;mode,&#160;i.e. the track&#160;voltage&#160;must be&#160;already&#160;<br/>switched&#160;on&#160;and&#160;the&#160;service&#160;mode&#160;is&#160;not&#160;activated. There is&#160;no&#160;feedback.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;&#160;DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>DB4&#160;</b><br/>
<b>DB5&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0C&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xE6&#160;</b><br/>
<b>0x31&#160;</b><br/>
<b>POM-Parameter</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>The&#160;data&#160;for&#160;<b>POM&#160;parameters</b>&#160;is&#160;structured&#160;as&#160;follows:<b>&#160;</b><br/>
<b>Position&#160;</b><br/>
<b>Data&#160;</b><br/>
<b>Meaning</b>&#160;<br/>
DB1<b>&#160;</b><br/>
<b>aaaaa</b>&#160;<br/>
Decoder_Address&#160;MSB&#160;<br/>
DB2<b>&#160;</b><br/>
<b>AAAACDDD</b>&#160;<br/>
Note:&#160;<b>aaaaaAAAACDDD</b>&#160;=&#160;((Decoder_Address&#160;&amp;&#160;0x1FF)&#160;&lt;&lt;&#160;4) |&#160;CDDD;&#160;<br/>In&#160;case&#160;<b>CDDD</b>=0000,&#160;then&#160;the&#160;CV&#160;refers&#160;to&#160;the&#160;whole&#160;decoder.&#160;<br/>In&#160;case&#160;<b>C</b>=1,&#160;then&#160;<b>DDD</b>&#160;is&#160;the&#160;number of the&#160;output&#160;to&#160;be programmed.&#160;<br/>
DB3<b>&#160;</b><br/>
<b>111010MM&#160;</b><br/>
<b>Option</b>&#160;...&#160;<b>0xE8&#160;<br/>MM</b>&#160;...&#160;CVAdr_MSB&#160;<br/>
DB4<b>&#160;</b><br/>
<b>CVAdr_LSB</b>&#160;<br/>
CV&#160;Address&#160;=&#160;(<b>MM</b>&#160;&lt;&lt;&#160;8) +&#160;<b>CVAdr_LSB</b>&#160;<br/>(0=CV1,&#160;1=CV2,&#160;255=CV256, etc.)&#160;<br/>
DB5&#160;<br/>
0000<b>VPPP&#160;</b><br/>
<b>PPP</b>&#160;...&#160;Bit position&#160;in&#160;CV<b>&#160;<br/>V</b>&#160;...&#160;new&#160;CV&#160;value&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
41/78&#160;<br/>
<hr/>
<a name=42></a><img src="docs/z21-42_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>none&#160;<br/>&#160;<br/>
<i><b>6.11&#160;&#160;LAN_X_CV_POM_&#160;ACCESSORY_READ_BYTE&#160;</b></i><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.22.</b>&#160;<br/>&#160;<br/>With the following&#160;command a&#160;CV&#160;of&#160;an&#160;accessory&#160;decoder (according&#160;to NMRA&#160;S-9.2.1&#160;Section&#160;D,&#160;<br/>“Basic&#160;Accessory&#160;Decoder&#160;Packet&#160;address&#160;for&#160;operations&#160;mode programming”)&#160;can&#160;be&#160;read&#160;on&#160;the&#160;main&#160;<br/>track&#160;(POM). This&#160;happens&#160;in&#160;normal&#160;operating&#160;mode,&#160;i.e.&#160;the track&#160;voltage&#160;must&#160;be&#160;already&#160;switched&#160;on,&#160;<br/>the&#160;service&#160;mode is&#160;not&#160;activated.&#160;RailCom&#160;must be&#160;activated in the Z21.&#160;The&#160;accessory&#160;decoder to&#160;be&#160;<br/>read must be&#160;capable&#160;of&#160;RailCom.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;&#160;DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>DB4&#160;</b><br/>
<b>DB5&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0C&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xE6&#160;</b><br/>
<b>0x31&#160;</b><br/>
<b>POM-Parameter</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>The&#160;data&#160;for&#160;<b>POM&#160;parameters</b>&#160;is&#160;structured&#160;as&#160;follows:<b>&#160;</b><br/>
<b>Position&#160;</b><br/>
<b>Data&#160;</b><br/>
<b>Meaning</b>&#160;<br/>
DB1<b>&#160;</b><br/>
<b>aaaaa</b>&#160;<br/>
Decoder_Address&#160;MSB&#160;<br/>
DB2<b>&#160;</b><br/>
<b>AAAACDDD</b>&#160;<br/>
Note:&#160;<b>aaaaaAAAACDDD</b>&#160;=&#160;((Decoder_Address&#160;&amp;&#160;0x1FF)&#160;&lt;&lt;&#160;4) |&#160;CDDD;&#160;<br/>In&#160;case&#160;<b>CDDD</b>=0000,&#160;then&#160;the&#160;CV&#160;refers&#160;to&#160;the&#160;whole&#160;decoder.&#160;<br/>In&#160;case&#160;<b>C</b>=1,&#160;then&#160;<b>DDD</b>&#160;is&#160;the&#160;number of the&#160;output&#160;to&#160;be&#160;programmed.&#160;<br/>
DB3<b>&#160;</b><br/>
<b>111001MM&#160;</b><br/>
<b>Option</b>&#160;...&#160;<b>0xE4&#160;<br/>MM</b>&#160;...&#160;CVAdr_MSB&#160;<br/>
DB4<b>&#160;</b><br/>
<b>CVAdr_LSB</b>&#160;<br/>
CV&#160;Address&#160;=&#160;(<b>MM</b>&#160;&lt;&lt;&#160;8) +&#160;<b>CVAdr_LSB</b>&#160;<br/>(0=CV1,&#160;1=CV2,&#160;255=CV256, etc.)&#160;<br/>
DB5<b>&#160;</b><br/>
<b>0</b>&#160;<br/>
new CV&#160;value&#160;<br/>
&#160;<br/>&#160;<br/>Reply&#160;from&#160;Z21:&#160;&#160;<br/><a href="z21.html#38"><i>6.4&#160;</i>LAN_X_CV_NACK<i>&#160;</i></a>or<a href="z21.html#38"><i>&#160;6.5&#160;</i>LAN_X_CV_RESULT<i>.</i></a><i>&#160;<br/>&#160;</i><br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
42/78&#160;<br/>
<hr/>
<a name=43></a><img src="docs/z21-43_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/><i>&#160;</i><br/>
<i><b>6.12&#160;&#160;LAN_X_MM_WRITE_BYTE&#160;</b></i><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.23.&#160;<br/>&#160;<br/></b>With the following&#160;command a&#160;register of&#160;a&#160;Motorola&#160;decoder can&#160;be&#160;written&#160;on the programming&#160;track.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;&#160;DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x0A&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x24&#160;</b><br/>
<b>0xFF&#160;&#160;0&#160;</b><br/>
<b>RegAdr&#160;</b><br/>
<b>Value</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;<b>RegAdr</b>:&#160;0=Register1, 1=Register2, ...,&#160;78=Register79.&#160;<br/>Note:&#160;0 ≤&#160;<b>Value</b>&#160;≤&#160;255,&#160;but&#160;some decoders&#160;only&#160;accept&#160;values&#160;from 0&#160;to&#160;80.&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/><a href="z21.html#13"><i>2.9&#160;</i>LAN_X_BC_PROGRAMMING_MODE&#160;</a>to&#160;subscribed&#160;clients,&#160;as&#160;well&#160;as&#160;the result&#160;<br/><a href="z21.html#37"><i>6.3&#160;</i>LAN_X_CV_NACK_SC<i>&#160;</i></a>or<a href="z21.html#38"><i>&#160;6.5&#160;</i>LAN_X_CV_RESULT<i>.</i></a>&#160;<br/>&#160;<br/><b>Note</b>:&#160;Programming&#160;a&#160;Motorola decoder&#160;was&#160;not&#160;possible&#160;in&#160;the&#160;original&#160;Motorola&#160;format.&#160;<br/>Therefore&#160;there&#160;exists&#160;no&#160;standardized&#160;and&#160;binding&#160;programming&#160;procedure for&#160;programming&#160;Motorola&#160;<br/>decoders.&#160;However, for the&#160;programming&#160;of&#160;Motorola&#160;decoders, the&#160;so-called &#34;6021&#160;programming mode&#34;&#160;<br/>was&#160;implemented&#160;in&#160;the&#160;Z21.&#160;This&#160;allows&#160;writing values, but&#160;there&#160;is&#160;no&#160;way&#160;to&#160;read&#160;them.&#160;Hence&#160;the&#160;<br/>success&#160;of&#160;the write operation&#160;cannot&#160;be&#160;checked&#160;(except for short-circuit&#160;detection). This&#160;programming&#160;<br/>procedure&#160;works&#160;for&#160;many&#160;ESU, Zimo&#160;and&#160;Märklin decoders, but not necessarily&#160;for all&#160;MM decoders.&#160;&#160;<br/>For example,&#160;Motorola decoders&#160;with DIP&#160;switches&#160;cannot&#160;be&#160;programmed.&#160;Some decoders&#160;only&#160;accept&#160;<br/>values&#160;from 0&#160;to&#160;80,&#160;others&#160;accept values&#160;from&#160;0&#160;to 255 (see&#160;decoder&#160;description).&#160;<br/>&#160;<br/>Since&#160;no&#160;feedback&#160;about&#160;the success&#160;of&#160;the&#160;write&#160;operation comes&#160;from the&#160;decoder&#160;during&#160;Motorola&#160;<br/>programming, the&#160;message&#160;<i>LAN_X_CV_RESULT</i>&#160;is&#160;only&#160;to&#160;be&#160;understood&#160;as&#160;&#34;<i>MM programming process&#160;<br/>finished</i>&#34;&#160;and&#160;<b>not&#160;</b>as&#160;&#34;<i>MM programming process&#160;successful</i>&#34;.&#160;<br/>&#160;<br/>Example:<b>&#160;</b><br/>
<b>0x0A 0x00 0x40 0x00 0x24 0xFF 0x00 0x00 0x05 0xDE&#160;</b>&#160;<br/>meaning:&#160;&#34;Change&#160;the locomotive&#160;decoder&#160;address&#160;(register 1)&#160;to 5&#34;&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
43/78&#160;<br/>
<hr/>
<a name=44></a><img src="docs/z21-44_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>6.13&#160;&#160;LAN_X_DCC_READ_REGISTER&#160;</b></i><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.25.&#160;<br/>&#160;<br/></b>The&#160;following&#160;command&#160;can&#160;be&#160;used&#160;to read a&#160;register&#160;of&#160;a&#160;DCC decoder&#160;in register mode (S-9.2.3&#160;<br/>Service Mode Instruction&#160;Packets&#160;for&#160;Physical&#160;Register&#160;Addressing)&#160;on&#160;the&#160;programming&#160;track.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB1&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x08&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x22&#160;</b><br/>
<b>0x11&#160;</b><br/>
<b>REG&#160;</b><br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;<b>REG</b>:&#160;0x01=Register1,&#160;0x02=Register2, …,&#160;0x08=Register8.&#160;<br/>Note:&#160;0&#160;≤&#160;<b>Value</b>&#160;≤&#160;255&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/><a href="z21.html#13"><i>2.9&#160;</i>LAN_X_BC_PROGRAMMING_MODE&#160;</a>to&#160;subscribed&#160;clients,&#160;as&#160;well&#160;as&#160;the result&#160;<br/><a href="z21.html#37"><i>6.3&#160;</i>LAN_X_CV_NACK_SC<i>&#160;</i></a>or<a href="z21.html#38"><i>&#160;6.5&#160;</i>LAN_X_CV_RESULT<i>.</i></a>&#160;<br/>&#160;<br/><b>Note</b>:&#160;Programming in register mode&#160;is&#160;only&#160;required&#160;for&#160;very&#160;old DCC&#160;decoders. Direct CV&#160;is&#160;preferred.&#160;<br/>&#160;<br/>&#160;<br/>
<i><b>6.14&#160;&#160;LAN_X_DCC_WRITE_REGISTER&#160;</b></i><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.25.&#160;<br/>&#160;<br/></b>With the following&#160;command a&#160;register of a&#160;DCC decoder&#160;in&#160;register mode&#160;(S-9.2.3 Service&#160;Mode&#160;<br/>Instruction&#160;Packets&#160;for&#160;Physical&#160;Register&#160;Addressing)&#160;can&#160;be&#160;written on the programming&#160;track.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>X-Header&#160;</b><br/>
<b>DB0&#160;</b><br/>
<b>DB2&#160;</b><br/>
<b>DB3&#160;</b><br/>
<b>XOR-Byte</b>&#160;<br/>
0x09&#160;<br/>
0x00<b>&#160;&#160;0x40</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x23&#160;</b><br/>
<b>0x12&#160;</b><br/>
<b>REG&#160;</b><br/>
<b>Value</b>&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>Note:&#160;<b>REG</b>:&#160;0x01=Register1,&#160;0x02=Register2, …,&#160;0x08=Register8.&#160;<br/>Note:&#160;0&#160;≤&#160;<b>Value</b>&#160;≤&#160;255&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/><a href="z21.html#13"><i>2.9&#160;</i>LAN_X_BC_PROGRAMMING_MODE&#160;</a>to&#160;subscribed&#160;clients,&#160;as&#160;well&#160;as&#160;the result&#160;<br/><a href="z21.html#37"><i>6.3&#160;</i>LAN_X_CV_NACK_SC<i>&#160;</i></a>or<a href="z21.html#38"><i>&#160;6.5&#160;</i>LAN_X_CV_RESULT<i>.</i></a>&#160;<br/>&#160;<br/><b>Note</b>: Programming in register mode&#160;is&#160;only&#160;required&#160;for&#160;very&#160;old DCC&#160;decoders. Direct CV&#160;is&#160;preferred.&#160;<br/>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
44/78&#160;<br/>
<hr/>
<a name=45></a><img src="docs/z21-45_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>
<b>7&#160;&#160;Feedback&#160;–&#160;R-BUS&#160;<br/></b>&#160;<br/>The&#160;feedback&#160;modules&#160;(Roco&#160;10787,&#160;10808,&#160;10819)&#160;on the&#160;R-BUS&#160;can&#160;be&#160;read&#160;out&#160;and configured with&#160;<br/>the&#160;following&#160;commands.&#160;<br/>&#160;<br/>
<i><b>7.1&#160;</b></i><br/>
<i><b>LAN_RMBUS_DATACHANGED&#160;</b></i><br/>
&#160;<br/>Report the&#160;changes&#160;on&#160;the&#160;feedback&#160;bus&#160;from the Z21&#160;to&#160;the client.&#160;<br/>&#160;<br/>This&#160;message is&#160;asynchronously&#160;reported to the client&#160;by&#160;the Z21 when&#160;the&#160;client&#160;<br/>
•&#160;&#160;activated the corresponding broadcast, see<a href="z21.html#16"><i><b>&#160;2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;<br/>
0x00000002&#160;<br/>
•&#160;&#160;or explicitly&#160;requested&#160;the&#160;feedback&#160;status, see&#160;bel<a href="z21.html#45">ow&#160;<i>7.2&#160;</i>LAN_RMBUS_GETDATA.</a>&#160;<br/>
&#160;&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x0F&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x80</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>Group&#160;index</b>&#160;(1&#160;Byte)<b>&#160;</b><br/>
<b>Feedback&#160;status</b>&#160;(10 Byte)&#160;<br/>
&#160;<br/><b>Group&#160;index:</b>&#160;&#160;&#160;0 ...&#160;feedback&#160;module with&#160;address&#160;from&#160;1&#160;to&#160;10&#160;<br/>
1 ...&#160;feedback&#160;module with&#160;address&#160;from&#160;11&#160;to&#160;20&#160;<br/>
&#160;<br/><b>Feedback&#160;status:&#160;</b>1&#160;byte&#160;per feedback, 1&#160;bit&#160;per&#160;input.&#160;&#160;<br/>
&#160; &#160; &#160;The&#160;order&#160;of&#160;feedback&#160;address&#160;and&#160;byte&#160;position&#160;is&#160;ascending.&#160;<br/>
&#160;<br/>Example:&#160;&#160;<br/>Group Index&#160;=&#160;1&#160;and&#160;Feedback&#160;Status&#160;=&#160;0x01&#160;0x00 0xC5 0x00&#160;0x00&#160;&#160;0x00&#160;0x00&#160;0x00&#160;0x00&#160;0x00&#160;<br/>means&#160;&#34;feedback&#160;module&#160;#11, contact on input&#160;1;&#160;feedback&#160;module #13, contact on input&#160;8,7,3 and&#160;1&#34;&#160;<br/>&#160;<br/>
<i><b>7.2&#160;</b></i><br/>
<i><b>LAN_RMBUS_GETDATA&#160;</b></i><br/>
&#160;<br/>Poll&#160;the&#160;current status&#160;of&#160;the&#160;feedback&#160;modules.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x05&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x81</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>Group&#160;index</b>&#160;(1&#160;Byte)&#160;<br/>
&#160;<br/><b>Group&#160;index:</b>&#160;see&#160;above&#160;<br/>&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>
&#160;<br/>
See&#160;above<a href="z21.html#45">&#160;<i>7.1&#160;</i>LAN_RMBUS_DATACHANGED&#160;<br/></a>&#160;<br/>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
45/78&#160;<br/>
<hr/>
<a name=46></a><img src="docs/z21-46_1.png"/><br/>
<img src="docs/z21-46_2.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>7.3&#160;</b></i><br/>
<i><b>LAN_RMBUS_PROGRAMMODULE&#160;</b></i><br/>
&#160;<br/>Change&#160;the&#160;address&#160;of&#160;one&#160;feedback&#160;module.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x05&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x82</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>Address</b>&#160;(1 Byte)&#160;<br/>
&#160;<br/><b>Address:</b>&#160;New&#160;address&#160;for&#160;the&#160;feedback&#160;module to&#160;be&#160;programmed.&#160;&#160;<br/>Supported value&#160;range:&#160;0&#160;and&#160;1&#160;...&#160;20.&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>
&#160;<br/>
none&#160;<br/>&#160;<br/>The&#160;programming-sequence&#160;is&#160;transmitted&#160;on&#160;the&#160;R-BUS&#160;until&#160;this&#160;command is&#160;sent again to the Z21&#160;with&#160;<br/>address=0.&#160;<br/>&#160;<br/>Only&#160;one single&#160;feedback&#160;module should&#160;be&#160;connected to the&#160;R-BUS&#160;during&#160;the&#160;programming&#160;process.&#160;<br/>&#160;<br/>
&#160;<br/>
<b>Figure&#160;7&#160;Example&#160;Sequence:&#160;Programming&#160;the feedback module&#160;</b><br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
46/78&#160;<br/>
<hr/>
<a name=47></a><img src="docs/z21-47_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>8&#160;&#160;RailCom&#160;<br/></b>&#160;<br/>The&#160;Z21&#160;supports&#160;RailCom&#160;with:&#160;<br/>&#160;<br/>
•&#160;&#160;Generating&#160;the&#160;RailCom&#160;cutout&#160;in&#160;the&#160;track&#160;signal.&#160;<br/>•&#160;&#160;Global&#160;RailCom&#160;receiver&#160;in&#160;the&#160;Z21.&#160;<br/>
•&#160;&#160;Local&#160;RailCom&#160;receivers, e.g.&#160;in the occupancy&#160;detectors&#160;10808&#160;or boosters&#160;10806&#160;and&#160;10807.&#160;<br/>
The&#160;data&#160;from RailCom&#160;channel&#160;2&#160;of&#160;the&#160;10806,&#160;10807&#160;and&#160;10808&#160;can&#160;be&#160;forwarded via CAN to&#160;<br/>the&#160;Z21 and evaluated&#160;there from&#160;FW&#160;V1.29&#160;onwards.&#160;<br/>
•&#160;&#160;Reading&#160;POM&#160;results.&#160;<br/>
See&#160;als<a href="z21.html#40">o&#160;6.8&#160;LAN_X_CV_POM_READ_BYTE&#160;</a>as&#160;of&#160;FW&#160;V1.22.&#160;<br/>
•&#160;&#160;Locomotive&#160;address&#160;recognition&#160;for occupancy&#160;detectors&#160;(CAN, LocoNet, X-BUS).&#160;<br/>
See<a href="z21.html#53">&#160;9.5&#160;<i>LAN_LOCONET_DETECTOR</i>&#160;</a>from&#160;V1.22&#160;and<a href="z21.html#57">&#160;10.1&#160;<i>LAN_CAN_DETECTOR</i>&#160;</a>from&#160;V1.30.&#160;<br/>
•&#160;&#160;Decoder speed (see below)&#160;from FW&#160;V1.29.&#160;<br/>
•&#160;&#160;Decoder QoS&#160;(see&#160;below)&#160;from&#160;FW&#160;V1.29.&#160;<br/>
&#160;<br/>In&#160;order&#160;to&#160;use&#160;these&#160;features, the&#160;decoder must&#160;be&#160;capable&#160;of RailCom,&#160;CV28&#160;and CV29&#160;must be&#160;<br/>correctly&#160;configured,&#160;and the option &#34;RailCom&#34;&#160;must&#160;activated in the Z21&#160;settings.&#160;&#160;<br/>&#160;<br/><b>Note</b>:&#160;It&#160;heavily&#160;depends&#160;on&#160;the&#160;decoder firmware&#160;whether&#160;and in which&#160;form a&#160;decoder supports&#160;speed,&#160;<br/>QoS&#160;and&#160;POM!&#160;<br/>
<i><b>8.1&#160;</b></i><br/>
<i><b>LAN_RAILCOM_DATACHANGED&#160;</b></i><br/>
&#160;<br/>This&#160;message is&#160;sent&#160;to&#160;the&#160;clients&#160;by&#160;the Z21&#160;from&#160;FW&#160;version&#160;1.29&#160;on&#160;as&#160;a&#160;response to the&#160;command&#160;<br/><a href="z21.html#48">8.2&#160;LAN_RAILCOM_GETDATA.</a>&#160;<br/>&#160;&#160;<br/>However,&#160;it is&#160;also sent&#160;to clients&#160;unsolicitedly,&#160;if&#160;&#160;<br/>
•&#160;<br/>
the&#160;corresponding&#160;RailCom&#160;data&#160;have&#160;actually&#160;changed&#160;&#160;<br/>
•&#160;<br/>
and the&#160;associated&#160;client&#160;has&#160;activated the corresponding broadcast.&#160;<br/>(see<a href="z21.html#16">&#160;<b>2.16&#160;</b>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag 0x00000004)&#160;and&#160;the&#160;associated&#160;client&#160;has&#160;<br/>subscribed to the locomotive address&#160;with<a href="z21.html#23">&#160;4.1&#160;LAN_X_GET_LOCO_INFO.</a>&#160;<br/>
•&#160;<br/>
or the&#160;associated&#160;client&#160;has&#160;subscribed to&#160;broadcast 0x00040000 (i.e.&#160;RailCom data of&#160;all&#160;<br/>locomotives, for PC control&#160;SW&#160;only).&#160;<br/>
&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x11&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x88</b>&#160;<br/>
0x00&#160;&#160;<b>RailComData</b>&#160;<br/>
&#160;<br/>The&#160;structure&#160;<b>RailComData</b>&#160;is&#160;structured&#160;as&#160;follows&#160;(the&#160;16-bit&#160;and 32-bit values&#160;are little endian)<b>&#160;</b><br/>
<b>Byte Offset&#160;</b><br/>
<b>Type&#160;</b><br/>
<b>Name&#160;</b><br/>
<b>&#160;</b><br/>
0&#160;<br/>
UINT16&#160;&#160;LocoAddress&#160;<br/>
Address&#160;of&#160;the&#160;detected&#160;decoder&#160;<br/>
2&#160;<br/>
UINT32&#160;&#160;ReceiveCounter&#160;<br/>
Receive counter&#160;in Z21&#160;<br/>
6&#160;<br/>
UINT16&#160;&#160;ErrorCounter&#160;<br/>
Receive&#160;error counter in&#160;Z21&#160;<br/>
8&#160;<br/>
UINT8&#160;<br/>
reserved&#160;<br/>
&#160;<br/>
9&#160;<br/>
UINT8&#160;<br/>
Options&#160;<br/>
Flags&#160;bitmask:&#160;<br/>#define rcoSpeed1&#160;&#160;0x01&#160;// CH7 subindex 0&#160;<br/>#define rcoSpeed2&#160;&#160;0x02&#160;// CH7 subindex 1&#160;<br/>#define rcoQoS&#160;<br/>
0x04&#160;// CH7 subindex 7&#160;<br/>
10&#160;<br/>
UINT8&#160;<br/>
Speed&#160;<br/>
Speed&#160;1&#160;or 2 (if supported&#160;by&#160;decoder)&#160;<br/>
11&#160;<br/>
UINT8&#160;<br/>
QoS&#160;<br/>
Quality&#160;of&#160;Service (if supported&#160;by&#160;decoder)&#160;<br/>
12&#160;<br/>
UINT8&#160;<br/>
reserved&#160;<br/>
&#160;<br/>
The&#160;structure can&#160;be&#160;increased in&#160;the&#160;future&#160;versions;&#160;therefore&#160;it&#160;is&#160;absolutely&#160;necessary&#160;to&#160;consider&#160;<br/>DataLen&#160;in the&#160;evaluation.&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
47/78&#160;<br/>
<hr/>
<a name=48></a><img src="docs/z21-48_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>8.2&#160;</b></i><br/>
<i><b>LAN_RAILCOM_GETDATA&#160;</b></i><br/>
&#160;<br/>Poll&#160;RailCom data&#160;from Z21,&#160;available from&#160;FW&#160;V1.29&#160;and&#160;higher:&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0x89</b>&#160;<br/>
0x00&#160;<br/>
<b>Type</b>&#160;8&#160;bit&#160;<br/>
<b>LocoAddress</b>&#160;16&#160;bit&#160;(little&#160;endian)&#160;<br/>
&#160;<br/><b>Type</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
0x01&#160;=&#160;poll&#160;RailCom&#160;data&#160;for given&#160;locomotive address&#160;<br/>
&#160;<br/><b>LocoAddress</b>&#160;&#160;&#160;<br/>
<b>Loco address</b>&#160;<br/>
&#160;<br/>
0=&#160;poll&#160;RailCom data&#160;of&#160;next loco&#160;(circular buffer)&#160;<br/>
&#160;<br/>Reply&#160;from&#160;Z21:&#160;&#160;<br/>
&#160;<br/>
See&#160;abov<a href="z21.html#48">e&#160;<i>8.2&#160;</i></a><a href="z21.html#47">LAN_RAILCOM_DATACHANGED&#160;<br/></a>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
48/78&#160;<br/>
<hr/>
<a name=49></a><img src="docs/z21-49_1.png"/><br/>
<img src="docs/z21-49_2.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>
<b>9&#160;&#160;LocoNet&#160;<br/></b>&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.20.&#160;&#160;<br/></b>&#160;<br/>As&#160;mentioned in the introduction,&#160;the&#160;Z21&#160;can&#160;be&#160;used&#160;as&#160;<b>an Ethernet/LocoNet&#160;gateway</b>, where&#160;the&#160;Z21&#160;<br/>is&#160;also&#160;the&#160;LocoNet&#160;master&#160;refreshing the slots&#160;and&#160;generating&#160;the&#160;DCC packets.&#160;<br/>&#160;<br/>The&#160;LAN client&#160;can&#160;subscribe&#160;to&#160;the&#160;corresponding LocoNet&#160;messages&#160;using<a href="z21.html#16">&#160;<i><b>2.16&#160;<br/></b></i>LAN_SET_BROADCASTFLAGS<i><b>&#160;</b></i></a>in&#160;order&#160;to receive&#160;also the&#160;messages&#160;from LocoNet.&#160;<br/>&#160;<br/>Messages&#160;received by&#160;the&#160;Z21&#160;from&#160;the&#160;LocoNet&#160;bus&#160;are forwarded&#160;to&#160;the&#160;LAN client&#160;with the LAN&#160;<br/>header&#160;<i><b>LAN_LOCONET_Z21_RX</b></i>.&#160;<br/>&#160;<br/>Messages&#160;sent by&#160;the Z21&#160;onto&#160;the&#160;LocoNet&#160;bus&#160;are also forwarded&#160;to&#160;the&#160;LAN client&#160;using&#160;the&#160;LAN&#160;<br/>header&#160;<i><b>LAN_LOCONET_Z21_TX</b></i>.&#160;<br/>&#160;<br/>With the Z21-LAN command&#160;<i><b>LAN_LOCONET_FROM_LAN</b></i>&#160;the LAN client itself can&#160;write messages&#160;onto&#160;<br/>the&#160;LocoNet&#160;bus. If there are other LAN clients&#160;with&#160;LocoNet&#160;subscriptions&#160;at&#160;the&#160;same time, they&#160;will&#160;also&#160;<br/>be&#160;notified with&#160;a&#160;message&#160;<i><b>LAN_LOCONET_FROM_LAN</b></i>. Only&#160;the&#160;actual&#160;sender&#160;will&#160;not be&#160;notified.&#160;<br/>&#160;<br/>
&#160;<br/>
<b>Figure&#160;8&#160;Example&#160;Sequence:&#160;Ethernet/LocoNet&#160;gateway&#160;</b><br/>
&#160;<br/>This&#160;example shows&#160;that&#160;even&#160;with trivial&#160;processes&#160;on the&#160;LocoNet&#160;bus, considerable&#160;network&#160;traffic&#160;can&#160;<br/>simultaneously&#160;occur on the Ethernet or&#160;Wi-Fi.&#160;&#160;<br/>&#160;<br/>Please&#160;note&#160;that&#160;this&#160;Ethernet/LocoNet&#160;Gateway&#160;functionality&#160;has&#160;primarily&#160;been&#160;created for PC control&#160;<br/>SW&#160;as&#160;an&#160;additional&#160;tool&#160;for&#160;communicating&#160;with&#160;e.g.&#160;LocoNet&#160;feedback&#160;devices, etc.&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
49/78&#160;<br/>
<hr/>
<a name=50></a><img src="docs/z21-50_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
When&#160;subscribing&#160;to&#160;the&#160;LocoNet&#160;messages, you&#160;should&#160;carefully&#160;consider&#160;whether the&#160;broadcast&#160;flags&#160;<br/>0x02000000 (LocoNet&#160;locomotives)&#160;and&#160;0x04000000&#160;(LocoNet&#160;switches)&#160;are&#160;really&#160;necessary&#160;for&#160;your&#160;<br/>application. For&#160;conventional&#160;driving and switching,&#160;in&#160;particular,&#160;you&#160;should&#160;better&#160;use&#160;the&#160;LAN&#160;<br/>commands&#160;already&#160;described&#160;in&#160;chapters<a href="z21.html#23">&#160;<i><b>4</b></i>&#160;Driving,&#160;</a><a href="z21.html#30"><i><b>5</b></i>&#160;Switching&#160;</a>and<a href="z21.html#37">&#160;<i><b>6&#160;</b></i>Reading&#160;and&#160;writing&#160;Decoder&#160;CV.</a>&#160;<br/>The&#160;actual&#160;LocoNet&#160;protocol&#160;is&#160;not&#160;described&#160;in more&#160;details&#160;in this&#160;specification.&#160;Please&#160;directly&#160;contact&#160;<br/>Digitrax&#160;or the manufacturer&#160;of&#160;the&#160;respective&#160;LocoNet&#160;hardware, especially&#160;if that&#160;manufacturer&#160;has&#160;<br/>extended&#160;the&#160;LocoNet&#160;protocol&#160;for&#160;e.g.&#160;configuration&#160;purposes&#160;etc.&#160;<br/>&#160;<br/>
<i><b>9.1&#160;</b></i><br/>
<b>LAN_LOCONET_Z21_RX&#160;<i>&#160;</i></b><br/>
&#160;<br/><b>From Z21&#160;FW&#160;Version&#160;1.20.&#160;&#160;<br/></b>&#160;<br/>This&#160;message is&#160;asynchronously&#160;reported to the client&#160;by&#160;the Z21 when&#160;the&#160;client&#160;<br/>
•&#160;&#160;activated the corresponding broadcast, see<a href="z21.html#16">&#160;<i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flags&#160;<br/>
0x01000000,&#160;0x02000000&#160;or 0x04000000.&#160;<br/>
•&#160;&#160;and&#160;a message&#160;has&#160;been&#160;received&#160;by&#160;the&#160;Z21&#160;from&#160;the LocoNet&#160;bus.&#160;<br/>
&#160;&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>LocoNet&#160;message&#160;incl. CKSUM</b>&#160;<br/>
0x04+n&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xA0</b>&#160;<br/>
0x00<b>&#160;</b><br/>
n Bytes&#160;<br/>
&#160;<br/>
<i><b>9.2&#160;</b></i><br/>
<b>LAN_LOCONET_Z21_TX&#160;<i>&#160;</i></b><br/>
<b>&#160;<br/>From&#160;Z21&#160;FW&#160;Version&#160;1.20.&#160;&#160;<br/></b>&#160;<br/>This&#160;message is&#160;asynchronously&#160;reported to the client&#160;by&#160;the Z21 when&#160;the&#160;client&#160;<br/>
•&#160;&#160;activated the&#160;corresponding broadcast, see<a href="z21.html#16">&#160;<i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,</i></a><i>&#160;</i>Flags&#160;<br/>
0x01000000,&#160;0x02000000&#160;or 0x04000000.&#160;<br/>
•&#160;&#160;and&#160;a message&#160;has&#160;been&#160;written&#160;to&#160;the&#160;LocoNet bus&#160;by&#160;the Z21.&#160;<br/>
&#160;&#160;<br/>Z21 to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>LocoNet&#160;message&#160;incl. CKSUM</b>&#160;<br/>
0x04+n&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xA1</b>&#160;<br/>
0x00<b>&#160;</b><br/>
n Bytes&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
50/78&#160;<br/>
<hr/>
<a name=51></a><img src="docs/z21-51_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>9.3&#160;</b></i><br/>
<b>LAN_LOCONET_FROM_LAN&#160;<i>&#160;</i></b><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.20.&#160;&#160;<br/></b>&#160;<br/>This&#160;message allows&#160;a&#160;LAN client&#160;to write a&#160;message&#160;to&#160;the LocoNet&#160;bus.&#160;<br/>&#160;<br/>This&#160;message is&#160;also&#160;asynchronously&#160;reported&#160;by&#160;the&#160;Z21&#160;to&#160;a&#160;client when&#160;the&#160;client&#160;<br/>
•&#160;&#160;activated&#160;the&#160;corresponding broadcast, see<a href="z21.html#16">&#160;<i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flags&#160;<br/>
0x01000000,&#160;0x02000000&#160;or&#160;0x04000000.&#160;<br/>
•&#160;&#160;and&#160;<b>another</b>&#160;LAN client&#160;has&#160;written&#160;a message to the&#160;LocoNet&#160;bus&#160;via&#160;the Z21.&#160;<br/>
&#160;<br/>LAN client&#160;to&#160;Z21,&#160;or Z21&#160;to&#160;LAN client:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>LocoNet&#160;message&#160;incl. CKSUM</b>&#160;<br/>
0x04+n&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xA2</b>&#160;<br/>
0x00<b>&#160;</b><br/>
n Bytes&#160;<br/>
<b>9.3.1&#160;</b><br/>
<b>DCC Binary&#160;State Control&#160;Instruction&#160;via LocoNet&#160;OPC_IMM_PACKET&#160;</b><br/>
<b>&#160;<br/>From&#160;Z21&#160;FW&#160;Version&#160;1.42</b>&#160;on,&#160;the&#160;new&#160;command<a href="z21.html#27">&#160;<i>4.3.3&#160;LAN_X_SET_LOCO_BINARY_STATE</i>&#160;</a>is&#160;<br/>recommended for switching&#160;binary&#160;states&#160;instead of&#160;using&#160;the method described&#160;below.&#160;<br/>However, the&#160;following&#160;paragraph text, which&#160;is&#160;now somewhat&#160;outdated,&#160;remains&#160;for&#160;the sake&#160;of&#160;<br/>completeness:&#160;<br/>&#160;<br/><b>From&#160;FW&#160;Version&#160;V1.25</b>&#160;any&#160;DCC packets&#160;can&#160;be&#160;generated at&#160;the&#160;track&#160;output&#160;using&#160;<br/>LAN_LOCONET_FROM_LAN&#160;and&#160;the&#160;LocoNet command OPC_IMM_PACKET,&#160;among them&#160;the&#160;Binary&#160;<br/>State Control&#160;Instruction&#160;(also called&#160;&#34;F29...F32767&#34;).&#160;This&#160;also&#160;applies&#160;to&#160;the&#160;white&#160;z21,&#160;which&#160;has&#160;no&#160;<br/>physical&#160;LocoNet interface,&#160;but&#160;however&#160;has&#160;a&#160;virtual&#160;LocoNet&#160;stack&#160;inside.&#160;<br/>&#160;<br/>For the&#160;structure&#160;of&#160;the&#160;OPC_IMM_PACKET&#160;see LocoNet Spec&#160;(also in&#160;“personal&#160;edition”&#160;for&#160;learning&#160;<br/>purposes). For&#160;the&#160;structure of the&#160;Binary&#160;State&#160;Control&#160;Instruction&#160;see&#160;NMRA&#160;S-9.2.1&#160;Section&#160;“Feature&#160;<br/>Expansion&#160;Instruction”.&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
51/78&#160;<br/>
<hr/>
<a name=52></a><img src="docs/z21-52_1.png"/><br/>
<img src="docs/z21-52_2.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>9.4&#160;</b></i><br/>
<b>LAN_LOCONET_DISPATCH_ADDR<i>&#160;</i></b><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.20.&#160;&#160;<br/></b>&#160;<br/>Prepare&#160;a&#160;loco&#160;address&#160;for&#160;the&#160;LocoNet&#160;dispatch.&#160;<br/>&#160;<br/>This&#160;message allows&#160;a&#160;LAN client&#160;to prepare a&#160;specific&#160;locomotive&#160;address&#160;for&#160;the LocoNet&#160;dispatch. This&#160;<br/>corresponds&#160;to&#160;a &#34;DISPATCH_PUT&#34;&#160;and&#160;means&#160;that&#160;at&#160;the next&#160;&#34;DISPATCH_GET&#34;&#160;(triggered&#160;by&#160;handset&#160;<br/>controller)&#160;the slot&#160;belonging to this&#160;loco address&#160;is&#160;reported back&#160;by&#160;Z21.&#160;If&#160;necessary, the Z21&#160;<br/>automatically&#160;occupies&#160;a&#160;free&#160;slot for&#160;this&#160;purpose.&#160;<br/><b>&#160;<br/></b>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x06&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xA3</b>&#160;<br/>
0x00&#160;<br/>
16&#160;bits&#160;Loco&#160;address&#160;(<b>little&#160;endian</b>)&#160;<br/>
&#160;<br/>Reply&#160;from Z21:<b>&#160;<br/>Z21&#160;FW&#160;Version&#160;&lt;&#160;1.22:&#160;none&#160;<br/>Z21&#160;FW&#160;Version&#160;≥&#160;1.22:&#160;&#160;<br/>&#160;<br/></b>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xA3</b>&#160;<br/>
0x00&#160;<br/>
16&#160;bits&#160;Loco&#160;address&#160;(<b>little&#160;endian</b>)<b>&#160;</b><br/>
<b>Result</b>&#160;8&#160;bit&#160;<br/>
&#160;<br/><b>Result&#160;&#160;</b>0&#160;<br/>
The&#160;&#34;DISPATCH_PUT&#34;&#160;for&#160;the&#160;given&#160;address&#160;failed.&#160;<br/>This&#160;can&#160;happen,&#160;for&#160;example,&#160;if&#160;the&#160;Z21&#160;is&#160;operated&#160;as&#160;a&#160;LocoNet slave&#160;and the&#160;LocoNet&#160;<br/>master has&#160;rejected&#160;the&#160;dispatch request&#160;because&#160;this&#160;locomotive&#160;address&#160;is&#160;already&#160;<br/>assigned to&#160;another&#160;handset.&#160;<br/>
&#160;<br/>
&gt;0<b>&#160;</b><br/>
The&#160;&#34;DISPATCH_PUT&#34;&#160;was&#160;executed successfully. The loco&#160;address&#160;can&#160;now be&#160;<br/>transferred&#160;to a&#160;handset&#160;controller (e.g.&#160;FRED). The value of&#160;Result corresponds&#160;to&#160;the&#160;<br/>current LocoNet&#160;slot&#160;number for&#160;the given&#160;loco address.&#160;<br/>
&#160;<br/>
<b>Figure&#160;9&#160;Example&#160;Sequence:&#160;LocoNet&#160;Dispatch&#160;per&#160;LAN-Client&#160;</b><br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
52/78&#160;<br/>
<hr/>
<a name=53></a><img src="docs/z21-53_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>
<i><b>9.5&#160;</b></i><br/>
<b>LAN_LOCONET_DETECTOR &#160;<i>&#160;</i></b><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.22.&#160;&#160;<br/></b>&#160;<br/>If LAN&#160;client&#160;application&#160;wants&#160;to&#160;support a&#160;LocoNet track&#160;occupancy&#160;detector, there are two&#160;ways. The&#160;<br/>first would&#160;be&#160;to receive&#160;the&#160;LocoNet packets&#160;vi<a href="z21.html#50">a&#160;<i><b>9.1&#160;</b>LAN_LOCONET_Z21_RX<b>&#160;</b></i></a>and process&#160;the&#160;<br/>corresponding&#160;LocoNet&#160;messages&#160;directly. However, this&#160;requires&#160;an exact knowledge&#160;of&#160;the&#160;LocoNet&#160;<br/>protocol&#160;and it would&#160;produce a&#160;lot&#160;of&#160;network&#160;traffic.&#160;&#160;<br/>&#160;<br/>Therefore&#160;the&#160;following alternative was&#160;created,&#160;with&#160;which&#160;you&#160;can&#160;<b>poll</b>&#160;the&#160;occupied&#160;status&#160;<b>as&#160;well as</b>&#160;<br/>be&#160;<b>asynchronously</b>&#160;<b>informed&#160;</b>about&#160;a change&#160;of&#160;the&#160;occupied status, without having&#160;to&#160;go into&#160;the&#160;<br/>depths&#160;of&#160;the&#160;LocoNet&#160;protocol.&#160;<br/>&#160;<br/><b>Information</b>: please&#160;note the&#160;following&#160;essential&#160;difference between&#160;the&#160;Roco Feedback&#160;Module&#160;10787&#160;<br/>on&#160;the R-BUS&#160;(see<a href="z21.html#45">&#160;<i><b>7&#160;</b></i>Feedback&#160;–&#160;R-BUS)</a>&#160;and&#160;LocoNet&#160;Track&#160;Occupancy&#160;Detectors:&#160;<br/>&#160;<br/>
•&#160;&#160;10787 is&#160;normally&#160;connected&#160;with&#160;mechanically&#160;operated&#160;switching contacts, which can&#160;be closed&#160;<br/>
and reopened&#160;per&#160;axis&#160;of&#160;the train running over&#160;it.&#160;<br/>
&#160;<br/>
•&#160;&#160;LocoNet&#160;track&#160;occupancy&#160;detectors&#160;are&#160;usually&#160;based&#160;on&#160;exact current measurement at the&#160;<br/>
monitored track&#160;section or&#160;on&#160;advanced&#160;technologies&#160;(transponder,&#160;infrared,&#160;RailCom,&#160;..)&#160;in&#160;order&#160;<br/>to&#160;reliably&#160;determine&#160;the&#160;occupancy&#160;state&#160;of&#160;the&#160;track.&#160;During normal&#160;operation,&#160;ideally&#160;only&#160;one&#160;<br/>message&#160;is&#160;generated&#160;when the&#160;occupied&#160;state&#160;changes.&#160;<br/>
&#160;<br/>The&#160;following&#160;command&#160;can be&#160;used&#160;to&#160;poll&#160;the status&#160;of&#160;one or&#160;more track&#160;occupancy&#160;detectors.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xA4</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>Type</b>&#160;8&#160;bit&#160;<br/>
16&#160;bits&#160;report&#160;address&#160;(<b>little&#160;endian</b>)&#160;<br/>
&#160;<br/>
<b>Type</b>&#160;<br/>
<b>0x80</b>&#160;&#160;&#160;Request via &#34;Stationary&#160;Interrogate&#160;Request&#34;&#160;(SIC)&#160;according&#160;to&#160;Digitrax&#160;<br/>
procedure.&#160;This&#160;procedure&#160;also&#160;can&#160;be&#160;used&#160;for the occupancy&#160;detectors&#160;from&#160;&#160;<br/>Blücher-Elektronik. The&#160;parameter&#160;“report address”&#160;is&#160;0 (not relevant).&#160;<br/>
<b>&#160;<br/>0x81</b>&#160;<br/>
Request&#160;via so-called&#160;<b>report&#160;address</b>&#160;for Uhlenbrock&#160;occupancy&#160;detector.&#160;<br/>This&#160;report&#160;address&#160;can&#160;be&#160;configured&#160;by&#160;the&#160;user&#160;e.g.&#160;UB63320 via&#160;LNCV&#160;17 in&#160;<br/>the&#160;occupancy&#160;detector. The default value&#160;there&#160;is&#160;1017.&#160;<br/>With type&#160;0x81,&#160;this&#160;report&#160;address&#160;is&#160;only&#160;used for&#160;polling and&#160;should&#160;<b>not&#160;be&#160;<br/>confused&#160;</b>with the<b>&#160;feedback address</b>.&#160;&#160;<br/><b>Note</b>: At&#160;the&#160;LocoNet&#160;bus&#160;this&#160;query&#160;is&#160;implemented via&#160;turnout&#160;switching&#160;<br/>commands, therefore&#160;the&#160;value according&#160;to LocoNet&#160;has&#160;to&#160;be&#160;decremented&#160;by&#160;<br/>1.&#160;Example:&#160;<br/>
<b>0x07 0x00 0xA4 0x00 0x81 0xF8 0x03&#160;</b><br/>
means: &#34;request status&#160;of&#160;all&#160;occupancy&#160;detectors&#160;with&#160;report address&#160;1017&#160;<br/>(Report address&#160;=&#160;1017&#160;=&#160;<b>0x03F8</b>&#160;+1&#160;=&#160;1016&#160;+&#160;1)&#34;&#160;<br/>
&#160;<br/>&#160;<br/>
&#160;<br/>
<b>0x82</b>&#160;<br/>
<b>Status&#160;request&#160;for&#160;LISSY,&#160;from Z21&#160;FW&#160;Version&#160;1.23&#160;<br/></b>On the&#160;other hand,&#160;for Uhlenbrock&#160;LISSY&#160;the report address&#160;corresponds&#160;to&#160;the&#160;<br/>feedback&#160;address&#160;however.&#160;The type&#160;of&#160;the&#160;subsequent feedback&#160;message(s)&#160;<br/>strongly&#160;depends&#160;on the configured&#160;operating mode&#160;of&#160;the&#160;LISSY&#160;receiver.&#160;In the&#160;<br/>LISSY&#160;manual&#160;you&#160;can find&#160;out&#160;more&#160;about&#160;the extensive setting options&#160;of&#160;the&#160;<br/>LISSY&#160;receiver.&#160;<br/>
&#160;<br/>Please note&#160;that&#160;in&#160;the&#160;case of&#160;a single&#160;request, several&#160;occupancy&#160;detectors&#160;may&#160;be&#160;addressed&#160;at the&#160;<br/>same time,&#160;and&#160;therefore&#160;multiple&#160;responses&#160;are to be&#160;expected.&#160;Depending on the manufacturer&#160;of&#160;the&#160;<br/>occupancy&#160;detector, the&#160;status&#160;of&#160;the same input&#160;can&#160;be&#160;also&#160;reported&#160;several&#160;times&#160;after&#160;one&#160;request.&#160;<br/>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
53/78&#160;<br/>
<hr/>
<a name=54></a><img src="docs/z21-54_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;<br/>&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x07&#160;+&#160;<i><b>n</b></i>&#160;<br/>
0x00<b>&#160;&#160;0xA4</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>Type</b>&#160;8&#160;bit<b>&#160;&#160;Feedback&#160;address&#160;</b>16&#160;bits&#160;(<b>little&#160;</b><br/>
<b>Info</b>[<i><b>n</b></i>]&#160;<br/>
<b>endian</b>)<b>&#160;</b><br/>
&#160;<br/>This&#160;message is&#160;asynchronously&#160;reported to the client&#160;by&#160;the Z21 when&#160;the&#160;client&#160;<br/>
•&#160;&#160;has&#160;activated&#160;the&#160;corresponding&#160;broadcast, see<a href="z21.html#16"><i><b>&#160;2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;<br/>
0x08000000&#160;<br/>
•&#160;&#160;and the&#160;Z21 has&#160;received a&#160;corresponding&#160;message from&#160;a&#160;track&#160;occupancy&#160;detector&#160;<b>due to&#160;a&#160;</b><br/>
<b>status&#160;change&#160;on&#160;its input</b>, or&#160;<b>due to&#160;an explicit&#160;status-request&#160;(polling)&#160;by&#160;a&#160;LAN client</b>&#160;<br/>using&#160;the&#160;commands&#160;described&#160;above.&#160;<br/>
&#160;<br/><b>Feedback&#160;address</b>&#160;<br/>
Each&#160;input&#160;of&#160;an&#160;occupancy&#160;detector&#160;has&#160;its&#160;own feedback&#160;address, which can&#160;&#160;<br/>be&#160;configured&#160;by&#160;the&#160;user (e.g. for Uhlenbrock&#160;and&#160;Blücher&#160;via LNCV),&#160;and&#160;which&#160;<br/>describes&#160;the monitored&#160;block&#160;with&#160;an&#160;unique&#160;address.&#160;<br/>&#160;<br/>
<b>Info[<i>n</i></b><b>]</b>&#160;&#160;&#160;<br/>
&#160;<br/>
Byte-Array;&#160;content&#160;and length&#160;<i><b>n</b></i>&#160;depending&#160;on&#160;<b>Type</b>,&#160;see&#160;below&#160;<br/>
&#160;<br/><b>Type</b>&#160;&#160;&#160;<br/>
<b>0x01</b>&#160;<br/>
For&#160;occupancy&#160;detector types&#160;like&#160;Uhlenbrock&#160;63320 or&#160;Blücher GBM16XL&#160;<br/>reporting&#160;only&#160;the&#160;status&#160;&#34;occupied&#34;&#160;and&#160;&#34;free&#34;&#160;(by&#160;using&#160;LocoNet&#160;<br/>OPC_INPUT_REP,&#160;X=1).&#160;&#160;<br/>&#160;<br/><i><b>n=1&#160;<br/></b></i>&#160;<br/>Status&#160;of&#160;the&#160;input&#160;belonging to the&#160;feedback&#160;address&#160;can&#160;be&#160;found&#160;in&#160;<b>Info[0]:&#160;<br/>Info[0]</b>=<b>0</b>&#160;...&#160;sensor is&#160;<b>LOW</b>&#160;(“free”)&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>Info[0]</b>=<b>1</b>&#160;...&#160;sensor is&#160;<b>HIGH</b>&#160;(“occupied”)&#160;<br/>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>0x02</b>&#160;<br/>
<b>Transponder&#160;Enters Block</b>&#160;<br/>
<b>0x03</b>&#160;<br/>
<b>Transponder&#160;Exits Block</b>&#160;<br/>For occupancy&#160;detectors&#160;such as&#160;Blücher GBM16<b>XN</b>&#160;etc. reporting&#160;also&#160;the&#160;<br/>information&#160;about&#160;the&#160;vehicle&#160;(e.g.&#160;locomotive address)&#160;inside&#160;the&#160;block&#160;to&#160;the&#160;<br/>command&#160;station&#160;(by&#160;using&#160;LocoNet&#160;OPC_MULTI_SENSE&#160;transponding&#160;<br/>encoding&#160;from&#160;Digitrax).&#160;<br/>In&#160;addition to&#160;the&#160;feedback&#160;address,&#160;also&#160;a&#160;so-called&#160;transponder&#160;address&#160;is&#160;<br/>transmitted.&#160;The&#160;<b>transponder&#160;address</b>&#160;identifies&#160;the&#160;vehicle&#160;in&#160;the&#160;block. In&#160;the&#160;<br/>case of the GBM16<b>XN</b>,&#160;this&#160;is&#160;the&#160;<b>locomotive&#160;address</b>&#160;which was&#160;determined&#160;by&#160;<br/>the&#160;occupancy&#160;detector&#160;by&#160;using&#160;RailCom.&#160;<br/><i><b>&#160;<br/>n=2&#160;</b></i><br/>
&#160;<br/>
The&#160;transponder address&#160;is&#160;located&#160;in&#160;<b>Info[0]</b>&#160;und&#160;<b>Info[1]</b>, 16&#160;Bit little endian:<b>&#160;<br/>Info[0]</b>&#160;...&#160;transponder&#160;address&#160;low&#160;byte<b>&#160;<br/>Info[1]</b>&#160;...&#160;transponder&#160;address&#160;high&#160;byte&#160;<br/>&#160;<br/>Remark: due&#160;to&#160;lack&#160;of&#160;specification&#160;inside&#160;the&#160;LocoNet spec, the value&#160;ranges&#160;in&#160;<br/>OPC_MULTI_SENSE&#160;is&#160;not&#160;quite clear,&#160;which&#160;leaves&#160;the&#160;manufacturers&#160;of&#160;the&#160;<br/>occupancy&#160;detectors&#160;sometimes&#160;in the&#160;dark.&#160;Therefore&#160;in the&#160;case&#160;of&#160;GBM16XN&#160;<br/>the&#160;following&#160;must&#160;be&#160;observed&#160;according&#160;to our&#160;experience:&#160;<br/>
o&#160;&#160;You&#160;have to add&#160;+1&#160;to&#160;the&#160;feedback&#160;address&#160;to&#160;get&#160;the&#160;feedback&#160;address&#160;<br/>
configured&#160;in GBM16<b>XN</b>.&#160;<br/>
o&#160;&#160;Depending&#160;on&#160;the&#160;configuration of&#160;the&#160;GBM16<b>XN</b>, the&#160;direction&#160;of&#160;the&#160;<br/>
vehicle&#160;on&#160;the&#160;track&#160;can&#160;also&#160;be&#160;coded&#160;in&#160;the&#160;bit under&#160;the&#160;mask&#160;0x1000.&#160;&#160;<br/>Such a&#160;configuration is&#160;not&#160;recommended because this&#160;bit collides&#160;with&#160;<br/>the&#160;address&#160;space&#160;of&#160;long&#160;locomotive addresses!&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
54/78&#160;<br/>
<hr/>
<a name=55></a><img src="docs/z21-55_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>0x10</b>&#160;<br/>
<b>LISSY&#160;Loco&#160;address&#160;from&#160;Z21&#160;FW&#160;1.23.&#160;</b>&#160;<br/>This&#160;message is&#160;sent&#160;to&#160;the&#160;Z21 LAN Client&#160;when an&#160;Uhlenbrock&#160;LISSY&#160;receiver&#160;<br/>reports&#160;a&#160;vehicle&#160;equipped&#160;with&#160;a LISSY&#160;transmitter&#160;and this&#160;LISSY&#160;receiver&#160;is&#160;<br/>configured to the&#160;&#34;Transfer&#160;format&#160;(ÜF)&#160;Uhlenbrock&#34;&#160;(LNCV&#160;15=1). Furthermore,&#160;<br/>this&#160;message&#160;strongly&#160;depends&#160;on&#160;the&#160;configured operating mode (LNCV2,&#160;...) of&#160;<br/>the LISSY&#160;receiver.&#160;&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
See&#160;also&#160;LISSY&#160;manual.&#160;<br/>
&#160;<br/>&#160;<br/>
&#160;<br/>
&#160;<br/>
<i><b>n=3&#160;</b></i><br/>
&#160;<br/>
The&#160;Loco&#160;address&#160;is&#160;located in&#160;<b>Info[0]</b>&#160;und&#160;<b>Info[1]</b>, 16&#160;Bit&#160;little&#160;endian:<b>&#160;<br/>Info[0]</b>&#160;...&#160;loco&#160;address&#160;low&#160;byte&#160;<br/><b>Info[1]</b>&#160;...&#160;loco&#160;address&#160;high&#160;byte&#160;<br/>Locomotives&#160;have a&#160;value range&#160;from&#160;1..9999&#160;<br/>Wagons&#160;have a&#160;value&#160;range from&#160;10000&#160;to 16382&#160;<br/><b>&#160;<br/>Info[2]</b>&#160;...&#160;Additional&#160;info&#160;according&#160;to&#160;following&#160;bits:&#160;0&#160;<b>DIR1</b>&#160;<b>DIR0</b>&#160;0&#160;<b>K3 K2 K1&#160;K0</b>&#160;<br/><b>DIR1</b>=0:&#160;<b>DIR0</b>&#160;is&#160;to&#160;be&#160;ignored&#160;<br/><b>DIR1</b>=1:&#160;<b>DIR0</b>=0&#160;is&#160;forwards, &#160;<b>DIR0</b>=1&#160;is&#160;backwards&#160;<br/><b>K3..K0</b>: 4&#160;bit&#160;“class&#160;information”&#160;stored&#160;in the&#160;LISSY&#160;sender.&#160;<br/>&#160;<br/>Example&#160;Configuration&#160;for&#160;Lissy&#160;Receiver 68610:&#160;<br/><b>LNCV&#160;</b><br/>
<b>Value&#160;</b><br/>
<b>Comment&#160;</b><br/>
2&#160;<br/>
98&#160;<br/>
optional&#160;module&#160;reset:&#160;sets&#160;all&#160;LNCV&#160;to 0,&#160;except&#160;LNCV&#160;0&#160;and&#160;<br/>1 (address)&#160;<br/>
2&#160;<br/>
0&#160;<br/>
Basic&#160;function:&#160;readout&#160;locomotive data&#160;and&#160;direction&#160;<br/>information&#160;by&#160;using&#160;double&#160;sensor&#160;<br/>
15&#160;<br/>
1&#160;<br/>
Send&#160;using&#160;“Transfer&#160;format&#160;(ÜF)&#160;Uhlenbrock”&#160;onto LocoNet&#160;<br/>
&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>0x11</b>&#160;<br/>
<b>LISSY&#160;block&#160;status from&#160;Z21&#160;FW&#160;1.23.&#160;&#160;<br/></b>This&#160;message is&#160;sent&#160;to&#160;the&#160;Z21 LAN Client&#160;when an&#160;Uhlenbrock&#160;LISSY&#160;receiver&#160;<br/>sends&#160;a&#160;block&#160;occupancy&#160;status&#160;message&#160;using&#160;the&#160;&#34;Transfer format&#160;(ÜF)&#160;<br/>Uhlenbrock&#34;. See&#160;also&#160;LISSY&#160;manual.&#160;<br/>&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
<i><b>n=1&#160;</b></i><br/>
&#160;<br/>
Status&#160;of&#160;the&#160;block&#160;belonging&#160;to&#160;the&#160;feedback&#160;address&#160;is&#160;in&#160;<b>Info[0]</b>:&#160;<br/><b>Info[0]</b>=<b>0</b>&#160;...&#160;block&#160;is&#160;free&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>Info[0]</b>=<b>1</b>&#160;...&#160;block&#160;is&#160;occupied&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>Example&#160;Configuration&#160;for&#160;Lissy&#160;Receiver&#160;68610:&#160;<br/><b>LNCV&#160;</b><br/>
<b>Value&#160;</b><br/>
<b>Comment&#160;</b><br/>
2&#160;<br/>
98&#160;<br/>
optional&#160;module&#160;reset:&#160;sets&#160;all&#160;LNCV&#160;to 0,&#160;except LNCV&#160;0&#160;and&#160;<br/>1 (address)&#160;<br/>
2&#160;<br/>
22&#160;<br/>
Automation&#160;function with&#160;block&#160;status&#160;message:&#160;&#160;<br/>Time-controlled&#160;waiting&#160;station<b>&#160;</b><br/>
3&#160;<br/>
2&#160;<br/>
Automation&#160;active&#160;in&#160;both driving&#160;directions&#160;<br/>
4&#160;<br/>
3&#160;<br/>
Wait time&#160;3 seconds&#160;<br/>
10&#160;<br/>
2&#160;<br/>
Block&#160;option:&#160;&#160;<br/>Block&#160;status&#160;change&#160;to &#34;free&#34;&#160;after 2&#160;seconds&#160;<br/>
15&#160;<br/>
1&#160;<br/>
Send&#160;using&#160;“transfer format&#160;(ÜF)&#160;Uhlenbrock”&#160;onto LocoNet&#160;<br/>
&#160;<br/>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
55/78&#160;<br/>
<hr/>
<a name=56></a><img src="docs/z21-56_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>&#160;<br/>
&#160;<br/>
<b>0x12</b>&#160;<br/>
<b>LISSY&#160;Speed&#160;from&#160;Z21&#160;FW&#160;1.23.&#160;</b>&#160;<br/>This&#160;message is&#160;sent&#160;to&#160;the&#160;Z21 LAN Client&#160;when a&#160;Uhlenbrock&#160;LISSY&#160;receiver&#160;is&#160;<br/>configured for speed measurement.&#160;<br/>See&#160;also&#160;LISSY&#160;manual.&#160;<br/>&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
<i><b>n=2&#160;</b></i><br/>
<i><b>&#160;</b></i><br/>
The&#160;speed is&#160;located&#160;in&#160;<b>Info[0]</b>&#160;and&#160;<b>Info[1]</b>, 16 bit&#160;little&#160;endian:&#160;&#160;&#160;<br/><b>Info[0]</b>&#160;...&#160;speed&#160;low&#160;byte<b>&#160;<br/>Info[1]</b>&#160;...&#160;speed&#160;high&#160;byte&#160;<br/>&#160;<br/>Example&#160;Configuration&#160;for&#160;Lissy&#160;Receiver 68610:&#160;<br/><b>LNCV&#160;</b><br/>
<b>Value&#160;</b><br/>
<b>Comment&#160;</b><br/>
2&#160;<br/>
98&#160;<br/>
optional&#160;module&#160;reset:&#160;sets&#160;all&#160;LNCV&#160;to 0,&#160;except LNCV&#160;0&#160;and&#160;<br/>1 (address)&#160;<br/>
2&#160;<br/>
0&#160;<br/>
Basic&#160;function:&#160;readout&#160;locomotive data&#160;and&#160;direction&#160;<br/>information&#160;by&#160;using&#160;double&#160;sensor&#160;<br/>
<b>14&#160;</b><br/>
<b>15660&#160;</b><br/>
<b>Velocity Scaling&#160;factor&#160;=&#160;&#160;<br/>1566&#160;(H0-scale)&#160;*&#160;10mm (sensor distance)&#160;</b><br/>
15&#160;<br/>
1&#160;<br/>
Send transfer format&#160;Uhlenbrock&#160;to&#160;LocoNet&#160;<br/>
&#160;<br/>
<i><b>&#160;<br/></b></i>&#160;<br/>Note:&#160;<b>Type</b>&#160;will&#160;be extended by&#160;further IDs&#160;in the future as&#160;required.&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
56/78&#160;<br/>
<hr/>
<a name=57></a><img src="docs/z21-57_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>
<b>10&#160;&#160;CAN&#160;</b><br/>
<i><b>10.1&#160;&#160;</b></i><b>LAN_CAN_DETECTOR &#160;<i>&#160;</i></b><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.30.&#160;&#160;<br/></b>&#160;<br/>The&#160;Roco&#160;CAN&#160;occupancy&#160;detector&#160;10808&#160;is&#160;supported from&#160;FW&#160;version 1.30&#160;on.&#160;The occupancy&#160;<br/>detector can be used&#160;by&#160;the LAN client&#160;in&#160;four&#160;different ways:&#160;<br/>&#160;<br/>
1.&#160;&#160;<b>R-BUS&#160;emulation:&#160;</b>the&#160;CAN detector is&#160;forwarded to&#160;the&#160;LAN client&#160;as&#160;R-BUS&#160;detector in&#160;the&#160;Z21&#160;<br/>
firmware.&#160;So the LAN client&#160;can&#160;use the&#160;CAN&#160;detector&#160;as&#160;described in&#160;Chapter&#160;7&#160;Feedback&#160;-&#160;R-<br/>BUS.&#160;<br/>&#160;<br/>
2.&#160;&#160;<b>LocoNet&#160;emulation</b>:&#160;the&#160;CAN detector&#160;is&#160;forwarded&#160;in&#160;the Z21 firmware&#160;as&#160;LocoNet detector to&#160;<br/>
the&#160;LAN client.&#160;Thus&#160;the&#160;LAN client&#160;can&#160;use the&#160;CAN&#160;detector&#160;as&#160;described&#160;in&#160;chapter<a href="z21.html#53">&#160;9.5&#160;<br/><i>LAN_LOCONET_DETECTOR</i>&#160;</a>(type&#160;0x01&#160;&#34;occupied/free&#34;&#160;and&#160;the&#160;locomotive&#160;address&#160;via type&#160;<br/>0x02&#160;and&#160;0x03 &#34;Transponder Enters&#160;Block, Transponder Exits&#160;Block&#34;).&#160;<br/>&#160;<br/>
3.&#160;&#160;<b>LISSY&#160;emulation</b>:&#160;The&#160;CAN&#160;detector is&#160;emulated in the Z21&#160;firmware by&#160;LISSY/Marco&#160;<br/>
messages. The LAN client&#160;can&#160;use the&#160;CAN&#160;detector as&#160;described in chapter&#160;&#160;<br/><a href="z21.html#53">9.5&#160;<i>LAN_LOCONET_DETECTOR</i>&#160;</a>(type&#160;0x10&#160;&#34;Locomotive address&#34;&#160;and type 0x11&#160;&#34;block&#160;<br/>status&#34;).&#160;<br/>&#160;<br/>
4.&#160;&#160;Direct access&#160;by&#160;the command&#160;LAN_CAN_DETECTOR (see&#160;below).&#160;<br/>
&#160;<br/>The&#160;type&#160;of&#160;emulation&#160;can&#160;be&#160;configured via the Z21&#160;Maintenance Tool. The&#160;factory&#160;setting&#160;is:&#160;&#160;<br/><b>R-BUS&#160;emulation=on</b>,&#160;<b>LocoNet&#160;emulation=on</b>,&#160;<i>LISSY&#160;emulation=off</i>.&#160;<br/>&#160;<br/>However, the&#160;fastest&#160;method,&#160;however, and&#160;the&#160;one&#160;that&#160;is&#160;most&#160;economic&#160;concerning&#160;memory&#160;and&#160;<br/>bandwidth,&#160;is&#160;direct access&#160;using&#160;the&#160;command&#160;<b>LAN_CAN_DETECTOR&#160;0xC4</b>. This&#160;is&#160;particularly&#160;<br/>recommended&#160;when&#160;a large number&#160;of&#160;CAN occupancy&#160;detectors&#160;are used at&#160;the same&#160;time.&#160;With the&#160;<br/>following&#160;command, the status&#160;of&#160;the CAN occupancy&#160;detectors&#160;can&#160;be&#160;polled:&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xC4</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>Type</b>&#160;8&#160;bit&#160;<br/>
<b>CAN-NetworkID</b>&#160;16&#160;bit&#160;(little endian)&#160;<br/>
&#160;<br/>
<b>Type</b>&#160;<br/>
<b>0x00</b>&#160;&#160;&#160;Request&#160;the&#160;CAN&#160;occupancy&#160;detector with&#160;the&#160;given&#160;CAN&#160;network&#160;ID.&#160;<br/>
The&#160;CAN NetworkID&#160;<b>0xD000</b>&#160;means&#160;&#34;<b>all&#160;CAN detectors</b>&#34;.&#160;<br/>Example:<b>&#160;</b><br/>
<b>&#160;</b><br/>
<b>&#160;</b><br/>
<b>&#160;</b><br/>
<b>0x07 0x00 0xC4 0x00 0x00&#160;0x00&#160;0xD0</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
means: &#34;poll&#160;status&#160;of&#160;all&#160;CAN occupancy&#160;detectors&#34;&#160;<br/>&#160;<br/>
Please note&#160;that&#160;with a&#160;single request several&#160;CAN&#160;occupancy&#160;detectors&#160;are&#160;addressed&#160;at&#160;the same&#160;time,&#160;<br/>and therefore&#160;multiple&#160;responses&#160;are to be expected.&#160;Depending&#160;on the&#160;configuration of&#160;the&#160;emulation,&#160;<br/>the&#160;status&#160;of&#160;one&#160;and&#160;the&#160;same&#160;input&#160;can also be&#160;reported&#160;several&#160;times.<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
57/78&#160;<br/>
<hr/>
<a name=58></a><img src="docs/z21-58_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;<br/>&#160;<br/>Z21&#160;to&#160;Client:&#160;&#160;<br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x0E&#160;<br/>
0x00<b>&#160;&#160;0xC4</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>NId</b>&#160;&#160;<br/>
<b>Addr&#160;</b><br/>
<b>Port&#160;</b><br/>
<b>Type&#160;</b><br/>
<b>Value1&#160;</b><br/>
<b>Value2&#160;</b><br/>
16&#160;bit<b>&#160;</b><br/>
16&#160;bit&#160;<b>&#160;</b><br/>
8 bit<b>&#160;</b><br/>
8 bit<b>&#160;</b><br/>
16&#160;bit<b>&#160;</b><br/>
16 bit<b>&#160;</b><br/>
&#160;<br/>This&#160;message is&#160;also&#160;reported&#160;to&#160;the&#160;client&#160;by&#160;the Z21&#160;asynchronously&#160;when&#160;the&#160;client&#160;<br/>
•&#160;&#160;Has&#160;activated&#160;the&#160;corresponding&#160;broadcast, se<a href="z21.html#16">e&#160;<i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,</i></a><i>&#160;&#160;</i><br/>
Flag&#160;0x00080000&#160;<br/>
•&#160;&#160;and the&#160;Z21 has&#160;received a&#160;corresponding&#160;message from&#160;the CAN detector,&#160;due to a&#160;<b>status&#160;</b><br/>
<b>change at&#160;its&#160;input</b>,&#160;<b>OR</b>&#160;due to&#160;an&#160;<b>explicit&#160;polling&#160;by&#160;a LAN client</b>&#160;using&#160;commands&#160;described&#160;<br/>above.&#160;<br/>&#160;<br/>
All&#160;16&#160;bit values&#160;are&#160;little endian coded.&#160;<br/>&#160;<br/><b>NId&#160;</b><br/>
<b>&#160;</b><br/>
&#160;<br/>
Unchangeable CAN network&#160;ID of the occupancy&#160;detector.&#160;&#160;<br/>
<b>&#160;<br/>Addr&#160;</b><br/>
<b>&#160;</b><br/>
&#160;<br/>
Configurable module&#160;address&#160;of&#160;the&#160;occupancy&#160;detector. Each&#160;CAN&#160;occupancy&#160;&#160;<br/>detector&#160;has&#160;a&#160;module address&#160;which can&#160;be&#160;set&#160;by&#160;the user.&#160;<br/>&#160;<br/>
<b>Port</b>&#160;<br/>
&#160;<br/>
&#160;<br/>
Input&#160;pin number&#160;of&#160;the&#160;CAN occupancy&#160;detector&#160;(0&#160;to&#160;7)&#160;<br/>
&#160;&#160;<br/><b>Type</b>&#160;&#160;&#160;<br/>
<b>0x01</b>&#160;<br/>
<b>Occupancy&#160;status&#160;</b>of input&#160;(free, busy, overload)&#160;<br/>
&#160;<br/>&#160;<br/>
&#160;<br/>
<b>0x11</b>&#160;<br/>
1st&#160;and&#160;2nd&#160;recognized&#160;<b>locomotive&#160;address</b>&#160;at&#160;the&#160;entrance&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>0x12</b>&#160;<br/>
3rd&#160;and 4th&#160;recognized&#160;<b>locomotive&#160;address</b>&#160;at the&#160;entrance&#160;<br/>
&#160;<br/>
&#160;<br/>
…&#160;&#160;<br/>
&#160;<br/>
&#160;<br/>
<b>0x1F</b>&#160;<br/>
29th&#160;and&#160;30th.&#160;recognized&#160;<b>locomotive&#160;address</b>&#160;at&#160;the&#160;entrance&#160;<br/>
&#160;<br/>The&#160;value&#160;of Value1&#160;and Value2&#160;depends&#160;on the type.&#160;<br/>&#160;<br/><b>If&#160;Type&#160;=&#160;0x01&#160;(occupied&#160;status):&#160;</b><br/>
<b>&#160;</b><br/>
<b>&#160;</b><br/>
<b>Value1</b>&#160;&#160;<br/>
<b>0x0000</b>&#160;&#160;<br/>
<b>Free, without&#160;voltage&#160;</b><br/>
<b>&#160;</b><br/>
<b>&#160;</b><br/>
<b>0x0100&#160;&#160;</b><br/>
<b>Free,&#160;with&#160;voltage&#160;</b><br/>
<b>&#160;</b><br/>
<b>&#160;</b><br/>
<b>0x1000&#160;&#160;</b><br/>
<b>Occupied,&#160;without&#160;voltage&#160;</b><br/>
<b>0x1100&#160;&#160;</b><br/>
<b>Occupied,&#160;with&#160;voltage&#160;</b><br/>
<b>0x1201&#160;&#160;</b><br/>
<b>Occupied,&#160;Overload&#160;1&#160;</b><br/>
<b>0x1202&#160;&#160;</b><br/>
<b>Occupied,&#160;Overload&#160;2</b>&#160;<br/>
<b>0x1203&#160;&#160;</b><br/>
<b>Occupied,&#160;Overload&#160;3</b>&#160;<br/>
&#160;<br/>
<b>If&#160;Type&#160;=&#160;0x11&#160;to&#160;0x1F&#160;(RailCom&#160;Loco&#160;address):&#160;</b><br/>
<b>&#160;</b><br/>
<b>&#160;</b><br/>
Type&#160;0x11&#160;to&#160;0x1F&#160;form&#160;a list of locomotive addresses.&#160;&#160;<br/>This&#160;vehicle&#160;list&#160;ends&#160;with&#160;the&#160;locomotive&#160;address=0.&#160;<br/><b>Value1</b>&#160;<br/>
&#160;First detected&#160;locomotive&#160;address&#160;in section&#160;incl. direction&#160;information.&#160;<br/>0 =&#160;no&#160;locomotive address&#160;detected (e.g. with&#160;decoder not&#160;capable&#160;of&#160;RailCom, or&#160;no&#160;<br/>locomotive),&#160;resp.&#160;end&#160;of locomotive&#160;address&#160;list&#160;<br/>
<b>Value2</b>&#160;<br/>
Second detected locomotive address&#160;in section&#160;incl. direction&#160;information.&#160;<br/>0 =&#160;no&#160;locomotive address&#160;detected,&#160;resp.&#160;end of&#160;locomotive&#160;address&#160;list&#160;<br/>
<b>&#160;<br/></b>The&#160;direction information&#160;is&#160;coded&#160;in&#160;the&#160;most significant&#160;two&#160;bits&#160;of&#160;Value1&#160;resp.&#160;Value2:&#160;<br/>0&#160;x&#160;&#160;<br/>
No direction detected&#160;<br/>
1 0&#160;&#160;<br/>
Vehicle&#160;has&#160;been&#160;placed&#160;forward on&#160;the&#160;track&#160;<br/>
1 1&#160;&#160;<br/>
Vehicle&#160;has&#160;been&#160;placed&#160;backwards&#160;on&#160;the&#160;track&#160;<br/>
The&#160;lower&#160;14 bits&#160;contain the locomotive address.&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
58/78&#160;<br/>
<hr/>
<a name=59></a><img src="docs/z21-59_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>
<i><b>10.2&#160;&#160;</b></i><b>CAN&#160;Booster&#160;<i>&#160;</i></b><br/>
&#160;<br/><b>From&#160;Z21&#160;FW&#160;Version&#160;1.41.&#160;&#160;<br/></b>&#160;<br/>CAN&#160;Booster Management&#160;with&#160;Roco&#160;CAN&#160;booster&#160;10806,&#160;10807&#160;and&#160;10869&#160;are&#160;supported from Z21&#160;FW&#160;<br/>version&#160;1.41&#160;on.&#160;Of&#160;course&#160;the&#160;following&#160;LAN&#160;command&#160;work&#160;only,&#160;if&#160;these boosters&#160;are connected&#160;to&#160;the&#160;<br/>Z21&#160;with&#160;the&#160;CAN-Bus&#160;(and&#160;not&#160;with&#160;B-BUS).&#160;<br/>
<b>10.2.1&#160;&#160;LAN_CAN_DEVICE_GET_DESCRIPTION&#160;</b><br/>
&#160;<br/>Read&#160;the&#160;name from&#160;the&#160;booster.&#160;<br/>&#160;<br/>The&#160;user can&#160;store a&#160;name&#160;(free&#160;text)&#160;in the booster so&#160;that&#160;he&#160;can&#160;later&#160;identify&#160;the device&#160;more&#160;easily.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x06&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xC8</b>&#160;<br/>
0x00&#160;<br/>
<b>NId</b>&#160;16&#160;bit&#160;<br/>
&#160;<br/><b>NId&#160;</b>is&#160;the&#160;CAN-NetworkID&#160;of&#160;the&#160;addressed&#160;booster&#160;(16 bit&#160;little endian,&#160;0xC101&#160;to&#160;0xC1FF).&#160;<br/>See&#160;also&#160;below<a href="z21.html#60">&#160;<i><b>10.2.3</b></i>&#160;LAN_CAN_BOOSTER_SYSTEMSTATE_CHGD.</a>&#160;<br/>&#160;<br/>Z21&#160;to&#160;Client:&#160;&#160;<br/>
<i>&#160;</i><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x16&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xC8</b>&#160;<br/>
0x00&#160;<br/>
<b>NId</b>&#160;16&#160;bit<b>&#160;</b><br/>
UINT8&#160;<b>Name</b>[16]&#160;&#160;<br/>
&#160;<br/><b>Name</b>&#160;corresponds&#160;to&#160;the&#160;stored&#160;designation&#160;as&#160;a&#160;null-terminated string.&#160;The string should&#160;be&#160;encoded&#160;<br/>according&#160;to&#160;<b>ISO&#160;8859-1</b>&#160;(<i>Latin-1</i>).&#160;<br/><b>&#160;<br/>Hint</b>:&#160;do&#160;not request two&#160;LAN_CAN_BOOSTER_GET_DESCRIPTION&#160;directly&#160;one&#160;after another.&#160;Instead&#160;<br/>wait&#160;for the reply&#160;to&#160;the&#160;first request,&#160;and&#160;then send the&#160;second request.&#160;&#160;<br/><b>&#160;<br/>Hint:</b>&#160;Wit<a href="z21.html#60">h&#160;<i><b>10.2.3&#160;</b></i>LAN_CAN_BOOSTER_SYSTEMSTATE_CHGD&#160;</a>NetworkIDs&#160;of&#160;all&#160;CAN&#160;boosters&#160;<br/>connected in the system.&#160;<br/>&#160;<br/>
<b>10.2.2&#160;&#160;LAN_CAN_DEVICE_SET_DESCRIPTION&#160;</b><br/>
&#160;<br/>Overwrite the name&#160;in&#160;the&#160;booster.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x16&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xC9</b>&#160;<br/>
0x00&#160;<br/>
<b>NId</b>&#160;16&#160;bit<b>&#160;</b><br/>
UINT8&#160;<b>Name</b>[16]&#160;<br/>
&#160;<br/><b>NId&#160;</b>is&#160;the&#160;CAN-NetworkID&#160;of&#160;the&#160;addressed&#160;booster&#160;(16 bit&#160;little endian,&#160;0xC101&#160;to&#160;0xC1FF).&#160;<br/>See&#160;also&#160;below<a href="z21.html#60">&#160;<i><b>10.2.3</b></i>&#160;LAN_CAN_BOOSTER_SYSTEMSTATE_CHGD.</a>&#160;<br/><b>&#160;<br/>Name</b>&#160;corresponds&#160;to&#160;the&#160;stored&#160;designation&#160;as&#160;a&#160;null-terminated string.&#160;The string should&#160;be&#160;encoded&#160;<br/>according&#160;to&#160;<b>ISO&#160;8859-1</b>&#160;&#160;(<i>Latin-1</i>). Fill&#160;the&#160;rest of&#160;data&#160;with&#160;0x00.&#160;&#160;&#160;<br/><b>Not&#160;allowed&#160;characters&#160;are the quotation&#160;mark &#34;&#160;(0x22) and&#160;the backslash&#160;\&#160;(0x5C)</b>.&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;&#160;<br/>None&#160;<br/><b>&#160;</b><br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
59/78&#160;<br/>
<hr/>
<a name=60></a><img src="docs/z21-60_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>10.2.3&#160;&#160;LAN_CAN_BOOSTER_SYSTEMSTATE_CHGD&#160;</b><br/>
&#160;<br/>Report the&#160;system&#160;status&#160;of&#160;the CAN&#160;booster&#160;to&#160;the&#160;client.&#160;This&#160;message comes&#160;about once per second&#160;<br/>per&#160;CAN booster and booster output.&#160;<br/>&#160;<br/>This&#160;message is&#160;reported asynchronously&#160;from the control&#160;panel&#160;to&#160;the client&#160;if&#160;it&#160;<br/>
•&#160;&#160;has&#160;activated&#160;the&#160;corresponding&#160;broadcast,&#160;&#160;<br/>
see<a href="z21.html#16">&#160;<i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;0x00020000&#160;<br/>
•&#160;&#160;and&#160;at&#160;least one&#160;booster&#160;is&#160;connected to&#160;the&#160;control&#160;panel&#160;via CAN.&#160;<br/>
&#160;&#160;<br/>Z21&#160;to&#160;Client:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x0E&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xCA</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>CANBoosterSystemState</b>&#160;(10&#160;Bytes)&#160;<br/>
&#160;<br/><b>CANBoosterSystemState</b>&#160;is&#160;structured as&#160;follows&#160;(the&#160;16-bit values&#160;are&#160;little endian):<b>&#160;</b><br/>
<b>Byte Offset&#160;</b><br/>
<b>Typ&#160;</b><br/>
<b>Name&#160;</b><br/>
<b>Wert&#160;</b><br/>
<b>&#160;</b><br/>
0&#160;<br/>
UINT16&#160;&#160;<b>NId</b>&#160;<br/>
0xC101&#160;&#160;<b>CAN-NetworkID</b>&#160;of&#160;the&#160;booster&#160;<br/>…&#160;<br/>0xC1FF&#160;<br/>
2&#160;<br/>
UINT16&#160;&#160;Booster_OutputPort&#160;<br/>
1&#160;<br/>
1st&#160;track&#160;output&#160;<br/>
2&#160;<br/>
2nd&#160;track&#160;output&#160;(10807&#160;only)&#160;<br/>
4&#160;<br/>
UINT16&#160;&#160;Booster_State&#160;<br/>
bitmask&#160;&#160;see&#160;below&#160;<br/>
6&#160;<br/>
UINT16&#160;&#160;Booster_VCCVoltage&#160;<br/>
mV&#160;<br/>
voltage&#160;track&#160;output&#160;&#160;<br/>
8&#160;<br/>
UINT16&#160;&#160;Booster_Current&#160;<br/>
mA&#160;<br/>
current&#160;track&#160;output&#160;<br/>
&#160;<br/>Bitmasks&#160;for&#160;<b>Booster_State</b>:&#160;<br/>#define&#160;bsBgActive&#160;&#160;&#160;<br/>
&#160;<br/>
&#160;<br/>
0x0001&#160;//&#160;brake generator&#160;active&#160;(ZCAN&#160;SSP)&#160;<br/>
#define&#160;bsShortCircuit&#160;<br/>
&#160;<br/>
&#160;<br/>
0x0020&#160;//&#160;short circuit&#160;on track&#160;(ZCAN&#160;UES)&#160;<br/>
#define&#160;bsTrackVoltageOff&#160;&#160;&#160;<br/>
&#160;<br/>
0x0080&#160;//&#160;track is switched off&#160;(OFF)&#160;<br/>
#define&#160;bsRailComActive&#160;<br/>
&#160;<br/>
&#160;<br/>
0x0800&#160;//&#160;RailCom-Cutout&#160;active&#160;<br/>
<b>From&#160;Booster&#160;FW&#160;Version&#160;V1.11</b>&#160;(Booster&#160;Manangement)<b>:&#160;<br/></b>#define bsOutputDisabled&#160;&#160;&#160;<br/>
&#160;<br/>
0x0100&#160;//&#160;track is&#160;deactivated&#160;(by user)&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
60/78&#160;<br/>
<hr/>
<a name=61></a><img src="docs/z21-61_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>10.2.4&#160;&#160;LAN_CAN_BOOSTER_SET_TRACKPOWER&#160;</b><br/>
&#160;<br/>Booster&#160;Management&#160;by&#160;user:&#160;deactivate&#160;and reactivate&#160;CAN&#160;Booster&#160;track&#160;outputs.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xCB</b>&#160;<br/>
0x00&#160;<br/>
<b>NId</b>&#160;16&#160;bit<b>&#160;</b><br/>
<b>Power&#160;</b>8&#160;bit&#160;<br/>
&#160;<br/><b>NId&#160;</b>is&#160;the&#160;CAN-NetworkID&#160;of&#160;the&#160;addressed&#160;booster&#160;(16 bit&#160;little endian,&#160;0xC101&#160;to&#160;0xC1FF).&#160;<br/>See&#160;also&#160;below<a href="z21.html#60">&#160;<i><b>10.2.3</b></i>&#160;LAN_CAN_BOOSTER_SYSTEMSTATE_CHGD.</a>&#160;<br/><b>&#160;<br/>Power&#160;&#160;</b>&#160;&#160;<br/>
0x00&#160;…&#160;deactivate&#160;all&#160;booster track&#160;outputs&#160;<br/>
&#160;<br/>
&#160;<br/>
0xFF&#160;…&#160;reactivate&#160;all&#160;booster track&#160;outputs&#160;&#160;<br/>
&#160;<br/>
&#160;<br/>
Additionally,&#160;<b>from&#160;Z21&#160;FW&#160;Version&#160;V1.42</b>&#160;and&#160;<b>Booster&#160;FW&#160;Version&#160;V1.11</b>:&#160;<br/>
&#160;<br/>
&#160;<br/>
0x10&#160;…&#160;deactivate&#160;1st&#160;booster&#160;track&#160;output&#160;<br/>
&#160;<br/>
&#160;<br/>
0x11&#160;…&#160;reactivate&#160;1st&#160;booster track&#160;output&#160;<br/>
&#160;<br/>
&#160;<br/>
0x20&#160;…&#160;deactivate&#160;2nd&#160;booster track&#160;output&#160;(Z21&#160;dual&#160;BOOSTER)&#160;<br/>
&#160;<br/>
&#160;<br/>
0x22&#160;…&#160;reactivate&#160;2nd&#160;booster track&#160;output&#160;(Z21&#160;dual&#160;BOOSTER)&#160;<br/>
&#160;<br/><b>Hint:</b>&#160;The&#160;booster track&#160;outputs&#160;can&#160;only&#160;be&#160;switched&#160;on&#160;again if the&#160;Z21&#160;is&#160;also switched on&#160;and&#160;is&#160;<br/>sending&#160;a&#160;valid track&#160;signal&#160;to&#160;the CAN boosters.&#160;<br/>The&#160;settings&#160;of the booster&#160;management&#160;are&#160;not saved&#160;persistently.&#160;<br/>&#160;<br/>Reply&#160;from&#160;Z21:&#160;&#160;<br/>On change of&#160;the&#160;CANBoosterSystemState<a href="z21.html#60">&#160;<i><b>10.2.3&#160;</b></i>LAN_CAN_BOOSTER_SYSTEMSTATE_CHGD&#160;</a>to&#160;<br/>subscribed clients.&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
61/78&#160;<br/>
<hr/>
<a name=62></a><img src="docs/z21-62_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>
<b>11&#160;&#160;zLink&#160;<br/></b>&#160;<br/>The&#160;<b>zLink interface,</b>&#160;introduced&#160;for&#160;the&#160;first time&#160;with&#160;Z21&#160;single BOOSTER,&#160;also&#160;allows&#160;devices&#160;with&#160;<br/>smaller microcontrollers&#160;(without&#160;own&#160;LAN or&#160;Wi-Fi&#160;hardware&#160;interface)&#160;to&#160;be&#160;integrated&#160;into&#160;the&#160;network&#160;<br/>of&#160;the user.&#160;<br/>&#160;<br/>Terminal&#160;devices&#160;with&#160;zLink&#160;interface are&#160;(01/2021):&#160;<br/>
•&#160;&#160;10806 Z21 single&#160;BOOSTER&#160;<br/>
•&#160;&#160;10807 Z21 dual&#160;BOOSTER&#160;<br/>•&#160;&#160;10869&#160;Z21&#160;XL&#160;BOOSTER&#160;<br/>
•&#160;&#160;10836&#160;Z21 switch&#160;DECODER&#160;<br/>•&#160;&#160;10837 Z21 signal&#160;DECODER&#160;<br/>
&#160;<br/>
<i><b>11.1&#160;&#160;Adapter&#160;&#160;</b></i><br/>
&#160;<br/>An adapter can&#160;be&#160;connected&#160;to&#160;the&#160;zLink&#160;interface of&#160;the&#160;terminal&#160;devices&#160;mentioned&#160;above,&#160;via which&#160;<br/>the&#160;terminal&#160;device&#160;can&#160;communicate with&#160;the&#160;outside&#160;world.&#160;&#160;<br/>One&#160;such adapter is&#160;the&#160;<b>10838</b>&#160;<b>Z21&#160;pro&#160;LINK</b>.&#160;<br/>
<b>11.1.1&#160;&#160;10838 Z21&#160;pro&#160;LINK&#160;</b><br/>
&#160;<br/>The&#160;<b>10838 Z21&#160;pro&#160;LINK</b>&#160;connects&#160;the&#160;<b>zLink interface to&#160;the&#160;Wi-Fi</b>&#160;as&#160;a&#160;<b>gateway</b>&#160;and can&#160;thus&#160;be used&#160;<br/>for the&#160;following tasks:&#160;<br/>
1.&#160;&#160;<b>Configuring</b>&#160;the&#160;terminal&#160;device (buttons&#160;&amp;&#160;display, Z21&#160;App, Z21&#160;Maintenance&#160;Tool&#160;on&#160;PC)&#160;<br/>2.&#160;&#160;<b>Firmware update</b>&#160;of the&#160;terminal&#160;device (Z21 Updater&#160;App,&#160;Z21&#160;Maintenance Tool&#160;on&#160;PC)&#160;<br/>3.&#160;&#160;Controlling&#160;the&#160;terminal&#160;device by&#160;Wi-Fi&#160;clients&#160;using&#160;the&#160;<b>Z21&#160;LAN protocol</b>&#160;<br/>
&#160;<br/>The&#160;latter&#160;point&#160;3&#160;was&#160;initially&#160;intended&#160;as&#160;a&#160;test&#160;interface,&#160;but&#160;it soon&#160;became clear&#160;that&#160;this&#160;would open&#160;<br/>up promising&#160;possibilities&#160;for&#160;decentralized&#160;layouts&#160;connected&#160;via&#160;Wi-Fi.&#160;From&#160;a technical&#160;point&#160;of&#160;view,&#160;it&#160;<br/>means&#160;that&#160;a&#160;small&#160;Z21&#160;protocol&#160;stack&#160;is&#160;implemented&#160;inside&#160;the&#160;terminal&#160;device.&#160;However,&#160;that&#160;reduced&#160;<br/>Z21&#160;protocol&#160;stack&#160;had to&#160;be&#160;tailored&#160;to&#160;the&#160;purpose&#160;of&#160;the&#160;terminal&#160;device&#160;due&#160;to&#160;limited memory.&#160;See&#160;<br/>als<a href="z21.html#76">o&#160;<i>Table&#160;1:&#160;Messages&#160;from&#160;Client&#160;to&#160;Z21&#160;</i></a>and<a href="z21.html#77"><i>&#160;Table&#160;2: Messages&#160;from Z21&#160;to Clients</i>.</a>&#160;As&#160;usual,&#160;<br/>commands&#160;can&#160;now&#160;be&#160;sent to&#160;the&#160;terminal&#160;device&#160;using&#160;UDP&#160;via the&#160;Wi-Fi&#160;/ zLink&#160;gateway&#160;-&#160;just&#160;like&#160;to&#160;a&#160;<br/>Z21. For&#160;example,&#160;the&#160;track&#160;outputs&#160;of&#160;a booster can&#160;be switched on and off via&#160;the WLAN&#160;/ zLink&#160;<br/>gateway, or&#160;the booster system&#160;status&#160;can&#160;be queried.&#160;Turnouts&#160;can&#160;also&#160;be&#160;switched&#160;on the&#160;Z21 switch&#160;<br/>DECODER&#160;directly,&#160;and signals&#160;can&#160;be&#160;controlled&#160;on the Z21&#160;signal&#160;DECODER,&#160;even&#160;without any&#160;<br/>connection&#160;to the main track&#160;of&#160;the&#160;DCC&#160;control&#160;center.&#160;The&#160;decoders&#160;can&#160;even&#160;be configured&#160;via&#160;the&#160;<br/>zLink&#160;interface&#160;by&#160;using&#160;LAN&#160;commands&#160;for writing&#160;CVs.&#160;<br/>&#160;<br/>An attempt was&#160;made&#160;to&#160;make&#160;it&#160;as&#160;transparent&#160;as&#160;possible for the&#160;Wi-Fi&#160;client,&#160;whether it&#160;is&#160;<br/>communicating&#160;with a&#160;control&#160;center or&#160;with&#160;a terminal&#160;device via the Wi-Fi&#160;/&#160;zLink&#160;gateway.&#160;However,&#160;<br/>regarding&#160;the&#160;very&#160;small&#160;CPU in the end&#160;device,&#160;following&#160;points&#160;should be&#160;considered:&#160;<br/>
•&#160;&#160;Restricted&#160;bandwidth:&#160;the&#160;effective transfer rate&#160;should&#160;remain well&#160;below 1024&#160;bytes/s&#160;per&#160;<br/>
terminal&#160;device.&#160;With&#160;the&#160;devices&#160;currently&#160;available,&#160;more would neither&#160;be necessary&#160;nor&#160;<br/>reasonable.&#160;<br/>
•&#160;&#160;Give the&#160;end device enough time&#160;to process&#160;the commands&#160;and&#160;data.&#160;Therefore, keep&#160;a pause&#160;of&#160;<br/>
at&#160;least 50&#160;ms&#160;between&#160;two&#160;requests.&#160;<br/>
•&#160;&#160;Use Z21&#160;pro LINK&#160;preferably&#160;in client&#160;mode.&#160;<br/>•&#160;&#160;If possible,&#160;connect only&#160;one Wi-Fi&#160;client&#160;to&#160;a&#160;Z21&#160;pro&#160;LINK,&#160;max.&#160;4 clients&#160;allowed.&#160;<br/>
&#160;<br/>Operation&#160;via UPD broadcasts&#160;is&#160;possible,&#160;but&#160;it is&#160;recommended&#160;to&#160;only&#160;do&#160;so&#160;for&#160;searching&#160;the&#160;devices&#160;<br/>in the&#160;network&#160;(see&#160;below).&#160;The&#160;terminal&#160;devices&#160;can&#160;then&#160;be clearly&#160;identified&#160;by&#160;their&#160;hardware type&#160;<br/>(LAN_GET_HWINFO)&#160;and&#160;serial&#160;number&#160;(LAN_GET_SERIAL_NUMBER),&#160;as&#160;well&#160;as&#160;by&#160;the&#160;IP&#160;address&#160;of&#160;<br/>the&#160;respective Z21&#160;pro&#160;LINK. In&#160;addition,&#160;the user can&#160;store a&#160;name&#160;(free&#160;text)&#160;in&#160;each&#160;terminal&#160;device,&#160;<br/>which can also be&#160;displayed&#160;in&#160;the&#160;user interface.&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
62/78&#160;<br/>
<hr/>
<a name=63></a><img src="docs/z21-63_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>LAN_ZLINK_GET_HW_INFO&#160;is&#160;an&#160;example for a&#160;command&#160;that the&#160;Z21&#160;pro&#160;LINK&#160;does&#160;not&#160;forward&#160;to&#160;its&#160;<br/>terminal&#160;device, but&#160;rather&#160;processes&#160;and&#160;answers&#160;the&#160;request&#160;itself.&#160;<br/>&#160;<br/><b>11.1.1.1&#160;&#160;LAN_ZLINK_GET_HWINFO&#160;<br/></b>&#160;<br/>This&#160;command can&#160;be&#160;used to&#160;query&#160;the properties&#160;of&#160;the&#160;Z21 pro&#160;LINK.&#160;<br/>&#160;<br/>If this&#160;command&#160;is&#160;sent&#160;as&#160;a UDP&#160;broadcast, it is&#160;possible&#160;to&#160;use the&#160;responses&#160;to&#160;discover&#160;the&#160;Z21&#160;pro&#160;<br/>LINKs&#160;registered in the&#160;Wi-Fi&#160;network&#160;and&#160;then&#160;manage&#160;a&#160;list with&#160;their&#160;respective&#160;MAC&#160;address&#160;and&#160;<br/>assigned IP&#160;address.&#160;<br/>&#160;<br/>Request&#160;to&#160;Z21 pro&#160;LINK&#160;:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x05&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xE8</b>&#160;<br/>
0x00&#160;<br/>
<b>0x06&#160;</b><br/>
&#160;<br/>Data[0]&#160;=&#160;<b>0x06</b>&#160;=&#160;ZLINK_MSG_TYPE_HW_INFO&#160;<br/>&#160;<br/>&#160;<br/>Reply&#160;from&#160;Z21 pro&#160;LINK:&#160;&#160;<br/>
<i>&#160;</i><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x3F&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xE8</b>&#160;<br/>
0x00&#160;<br/>
<b>0x06&#160;&#160;Z_Hw_Info</b>&#160;(58&#160;Bytes)&#160;<br/>
<b>&#160;<br/></b>Data[0]&#160;=&#160;<b>0x06</b>&#160;=&#160;ZLINK_MSG_TYPE_HW_INFO&#160;<br/><b>&#160;<br/>Z_Hw_Info</b>&#160;is&#160;structured&#160;as&#160;follows&#160;(the 16-bit&#160;values&#160;are little&#160;endian):<b>&#160;</b><br/>
<b>Byte Offset&#160;</b><br/>
<b>Type&#160;</b><br/>
<b>Name&#160;</b><br/>
<b>&#160;</b><br/>
<b>Example&#160;</b><br/>
0&#160;<br/>
UINT16&#160;<br/>
<b>HwID&#160;</b><br/>
&#160;<br/>
401 (0x191)&#160;<br/>
2&#160;<br/>
UINT8&#160;<br/>
FW_Version_Major&#160;<br/>
&#160;<br/>
1&#160;<br/>
3&#160;<br/>
UINT8&#160;<br/>
FW_Version_Minor&#160;<br/>
&#160;<br/>
1&#160;<br/>
4&#160;<br/>
UINT16&#160;<br/>
FW_Version_Build&#160;<br/>
&#160;<br/>
3217&#160;(0xC91)&#160;<br/>
6&#160;<br/>
UINT8[18]&#160;<br/>
<b>MAC_Address&#160;</b><br/>
string&#160;<br/>
„EC FA&#160;BC&#160;4F 04&#160;C6“&#160;<br/>
24&#160;<br/>
UINT8[33]&#160;<br/>
<b>Name&#160;</b><br/>
string&#160;<br/>
„this_is_a_quite_long_device_name“&#160;<br/>
57&#160;<br/>
UINT8&#160;<br/>
Reserved&#160;<br/>
0x00&#160;<br/>
0&#160;<br/>
&#160;<br/><b>HwID&#160;<br/></b>401&#160;=&#160;0x191&#160;…&#160;Adapter&#160;<b>10838 Z21 pro LINK</b>&#160;<br/>&#160;<br/><b>MAC_Address&#160;<br/></b>MAC&#160;address&#160;of&#160;the adapter&#160;as&#160;a&#160;null-terminated string, 8-bit&#160;ASCII.&#160;<br/>&#160;<br/><b>Name&#160;<br/></b>User-configurable name&#160;of&#160;the&#160;adapter as&#160;a&#160;null-terminated string.&#160;Maximum 32&#160;characters&#160;plus&#160;0x00&#160;<br/>zero terminator, encoding:&#160;8-bit ISO&#160;8859-1&#160;(<i>Latin-1</i>).&#160;&#160;<br/>Ignore&#160;all&#160;characters&#160;after the&#160;first 0x00.&#160;<br/>&#160;<br/>Example:&#160;<b>&#160;</b><br/>
&#160; &#160; &#160; &#160; &#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;<b>3f 00 e8 00 06</b>&#160;<b>91</b>&#160; &#160;&#160; &#160; &#160; &#160; &#160;&#160;<b>?....</b>.&#160;<br/><b>01</b>&#160;01 01 91 0c&#160;45 43 20 46 41 20 42 43 20 34 46&#160; &#160;.....EC FA BC 4F&#160;<br/>20 30 34&#160;20&#160;43 36 00&#160;74 68 69 73 5f 69 73 5f 61 &#160;&#160;&#160;04 C6.this_is_a&#160;<br/>5f 71 75 69 74 65 5f&#160;6c 6f&#160;6e&#160;67 5f 64 65 76 69 &#160; _quite_long_devi&#160;<br/>63 65 5f 6e 61 6d 65 00&#160;00 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;ce_name..&#160;<br/>HwID:&#160;<b>0x191</b>&#160;=&#160;401&#160;=&#160;10838&#160;Z21&#160;pro LINK&#160;<br/>FW&#160;Version:&#160;V1.1.3217&#160;<br/>MAC&#160;Adresse:&#160;„EC FA&#160;BC&#160;4F 04&#160;C6“&#160;<br/>Name:&#160;„this_is_a_quite_long_device_name”&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
63/78&#160;<br/>
<hr/>
<a name=64></a><img src="docs/z21-64_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>11.2&#160;&#160;Booster&#160;10806, 10807&#160;und&#160;10869&#160;</b></i><br/>
Available commands&#160;for boosters&#160;see<a href="z21.html#76">&#160;<i>Table&#160;1:&#160;Messages&#160;from&#160;Client&#160;to&#160;Z21&#160;</i></a>and<a href="z21.html#77"><i>&#160;Table&#160;2:&#160;Messages&#160;from&#160;<br/>Z21&#160;to&#160;Clients</i>.&#160;</a>In&#160;addition,&#160;some new commands&#160;have&#160;been introduced&#160;that&#160;are only&#160;valid for the&#160;<br/>boosters.&#160;<br/>
<b>11.2.1&#160;&#160;LAN_BOOSTER_GET_DESCRIPTION&#160;</b><br/>
&#160;<br/>Read&#160;the&#160;name&#160;from&#160;the&#160;booster.&#160;<br/>&#160;<br/>The&#160;user can&#160;store a&#160;name&#160;(free&#160;text)&#160;in the booster so&#160;that&#160;he&#160;can&#160;later&#160;identify&#160;the device&#160;more&#160;easily.&#160;<br/>&#160;<br/>Request to&#160;BOOSTER:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x04&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xB8</b>&#160;<br/>
0x00&#160;<br/>
-&#160;<br/>
&#160;<br/>Reply&#160;from&#160;BOOSTER:&#160;&#160;<br/>
<i>&#160;</i><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x24&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xB8</b>&#160;<br/>
0x00&#160;<br/>
UINT8&#160;<b>Name</b>[32]&#160;<br/>
&#160;<br/><b>Name</b>&#160;corresponds&#160;to&#160;the&#160;stored&#160;designation&#160;as&#160;a&#160;null-terminated string.&#160;The string should&#160;be&#160;encoded&#160;<br/>according&#160;to&#160;<b>ISO&#160;8859-1</b>&#160;&#160;(<i>Latin-1</i>)&#160;and should&#160;not be&#160;longer&#160;than 16&#160;characters&#160;for&#160;compatibility&#160;with the&#160;<br/>CAN bus.&#160;<br/>&#160;<br/><b>Special&#160;case:&#160;</b>Name [0]&#160;can be&#160;0xFF&#160;if&#160;a name&#160;has&#160;never been stored&#160;in the&#160;device.&#160;This&#160;case&#160;must be&#160;<br/>interpreted&#160;as&#160;an&#160;empty&#160;string.<b>&#160;<br/></b>&#160;<br/>Example:&#160;&#34;Test&#34;<b>&#160;</b><br/>
&#160;&#160; &#160; &#160; &#160;&#160;&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>24 00&#160;b8 00</b>&#160;<b>54 65</b>&#160; &#160;&#160; &#160; &#160; &#160; &#160;&#160;<b>$...Te</b>&#160;<br/><b>73 74</b>&#160;00 00 00 00 00 00 00 00 00 00 00 00&#160;00 00&#160; &#160;st..............&#160;<br/>00 00 00 00 00 00 00 00 00 00 00 00 00 00 &#160; &#160; &#160;&#160; &#160;..............&#160;<br/>&#160;<br/>
<b>11.2.2&#160;&#160;LAN_BOOSTER_SET_DESCRIPTION&#160;</b><br/>
&#160;<br/>Overwrite&#160;the name&#160;in&#160;the&#160;booster.&#160;<br/>&#160;<br/>Request to&#160;BOOSTER:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x24&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xB9</b>&#160;<br/>
0x00&#160;<br/>
UINT8&#160;<b>Name</b>[32]&#160;<br/>
&#160;<br/><b>Name</b>&#160;corresponds&#160;to&#160;the&#160;stored&#160;designation&#160;as&#160;a&#160;null-terminated string.&#160;The string should&#160;be&#160;encoded&#160;<br/>according&#160;to&#160;<b>ISO&#160;8859-1</b>&#160;&#160;(<i>Latin-1</i>)&#160;and should&#160;not be&#160;longer&#160;than 16&#160;characters&#160;for&#160;compatibility&#160;with the&#160;<br/>CAN bus. Fill&#160;the&#160;rest of data with 0x00.&#160;&#160;&#160;<br/><b>Not&#160;allowed&#160;characters&#160;are the quotation&#160;mark &#34;&#160;(0x22) and&#160;the backslash&#160;\&#160;(0x5C)</b>.&#160;<br/>&#160;<br/>Reply&#160;from&#160;BOOSTER:&#160;&#160;<br/>None&#160;<br/><b>&#160;</b><br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
64/78&#160;<br/>
<hr/>
<a name=65></a><img src="docs/z21-65_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>11.2.3&#160;&#160;LAN_BOOSTER_SYSTEMSTATE_GETDATA&#160;</b><br/>
&#160;<br/>Request the&#160;current system&#160;state.&#160;<br/>&#160;<br/>Request to&#160;BOOSTER:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x04&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xBB</b>&#160;<br/>
0x00&#160;<br/>
-&#160;<br/>
&#160;<br/>Reply&#160;from&#160;BOOSTER:&#160;&#160;<br/>
<i>&#160;</i><br/>
See&#160;below&#160;<a href="z21.html#65">&#160;<b>11.2.4</b>&#160;LAN_BOOSTER_SYSTEMSTATE_DATACHANGED&#160;<br/></a><i>&#160;</i><br/>
<b>11.2.4&#160;&#160;LAN_BOOSTER_SYSTEMSTATE_DATACHANGED&#160;</b><br/>
&#160;<br/>Report&#160;a change&#160;in system&#160;state&#160;of&#160;the&#160;booster to the&#160;client.&#160;<br/>&#160;<br/>This&#160;message is&#160;reported asynchronously&#160;from the booster to the&#160;client when&#160;the&#160;latter&#160;<br/>
•&#160;&#160;has&#160;activated&#160;the&#160;corresponding&#160;broadcast,&#160;&#160;<br/>
see<a href="z21.html#16">&#160;<i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;0x00000100&#160;<br/>
•&#160;&#160;has&#160;explicitly&#160;requested&#160;the&#160;system&#160;state,&#160;&#160;<br/>
see&#160;above<a href="z21.html#65"><i>&#160;<b>11.2.3</b>&#160;</i>LAN_BOOSTER_SYSTEMSTATE_GETDATA.</a>&#160;<br/>
&#160;&#160;<br/>BOOSTER&#160;to&#160;Client:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x1C&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xBA</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>BoosterSystemState</b>&#160;(24&#160;Bytes)&#160;<br/>
&#160;<br/><b>BoosterSystemState</b>&#160;is&#160;structured as&#160;follows&#160;(the 16-bit&#160;values&#160;are little&#160;endian):<b>&#160;</b><br/>
<b>Byte Offset&#160;</b><br/>
<b>Type&#160;</b><br/>
<b>Name&#160;</b><br/>
<b>&#160;</b><br/>
<b>&#160;</b><br/>
0&#160;<br/>
INT16&#160;<br/>
Booster_1_MainCurrent&#160;<br/>
mA&#160;<br/>
current&#160;1st&#160;&#160;track&#160;output&#160;<br/>
2&#160;<br/>
INT16&#160;<br/>
Booster_2_MainCurrent&#160;<br/>
mA&#160;<br/>
current&#160;2nd&#160;track&#160;output&#160;<br/>
4&#160;<br/>
INT16&#160;<br/>
Booster_1_FilteredMainCurrent&#160;&#160;mA&#160;<br/>
smoothed&#160;current&#160;1st&#160;&#160;track&#160;output&#160;<br/>
6&#160;<br/>
INT16&#160;<br/>
Booster_2_FilteredMainCurrent&#160;&#160;mA&#160;<br/>
smoothed&#160;current&#160;2nd&#160;track&#160;output&#160;&#160;<br/>
8&#160;<br/>
INT16&#160;<br/>
Booster_1_Temperature&#160;<br/>
°C&#160;<br/>
temperature&#160;1st&#160;&#160;amplifier&#160;<br/>
10&#160;<br/>
INT16&#160;<br/>
Booster_2_Temperature&#160;<br/>
°C&#160;<br/>
temperature&#160;2nd&#160;amplifier&#160;<br/>
12&#160;<br/>
UINT16&#160;&#160;SupplyVoltage&#160;<br/>
mV&#160;<br/>
supply&#160;voltage&#160;<br/>
14&#160;<br/>
UINT16&#160;&#160;Booster_1_VCCVoltage&#160;<br/>
mV&#160;<br/>
voltage&#160;1st&#160;&#160;track&#160;output&#160;<br/>
16&#160;<br/>
UINT16&#160;&#160;Booster_2_VCCVoltage&#160;<br/>
mV&#160;<br/>
voltage&#160;2nd&#160;track&#160;output&#160;<br/>
18&#160;<br/>
UINT8&#160;<br/>
CentralState&#160;<br/>
bitmask&#160;&#160;see&#160;below&#160;<br/>
19&#160;<br/>
UINT8&#160;<br/>
CentralStateEx&#160;<br/>
bitmask&#160;&#160;see&#160;below&#160;<br/>
20&#160;<br/>
UINT8&#160;<br/>
CentralStateEx2&#160;<br/>
bitmask&#160;&#160;see&#160;below&#160;<br/>
21&#160;<br/>
UINT8&#160;<br/>
Reserved1&#160;<br/>
&#160;<br/>
&#160;<br/>
22&#160;<br/>
UINT8&#160;<br/>
CentralStateEx3&#160;<br/>
bitmask&#160;&#160;see&#160;below&#160;<br/>
23&#160;<br/>
UINT8&#160;<br/>
Reserved2&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>Bitmasken&#160;für&#160;<b>CentralState</b>:&#160;<br/>
#define csTrackVoltageOff&#160;&#160;&#160;<br/>
&#160;<br/>
0x02&#160;//&#160;track is switched off&#160;<br/>
#define csConfigMode&#160;<br/>
&#160;<br/>
&#160;<br/>
0x10&#160;//&#160;configuration&#160;mode is active&#160;<br/>
#define csCanConnected&#160;<br/>
&#160;<br/>
&#160;<br/>
0x20&#160;//&#160;CAN&#160;connection with Z21 is&#160;Ok&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
65/78&#160;<br/>
<hr/>
<a name=66></a><img src="docs/z21-66_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>Bitmasken&#160;für&#160;<b>CentralStateEx</b>:&#160;<br/>#define cseHighTemperature&#160;&#160;<br/>
&#160;<br/>
0x01&#160;//&#160;over&#160;temperature&#160;<br/>
#define csePowerLost&#160;<br/>
&#160;<br/>
&#160;<br/>
0x02&#160;//&#160;supply&#160;voltage&#160;too low&#160;<br/>
#define&#160;cseBooster_1_ShortCircuit&#160;<br/>
0x04&#160;//&#160;short circuit on 1st&#160;track&#160;output&#160;<br/>
#define&#160;cseBooster_2_ShortCircuit&#160;<br/>
0x08&#160;//&#160;short circuit on&#160;2nd&#160;output&#160;<br/>
#define cseRevPol&#160;&#160;&#160;<br/>
&#160;<br/>
&#160;<br/>
0x10&#160;//&#160;supply&#160;voltage&#160;error&#160;<br/>
#define cseNoDCCInput&#160;<br/>
&#160;<br/>
&#160;<br/>
0x80&#160;//&#160;no&#160;DCC&#160;input signal&#160;<br/>
&#160;<br/>Bitmasken&#160;für&#160;<b>CentralStateEx2</b>:&#160;<br/>
#define cse2Booster_1_RailComActive&#160;<br/>
0x01&#160;//&#160;RailCom&#160;active&#160;1st&#160;track&#160;output&#160;<br/>
#define cse2Booster_2_RailComActive&#160;<br/>
0x02&#160;//&#160;RailCom&#160;active&#160;2nd&#160;track&#160;output&#160;<br/>
#define cse2Booster_1_MasterSettings&#160;<br/>
0x04&#160;//&#160;CAN&#160;autosettings Ok&#160;1st&#160;track&#160;output&#160;<br/>
#define cse2Booster_2_MasterSettings&#160;<br/>
0x08&#160;//&#160;CAN&#160;autosettings Ok&#160;2nd&#160;track&#160;output&#160;<br/>
#define cse2Booster_1_BgActive&#160;&#160;&#160;&#160;<br/>
0x10&#160;//&#160;brake generator&#160;active&#160;1st&#160;track&#160;output&#160;<br/>
#define cse2Booster_2_BgActive&#160;<br/>
&#160;&#160;&#160;<br/>
0x20&#160;//&#160;brake generator&#160;active&#160;2nd&#160;track&#160;output&#160;<br/>
#define cse2Booster_1_RailComFwd&#160;&#160;<br/>
0x40&#160;//&#160;RailCom&#160;forwarding&#160;active&#160;1st&#160;track&#160;o.&#160;<br/>
#define cse2Booster_2_RailComFwd&#160;&#160;<br/>
0x80&#160;//&#160;RailCom&#160;forwarding&#160;active&#160;2nd&#160;track&#160;o.&#160;<br/>
&#160;<br/>Bitmasken&#160;<b>fürCentralStateEx3</b>:&#160;<br/>#define&#160;cse3Booster_1_OutputInverted&#160;<br/>
0x01&#160;//&#160;1st&#160;track output inverted&#160;(autoinvert)&#160;<br/>
#define cse3Booster_2_OutputInverted&#160;<br/>
0x02&#160;//&#160;2nd&#160;track output inverted&#160;(autoinvert)&#160;<br/>
<b>From&#160;Booster&#160;FW&#160;Version&#160;1.11:&#160;<br/></b>#define cse3Booster_1_OutputDisabled&#160;<br/>
0x10&#160;//&#160;Track&#160;output&#160;1&#160;deactivated&#160;(by user)&#160;<br/>
#define cse3Booster_2_OutputDisabled&#160;<br/>
0x20&#160;//&#160;Track&#160;output&#160;2&#160;deactivated&#160;(by user)&#160;<br/>
&#160;<br/>
<b>11.2.5&#160;&#160;LAN_BOOSTER_SET_POWER&#160;</b><br/>
&#160;<br/><b>From&#160;Booster&#160;FW&#160;Version&#160;1.11</b>:&#160;Booster&#160;management&#160;by&#160;user.&#160;<br/>&#160;<br/>If all&#160;track&#160;outputs&#160;are deactivated or&#160;reactivated here&#160;on&#160;the booster, then&#160;this&#160;command&#160;de facto&#160;<br/>corresponds&#160;to&#160;<a href="z21.html#12">a&#160;LAN_X_SET_TRACK_POWER_OFF&#160;or&#160;LAN_X_SET_TRACK_POWER_ON&#160;</a>to&#160;the&#160;<br/>booster.&#160;With&#160;LAN_BOOSTER_SET_POWER, on&#160;the&#160;other hand,&#160;it&#160;is&#160;possible to&#160;switch&#160;one&#160;dedicated&#160;<br/>track&#160;output&#160;off&#160;and&#160;on&#160;in&#160;the 10807 Z21&#160;dual&#160;BOOSTER.&#160;<br/>&#160;<br/>Request to&#160;BOOSTER:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x06&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xB2</b>&#160;<br/>
0x00&#160;<br/>
<b>BoosterPort&#160;8&#160;bit&#160;</b><br/>
<b>BoosterPortState&#160;8&#160;bit&#160;</b><br/>
&#160;<br/><b>BoosterPort&#160;<br/></b>0x01&#160;…&#160;select&#160;1st&#160;booster&#160;track&#160;output&#160;<br/>0x02&#160;…&#160;select&#160;2nd&#160;booster&#160;track&#160;output&#160;(Z21 dual&#160;BOOSTER&#160;only)&#160;<br/>0x03&#160;…&#160;select&#160;all&#160;booster track&#160;outputs&#160;<br/>&#160;<br/><b>BoosterPortState&#160;<br/></b>0x00&#160;…&#160;deactivate&#160;selected booster&#160;track&#160;outputs&#160;<br/>0x01&#160;…&#160;reactivate&#160;&#160;selected booster&#160;track&#160;outputs&#160;<br/>&#160;<br/><b>Hint:</b>&#160;The&#160;booster track&#160;outputs&#160;can&#160;only&#160;be&#160;switched&#160;on&#160;again if&#160;the Z21&#160;is&#160;also switched on&#160;and&#160;is&#160;<br/>sending&#160;a&#160;valid track&#160;signal&#160;to&#160;the CAN boosters.&#160;<br/>The&#160;settings&#160;of the booster&#160;management&#160;are&#160;not saved&#160;persistently.&#160;<br/>&#160;<br/>Reply&#160;from&#160;BOOSTER:&#160;&#160;<br/>
<i>&#160;</i><br/>
On change&#160;of&#160;the&#160;BoosterSystemSta<a href="z21.html#65">te&#160;<b>11.2.4</b>&#160;LAN_BOOSTER_SYSTEMSTATE_DATACHANGED&#160;</a>to&#160;<br/>subscribed clients.&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
66/78&#160;<br/>
<hr/>
<a name=67></a><img src="docs/z21-67_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>11.3&#160;&#160;Decoder&#160;10836&#160;und&#160;10837&#160;</b></i><br/>
&#160;<br/>Available commands&#160;for&#160;decoders&#160;see<a href="z21.html#76">&#160;<i>Table&#160;1:&#160;Messages&#160;from&#160;Client&#160;to&#160;Z21&#160;</i></a>and<a href="z21.html#77"><i>&#160;Table&#160;2:&#160;Messages&#160;<br/>from&#160;Z21&#160;to&#160;Clients</i>.&#160;</a>In addition, some&#160;new commands&#160;have been&#160;introduced&#160;that&#160;are only&#160;valid for the&#160;<br/>decoders.&#160;<br/>&#160;<br/>
<b>11.3.1&#160;&#160;LAN_DECODER_GET_DESCRIPTION&#160;</b><br/>
&#160;<br/>Read&#160;the&#160;name&#160;from&#160;the&#160;decoder.&#160;<br/>&#160;<br/>The&#160;user can&#160;store a&#160;name&#160;(free&#160;text)&#160;in the&#160;decoder&#160;so&#160;that&#160;he&#160;can later&#160;identify&#160;the device&#160;more&#160;easily.&#160;<br/>&#160;<br/>Request to&#160;DECODER:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x04&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xD8</b>&#160;<br/>
0x00&#160;<br/>
-&#160;<br/>
&#160;<br/>Reply&#160;from&#160;DECODER:&#160;&#160;<br/>
<i>&#160;</i><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x24&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xD8</b>&#160;<br/>
0x00&#160;<br/>
UINT8&#160;<b>Name</b>[32]&#160;<br/>
&#160;<br/><b>Name</b>&#160;encoding&#160;see<a href="z21.html#64">&#160;11.2.1&#160;LAN_BOOSTER_GET_DESCRIPTION&#160;</a>&#160;<br/>&#160;<br/>
<b>11.3.2&#160;&#160;LAN_DECODER_SET_DESCRIPTION&#160;</b><br/>
&#160;<br/>Overwrite&#160;the name&#160;in&#160;the&#160;decoder.&#160;<br/>&#160;<br/>Request to&#160;DECODER:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x24&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xD9</b>&#160;<br/>
0x00&#160;<br/>
UINT8&#160;<b>Name</b>[32]&#160;<br/>
&#160;<br/><b>Name</b>&#160;encoding&#160;see<a href="z21.html#64">&#160;11.2.2&#160;LAN_BOOSTER_SET_DESCRIPTION.</a>&#160;<br/>&#160;<br/>Reply&#160;from&#160;DECODER:&#160;&#160;<br/>None&#160;<br/><b>&#160;</b><br/>
<b>11.3.3&#160;&#160;LAN_DECODER_SYSTEMSTATE_GETDATA&#160;</b><br/>
&#160;<br/>Request the&#160;current system&#160;state.&#160;<br/>&#160;<br/>Request to&#160;DECODER:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x04&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xDB</b>&#160;<br/>
0x00&#160;<br/>
-&#160;<br/>
&#160;<br/>Reply&#160;from&#160;DECODER:&#160;&#160;<br/>
&#160;<br/>
<i>&#160;<br/></i>See&#160;below<a href="z21.html#68">&#160;<i><b>11.3.4&#160;</b></i>LAN_DECODER_SYSTEMSTATE_DATACHANGED&#160;<br/></a>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
67/78&#160;<br/>
<hr/>
<a name=68></a><img src="docs/z21-68_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/><i>&#160;</i><br/>
<b>11.3.4&#160;&#160;LAN_DECODER_SYSTEMSTATE_DATACHANGED&#160;</b><br/>
&#160;<br/>Report&#160;a change&#160;in system&#160;state&#160;of&#160;the&#160;decoder&#160;to&#160;the&#160;client.&#160;<br/>&#160;<br/>This&#160;message is&#160;reported asynchronously&#160;from the&#160;decoder&#160;to&#160;the&#160;client&#160;when&#160;the latter&#160;<br/>
•&#160;&#160;has&#160;activated&#160;the&#160;corresponding&#160;broadcast,&#160;&#160;<br/>
see<a href="z21.html#16">&#160;<i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a>Flag&#160;0x00000100&#160;<br/>
•&#160;&#160;has&#160;explicitly&#160;requested&#160;the&#160;system&#160;state,&#160;&#160;<br/>
see&#160;above<a href="z21.html#67"><i>&#160;<b>11.3.3</b></i>&#160;LAN_DECODER_SYSTEMSTATE_GETDATA.</a>&#160;&#160;<br/>
&#160;<br/>If the signal&#160;decoder&#160;does&#160;not report after&#160;4 seconds&#160;despite&#160;the&#160;subscription&#160;via&#160;broadcastflags,&#160;because&#160;<br/>e.g.,&#160;no signal&#160;aspect&#160;has&#160;changed,&#160;polling&#160;can&#160;also be&#160;carried&#160;out&#160;if necessary.&#160;<br/>&#160;<br/>The&#160;responses&#160;of&#160;10836 Z21 switch DECODER and&#160;10837 Z21 signal&#160;DECODER&#160;<b>differ&#160;in</b>&#160;<b>structure&#160;<br/>and&#160;</b>&#160;<b>content</b>&#160;and can&#160;be&#160;recognized&#160;by&#160;<b>DataLen.</b>&#160;&#160;&#160;<br/>&#160;<br/>&#160;<br/><b>11.3.4.1&#160;&#160;SwitchDecoderSystemState&#160;<br/></b>&#160;<br/><b>10836&#160;Z21&#160;switch&#160;DECODER&#160;</b>to&#160;client:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
<b>0x30&#160;</b><br/>
0x00<b>&#160;</b><br/>
<b>0xDA</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>SwitchDecoderSystemState</b>&#160;(44&#160;Bytes)&#160;<br/>
&#160;<br/><b>SwitchdecoderSystemState</b>&#160;is&#160;structured&#160;as&#160;follows&#160;(the&#160;16-bit values&#160;are&#160;little&#160;endian):<b>&#160;</b><br/>
<b>Byte Offset&#160;</b><br/>
<b>Type&#160;</b><br/>
<b>Name&#160;</b><br/>
<b>&#160;</b><br/>
<b>&#160;</b><br/>
0&#160;<br/>
INT16&#160;<br/>
Current&#160;<br/>
mA&#160;<br/>
current&#160;<br/>
2&#160;<br/>
INT16&#160;<br/>
<b>FilteredCurrent&#160;</b><br/>
mA&#160;<br/>
smoothed&#160;current&#160;<br/>
4&#160;<br/>
UINT16&#160;<br/>
Voltage&#160;<br/>
mV&#160;<br/>
internal&#160;voltage&#160;(3.3V)&#160;<br/>
6&#160;<br/>
UINT8&#160;<br/>
<b>CentralState&#160;</b><br/>
bitmask&#160;<br/>
see&#160;below&#160;<br/>
7&#160;<br/>
UINT8&#160;<br/>
<b>CentralStateEx&#160;</b><br/>
bitmask&#160;<br/>
see&#160;below&#160;<br/>
8&#160;<br/>
UINT8[8]&#160;<br/>
<b>OutputStates</b>[0..7]&#160;<br/>
&#160;<br/>
Status&#160;per&#160;output&#160;<br/>
16&#160;<br/>
UINT8[8]&#160;<br/>
<b>OutputConfig</b>[0..7]&#160;<br/>
&#160;<br/>
Operating&#160;mode per&#160;output&#160;<br/>
24&#160;<br/>
UINT8[4]&#160;<br/>
<b>OutputDimm</b>[0..7]&#160;<br/>
&#160;<br/>
Dimming value&#160;per&#160;output&#160;<br/>
32&#160;<br/>
UINT16&#160;<br/>
<b>Address&#160;</b><br/>
&#160;<br/>
First decoder address&#160;<br/>
34&#160;<br/>
UINT16&#160;<br/>
<b>Address2&#160;</b><br/>
&#160;<br/>
Second decoder address&#160;<br/>
36&#160;<br/>
UINT8[6]&#160;<br/>
Reserved1&#160;<br/>
&#160;<br/>
&#160;<br/>
42&#160;<br/>
UINT8&#160;<br/>
<b>Dimmed&#160;</b><br/>
&#160;<br/>
1 bit per&#160;output&#160;<br/>
43&#160;<br/>
UINT8&#160;<br/>
Reserved2&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/><b>FilteredCurrent&#160;<br/></b>Sum&#160;of&#160;internal&#160;current&#160;+&#160;current&#160;at&#160;the&#160;terminal&#160;clamps.&#160;<br/>&#160;<br/>Bitmasks&#160;for&#160;<b>CentralState</b>:&#160;<br/>#define csEmergencyStop&#160;<br/>
&#160;<br/>
0x01&#160;&#160;//&#160;The emergency stop&#160;for decoder&#160;<br/>
#define csTrackVoltageOff&#160;&#160;&#160;<br/>
0x02&#160;&#160;//&#160;The track voltage is switched off&#160;<br/>
#define csShortCircuit&#160;<br/>
&#160;<br/>
0x04&#160;&#160;//&#160;Short-circuit&#160;<br/>
#define csConfigMode&#160;<br/>
&#160;<br/>
0x10&#160;&#160;//&#160;configuration&#160;mode is active&#160;<br/>
&#160;<br/>Bitmasks&#160;for&#160;<b>CentralStateEx</b>:&#160;<br/>#define csePowerLost&#160;<br/>
&#160;<br/>
0x02&#160;&#160;//&#160;Input voltage too low&#160;<br/>
#define cseRCN213&#160;&#160;&#160;<br/>
&#160;<br/>
0x20&#160;&#160;//&#160;addressing conform with&#160;RCN213&#160;<br/>
#define&#160;cseNoDCCInput&#160;<br/>
&#160;<br/>
0x80&#160;&#160;//&#160;no&#160;DCC&#160;input&#160;signal&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
68/78&#160;<br/>
<hr/>
<a name=69></a><img src="docs/z21-69_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/><b>OutputState&#160;<br/></b>State of&#160;the&#160;output&#160;(enumeration)&#160;<br/>#define oUnknown&#160;<br/>
&#160;<br/>
&#160;<br/>
0x00&#160;<br/>
#define oRedActive&#160;&#160;&#160;<br/>
&#160;<br/>
0x11&#160;<br/>
#define oRedInactive&#160;<br/>
&#160;<br/>
0x01&#160;<br/>
#define oGreenActive&#160;<br/>
&#160;<br/>
0x12&#160;<br/>
#define oGreenInactive&#160;<br/>
&#160;<br/>
0x02&#160;<br/>
&#160;<br/>&#160;<br/><b>OutputConfig&#160;<br/></b>Operating&#160;mode of&#160;the&#160;output&#160;(enumeration)&#160;<br/>#define ocfgNormal&#160;&#160;&#160;<br/>
&#160;<br/>
0&#160;<br/>
//&#160;Impulsbetrieb (default)&#160;<br/>
#define ocfgBlinker&#160;&#160;<br/>
&#160;<br/>
1&#160;<br/>
// Wechselblinker&#160;<br/>
#define ocfgBlinkSm&#160;&#160;<br/>
&#160;<br/>
2&#160;<br/>
// Wechselblinker mit&#160;Ein-&#160;und Ausblenden&#160;&#160;<br/>
#define&#160;ocfg10775&#160;&#160;&#160;&#160;<br/>
&#160;<br/>
3&#160;<br/>
//&#160;Momentbetrieb&#160;wie 10775&#160;<br/>
#define ocfgK84&#160;&#160;<br/>
&#160;<br/>
&#160;<br/>
4&#160;<br/>
//&#160;Dauerbetrieb&#160;(zB für Beleuchtung)&#160;<br/>
#define ocfgK84Sm&#160;&#160;&#160;&#160;<br/>
&#160;<br/>
5&#160;<br/>
//&#160;Dauerbetrieb&#160;mit&#160;Ein-&#160;und Ausblenden&#160;&#160;<br/>
&#160;<br/><b>OutputDimm&#160;<br/></b>Dimming value&#160;<br/>0 ... dimming&#160;deactivated, therefore&#160;corresponds&#160;to&#160;full&#160;output&#160;power.&#160;<br/>1 to&#160;100&#160;...&#160;minimum&#160;to&#160;maximum&#160;possible&#160;output&#160;power.&#160;<br/>&#160;<br/><b>Address&#160;<br/></b>A&#160;decoder&#160;address&#160;corresponds&#160;to&#160;4&#160;turnout&#160;numbers.&#160;That is:&#160;<br/>First decoder address&#160;=&#160;1&#160;...&#160;Turnout number&#160;&#160;1 to 4&#160;<br/>First decoder address&#160;=&#160;2&#160;&#160;...&#160;Turnout&#160;number&#160;&#160;5&#160;&#160;to&#160;&#160;8&#160;<br/>First decoder address&#160;=&#160;3&#160;&#160;...&#160;Turnout&#160;number&#160;&#160;9&#160;&#160;to&#160;&#160;12&#160;<br/>and&#160;so&#160;on…&#160;<br/>&#160;<br/><b>Address2</b>&#160;<br/>Second decoder address<b>&#160;=&#160;0</b>:&#160;2nd&#160;decoder address&#160;<b>automatically</b>&#160;is&#160;&#34;1st&#160;decoder&#160;address&#160;+&#160;<b>1</b>&#34;<b>&#160;<br/></b>otherwise:&#160;<br/>Second&#160;decoder&#160;address&#160;=&#160;1 ...&#160;Turnout&#160;number&#160;&#160;1 to&#160;4&#160;<br/>Second&#160;decoder address&#160;=&#160;&#160;2&#160;&#160;...&#160;Turnout number&#160;&#160;5&#160;&#160;to&#160;&#160;8&#160;<br/>Second&#160;decoder&#160;address&#160;=&#160;&#160;3&#160;&#160;...&#160;Turnout number&#160;&#160;9&#160;&#160;to&#160;&#160;12&#160;<br/>and&#160;so&#160;on...&#160;<br/>&#160;<br/><b>Dimmed&#160;<br/></b>1 bit per&#160;output&#160;pair:&#160;&#160;<br/>0 ... Output&#160;pair&#160;is&#160;not&#160;dimmed.&#160;&#160;<br/>1 ... Output&#160;pair&#160;is&#160;dimmed,&#160;or smooth dimming is&#160;configured&#160;by&#160;operation&#160;mode (light bulb simulation)&#160;<br/>LSB&#160;=&#160;output&#160;pair&#160;1;&#160;MSB&#160;=&#160;Output&#160;pair&#160;8&#160;<br/><b>&#160;</b><br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
69/78&#160;<br/>
<hr/>
<a name=70></a><img src="docs/z21-70_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/><b>11.3.4.2&#160;&#160;SignalDecoderSystemState&#160;<br/></b>&#160;<br/><b>10837 Z21 signal&#160;DECODER</b>&#160;to&#160;client:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
<b>0x2E&#160;</b><br/>
0x00<b>&#160;</b><br/>
<b>0xDA</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>SignalDecoderSystemState</b>&#160;(42&#160;Bytes)&#160;<br/>
&#160;<br/><b>SignalDecoderSystemState</b>&#160;is&#160;structured&#160;as&#160;follows&#160;(the&#160;16-bit values&#160;are&#160;little&#160;endian):<b>&#160;</b><br/>
<b>Byte Offset&#160;</b><br/>
<b>Type&#160;</b><br/>
<b>Name&#160;</b><br/>
<b>&#160;</b><br/>
<b>&#160;</b><br/>
0&#160;<br/>
INT16&#160;<br/>
Current&#160;<br/>
mA&#160;<br/>
0 /&#160;Reserved&#160;<br/>
2&#160;<br/>
INT16&#160;<br/>
FilteredCurrent&#160;<br/>
mA&#160;<br/>
0 /&#160;Reserved&#160;<br/>
4&#160;<br/>
UINT16&#160;<br/>
<b>Voltage&#160;</b><br/>
mV&#160;<br/>
voltage at&#160;the&#160;clamps&#160;<br/>
6&#160;<br/>
UINT8&#160;<br/>
<b>CentralState&#160;</b><br/>
bitmask&#160;<br/>
see&#160;below&#160;<br/>
7&#160;<br/>
UINT8&#160;<br/>
<b>CentralStateEx&#160;</b><br/>
bitmask&#160;<br/>
see&#160;below&#160;<br/>
8&#160;<br/>
UINT8[2]&#160;<br/>
<b>OutputStates</b>[0..1]&#160;<br/>
&#160;<br/>
on/off&#160;status&#160;for&#160;outputs&#160;A1... B8&#160;<br/>
10&#160;<br/>
UINT8[2]&#160;<br/>
<b>BlinkStates</b>[0..1]&#160;<br/>
&#160;<br/>
blinking&#160;status&#160;for&#160;outputs&#160;A1...&#160;B8&#160;<br/>
12&#160;<br/>
UINT8[4]&#160;<br/>
<b>SignalDccExt</b>[0..3]&#160;<br/>
DCCext&#160;<br/>
current signal&#160;aspect&#160;1st&#160;to&#160;4th&#160;signal&#160;<br/>
16&#160;<br/>
UINT8[4]&#160;<br/>
SignalCurrAsp[0..3]&#160;<br/>
index&#160;<br/>
current signal&#160;aspect&#160;1st&#160;to&#160;4th&#160;signal&#160;<br/>
20&#160;<br/>
UINT8[3]&#160;<br/>
Reserved1&#160;<br/>
&#160;<br/>
&#160;<br/>
23&#160;<br/>
UINT8&#160;<br/>
<b>SignalCount&#160;</b><br/>
2,&#160;3,&#160;4&#160;<br/>
number of signals&#160;used&#160;<br/>
24&#160;<br/>
UINT8[4]&#160;<br/>
<b>SignalConfig</b>[0..3]&#160;<br/>
Signal-ID&#160;&#160;signal&#160;configuration&#160;1st&#160;to&#160;4th&#160;signal&#160;<br/>
28&#160;<br/>
UINT8[4]&#160;<br/>
SignalInitAsp[0..3]&#160;<br/>
index&#160;<br/>
Initialization&#160;1st&#160;to 4th&#160;signal&#160;<br/>
32&#160;<br/>
UINT16&#160;<br/>
<b>Address&#160;</b><br/>
&#160;<br/>
First&#160;decoder address&#160;<br/>
34&#160;<br/>
UINT16[4]&#160;<br/>
Reserved2&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>Bitmasks&#160;for&#160;<b>CentralState</b>:&#160;<br/>#define&#160;csEmergencyStop&#160;<br/>
&#160;<br/>
0x01&#160;&#160;//&#160;The emergency stop&#160;for decoder&#160;<br/>
#define csTrackVoltageOff&#160;&#160;&#160;<br/>
0x02&#160;&#160;//&#160;The track voltage is switched off&#160;<br/>
#define csShortCircuit&#160;<br/>
&#160;<br/>
0x04&#160;&#160;//&#160;Short-circuit&#160;<br/>
#define csConfigMode&#160;<br/>
&#160;<br/>
0x10&#160;&#160;//&#160;configuration&#160;mode is active&#160;<br/>
&#160;<br/>Bitmasks&#160;for&#160;<b>CentralStateEx</b>:&#160;<br/>#define csePowerLost&#160;<br/>
&#160;<br/>
0x02&#160;&#160;//&#160;Input voltage too low&#160;<br/>
#define cseEEPromError&#160;<br/>
&#160;<br/>
0x10&#160;&#160;//&#160;EEPROM write / read error&#160;<br/>
#define cseRCN213&#160;&#160;&#160;<br/>
&#160;<br/>
0x20&#160;&#160;//&#160;addressing conform with&#160;RCN213&#160;<br/>
#define&#160;cseNoDCCInput&#160;<br/>
&#160;<br/>
0x80&#160;&#160;//&#160;no&#160;DCC&#160;input signal&#160;<br/>
&#160;<br/><b>OutputStates&#160;<br/></b>OutputStates[0]:&#160;LSB&#160;=&#160;Output&#160;A1;&#160;MSB&#160;=&#160;Output&#160;A8&#160;<br/>OutputStates[1]:&#160;LSB&#160;=&#160;Output&#160;B1;&#160;MSB&#160;=&#160;Output&#160;B8&#160;<br/>&#160;<br/><b>BlinkStates&#160;<br/></b>BlinkStates[0]: LSB&#160;=&#160;Output&#160;A1;&#160;MSB&#160;=&#160;Output&#160;A8&#160;<br/>BlinkStates[1]: LSB&#160;=&#160;Output&#160;&#160;B1;&#160;MSB&#160;=&#160;&#160;Output&#160;&#160;B8&#160;<br/>&#160;<br/><b>SignalDccExt&#160;</b>and<b>&#160;SignalConfig&#160;<br/></b>SignalConfig&#160;exactly&#160;defines&#160;the&#160;configured&#160;signal&#160;type&#160;(<b>Signal-ID</b>&#160;value).&#160;&#160;<br/>SignalDccExt defines&#160;the&#160;currently&#160;visible&#160;signal&#160;aspect&#160;(<b>DCCext</b>&#160;value)&#160;for the&#160;given&#160;Signal-ID.&#160;<b>&#160;<br/></b>For&#160;Signal-ID and&#160;DCCext&#160;values,&#160;see<a href="https://www.z21.eu/en/products/z21-signal-decoder/signaltypen">&#160;https://www.z21.eu/en/products/z21-signal-decoder/signaltypen.</a>&#160;<br/>&#160;<br/><b>Address&#160;<br/></b>A&#160;decoder&#160;address&#160;corresponds&#160;to&#160;4&#160;signal&#160;addresses.&#160;&#160;<br/>The&#160;signal&#160;decoder&#160;occupies&#160;4&#160;decoder addresses&#160;in&#160;a&#160;row&#160;and thus&#160;4x4=16&#160;signal&#160;addresses.&#160;<br/>First decoder address&#160;=&#160;1&#160;...&#160;Signal&#160;decoder&#160;uses&#160;signal&#160;addresses&#160;1&#160;to 16&#160;<br/>First decoder address&#160;=&#160;2&#160;&#160;...&#160;Signal&#160;decoder&#160;uses&#160;signal&#160;addresses&#160;&#160;5&#160;&#160;to&#160;20&#160;<br/>First decoder&#160;address&#160;=&#160;3&#160;&#160;...&#160;Signal&#160;decoder&#160;uses&#160;signal&#160;addresses&#160;&#160;9&#160;to&#160;24&#160;<br/>and&#160;so&#160;on...&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
70/78&#160;<br/>
<hr/>
<a name=71></a><img src="docs/z21-71_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>12&#160;&#160;Fast&#160;Clock&#160;<br/></b>&#160;<br/>&#160;<br/>With&#160;<b>firmware&#160;version&#160;1.43</b>, the possibilities&#160;of&#160;the&#160;already&#160;existing&#160;LocoNet&#160;fast&#160;clock&#160;have been&#160;<br/>expanded&#160;considerably.&#160;Now&#160;the&#160;accelerated&#160;fast clock&#160;time&#160;of&#160;the&#160;Z21 is&#160;also&#160;available to the&#160;devices&#160;on&#160;<br/>the&#160;main&#160;track, X-BUS,&#160;and&#160;LAN.&#160;The&#160;fast clock&#160;can&#160;be&#160;accelerated&#160;by&#160;the&#160;user up&#160;to&#160;a&#160;rate&#160;≤&#160;63.&#160;&#160;<br/>&#160;<br/>However, the&#160;Z21 does&#160;not&#160;have a&#160;real-time clock&#160;that&#160;would continue&#160;to run&#160;after&#160;switching off the&#160;<br/>command&#160;station. Therefore,&#160;the&#160;fast clock&#160;always&#160;begins&#160;with&#160;the&#160;same&#160;default&#160;start time, which can be&#160;<br/>set&#160;by&#160;the&#160;user.&#160;The user can&#160;also configure&#160;the behavior in&#160;the&#160;event&#160;of&#160;an&#160;emergency&#160;stop&#160;and short-<br/>circuit, as&#160;well&#160;as&#160;the&#160;output on the&#160;track, LocoNet, X-BUS&#160;and IP&#160;Multicast.&#160;&#160;<br/>&#160;<br/>
•&#160;&#160;For&#160;DCC&#160;model&#160;time&#160;messages&#160;on the&#160;main&#160;track&#160;see&#160;RCN-211.&#160;&#160;<br/>
&#160;<br/>
•&#160;&#160;On the&#160;LocoNet,&#160;the&#160;terminal&#160;equipment&#160;can poll&#160;the&#160;so-called&#160;clock&#160;slot&#160;(0x7B)&#160;every&#160;70&#160;to&#160;100&#160;<br/>
seconds. See&#160;also&#160;LocoNet&#160;Spec,&#160;e.g.,&#160;personal&#160;edition for learning&#160;purposes.&#160;<br/>
&#160;<br/>
•&#160;&#160;On the&#160;X-BUS, the&#160;fast clock&#160;time&#160;is&#160;reported&#160;according to&#160;XpressNet™&#160;V4.0&#160;once per&#160;model&#160;<br/>
minute.&#160;<br/>
&#160;<br/>
•&#160;&#160;On the&#160;LAN&#160;interface,&#160;the&#160;fast clock&#160;time can&#160;optionally&#160;also be sent&#160;by&#160;using&#160;&#34;MRclock&#34;&#160;multicast&#160;<br/>
messages. This&#160;allows&#160;the&#160;use of&#160;MRclock&#160;clients&#160;such as&#160;the Android&#160;MRclock&#160;app&#160;to&#160;display&#160;<br/>the&#160;fast clock&#160;time.&#160;If enabled,&#160;the&#160;MRclock&#160;multicast is&#160;then&#160;sent&#160;once per&#160;model&#160;minute&#160;(but&#160;at&#160;<br/>least&#160;three times&#160;per&#160;real&#160;minute) to the&#160;multicast&#160;address&#160;239.50.50.20, port&#160;2000.&#160;<br/>
&#160;<br/>Finally, there&#160;are also Z21&#160;LAN commands&#160;for&#160;the&#160;fast&#160;clock, which&#160;are&#160;now&#160;described as&#160;follows.&#160;<br/>&#160;<br/>
<i><b>12.1&#160;&#160;LAN_FAST_CLOCK_CONTROL&#160;</b></i><br/>
<b>12.1.1&#160;&#160;Get&#160;Fast&#160;Clock&#160;Time&#160;</b><br/>
&#160;<br/>The&#160;following&#160;command&#160;can be&#160;used&#160;to read out&#160;the current&#160;fast clock&#160;time.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xCC</b>&#160;<br/>
0x00&#160;<br/>
0x21&#160;<br/>
0x2A&#160;<br/>
0x0B&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;<b>&#160;<br/></b>See&#160;below<a href="z21.html#73">&#160;<i><b>12.2</b></i>&#160;LAN_FAST_CLOCK_DATA.</a>&#160;<br/>&#160;<br/>&#160;<br/>
<b>12.1.2&#160;&#160;Set&#160;Fast&#160;Clock&#160;Time&#160;</b><br/>
&#160;<br/>The&#160;following&#160;command&#160;can be&#160;used&#160;to set&#160;the&#160;current&#160;fast clock&#160;rate&#160;and&#160;time&#160;to&#160;a desired&#160;point&#160;in&#160;time.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x0A&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xCC</b>&#160;<br/>
0x00&#160;<br/>
0x24&#160;<br/>
0x2B&#160;<br/>
DDDhhhhh&#160;<br/>
00mmmmmm&#160;<br/>
00rrrrrr&#160;&#160;XOR-Byte&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
71/78&#160;<br/>
<hr/>
<a name=72></a><img src="docs/z21-72_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/><b>DDD&#160;</b><br/>
<b>&#160;</b>The&#160;desired&#160;day&#160;of&#160;the&#160;week&#160;in&#160;3&#160;bits.&#160;&#160;&#160;<br/>Value&#160;ranges&#160;from&#160;0&#160;=&#160;Monday&#160;to&#160;6 =&#160;Sunday.&#160;<br/>
<b>&#160;<br/>hhhhh</b>&#160;&#160;&#160;<br/>
The&#160;hour in 5&#160;bits, value&#160;range&#160;0 to&#160;23.&#160;<br/>
&#160;<br/><b>mmmmmm</b>&#160;<br/>
The&#160;minute&#160;in 6&#160;bits, value&#160;range&#160;0 to&#160;59.&#160;<br/>
&#160;<br/><b>rrrrrr&#160;</b><br/>
&#160;The&#160;desired&#160;fast clock&#160;rate&#160;(acceleration&#160;factor)&#160;in&#160;6&#160;bits.&#160;&#160;&#160;<br/>Value&#160;ranges&#160;from&#160;0&#160;to&#160;63:&#160;&#160;<br/>(0 ...&#160;fast clock&#160;stands&#160;still.&#160;Not&#160;recommended,&#160;better&#160;use<a href="z21.html#72">&#160;<i><b>12.1.4</b></i>&#160;Stop&#160;Fast Clock&#160;Time)</a>&#160;<br/>1 ...&#160;real&#160;time&#160;<br/>2 ...&#160;model&#160;time runs&#160;twice&#160;as&#160;fast&#160;<br/>3&#160;...&#160;model&#160;time runs&#160;three times&#160;as&#160;fast&#160;<br/>and&#160;so&#160;on…&#160;&#160;&#160;<br/><b>Note:</b>&#160;The&#160;fast clock&#160;rate&#160;is&#160;stored persistently&#160;in&#160;the&#160;Z21.&#160;<br/>
&#160;<br/>XOR-Byte&#160;<br/>
XOR&#160;checksum&#160;across&#160;Data&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;<b>&#160;<br/><a href="z21.html#73"><i>12.2</i></b>&#160;LAN_FAST_CLOCK_DATA&#160;</a>to&#160;subscribed&#160;clients.&#160;<br/>&#160;<br/>&#160;<br/>
<b>12.1.3&#160;&#160;Start&#160;Fast&#160;Clock&#160;Time&#160;</b><br/>
&#160;<br/>The&#160;following&#160;command&#160;can be&#160;used&#160;to&#160;resume&#160;the&#160;fast&#160;clock&#160;operation.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xCC</b>&#160;<br/>
0x00&#160;<br/>
0x21&#160;<br/>
0x2C&#160;<br/>
0x0D&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;<b>&#160;<br/><a href="z21.html#73"><i>12.2</i></b>&#160;LAN_FAST_CLOCK_DATA&#160;</a>to&#160;subscribed&#160;clients.&#160;<br/>&#160;<br/><b>Note:</b>&#160;The&#160;changed status&#160;&#34;fcFastClockEnabled&#34;&#160;is&#160;stored&#160;persistently&#160;in&#160;the&#160;Z21.&#160;<br/>&#160;<br/>&#160;<br/>
<b>12.1.4&#160;&#160;Stop&#160;Fast&#160;Clock Time&#160;</b><br/>
&#160;<br/>The&#160;following&#160;command&#160;can be&#160;used&#160;to pause the&#160;fast&#160;clock&#160;operation.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x07&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xCC</b>&#160;<br/>
0x00&#160;<br/>
0x21&#160;<br/>
0x2D&#160;<br/>
0x0C&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;<b>&#160;<br/><a href="z21.html#73"><i>12.2</i></b>&#160;LAN_FAST_CLOCK_DATA&#160;</a>to&#160;subscribed&#160;clients.&#160;<br/>&#160;<br/><b>Note:</b>&#160;The&#160;changed status&#160;&#34;fcFastClockEnabled&#34;&#160;is&#160;stored&#160;persistently&#160;in&#160;the&#160;Z21.&#160;<br/>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
72/78&#160;<br/>
<hr/>
<a name=73></a><img src="docs/z21-73_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>12.2&#160;&#160;LAN_FAST_CLOCK_DATA&#160;</b></i><br/>
&#160;<br/>Reports&#160;current&#160;fast clock&#160;time&#160;to&#160;clients. This&#160;message is&#160;reported&#160;asynchronously&#160;from the&#160;Z21 to&#160;the&#160;<br/>client,&#160;when&#160;the&#160;client&#160;&#160;<br/>
•&#160;&#160;has&#160;activated&#160;the&#160;corresponding&#160;broadcast,&#160;se<a href="z21.html#16">e&#160;<i><b>2.16&#160;</b></i>LAN_SET_BROADCASTFLAGS<i>,&#160;</i></a><i>&#160;</i><br/>
Flag&#160;0x00000010,&#160;or&#160;<br/>
•&#160;&#160;has&#160;explicitly&#160;requested&#160;the&#160;fast clock&#160;time,&#160;see abov<a href="z21.html#71">e&#160;<i><b>12.1.1</b></i>&#160;Get&#160;Fast Clock&#160;Time.</a>&#160;<br/>
&#160;<br/>When the&#160;fast clock&#160;is&#160;running, the&#160;Z21 reports&#160;this&#160;message asynchronously&#160;to&#160;the subscribed clients&#160;<br/>about once&#160;per&#160;model&#160;minute,&#160;but&#160;also when&#160;the&#160;fast&#160;clock&#160;is&#160;started,&#160;paused,&#160;or&#160;changed&#160;by&#160;the&#160;user.&#160;<br/>&#160;<br/>The&#160;Z21&#160;may&#160;also&#160;omit&#160;fast&#160;clock&#160;time messages,&#160;e.g.,&#160;if it is&#160;not&#160;running&#160;in&#160;normal&#160;operation.&#160;Skipped&#160;<br/>time&#160;messages&#160;must&#160;be&#160;tolerated&#160;by&#160;the&#160;clients&#160;and,&#160;if&#160;necessary, can&#160;be&#160;further calculated by&#160;the clients&#160;<br/>themselves&#160;based on the&#160;acceleration&#160;factor&#160;known from&#160;the&#160;previous&#160;time&#160;message.&#160;<br/>&#160;&#160;<br/>Z21&#160;to&#160;Client:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x0C&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xCD</b>&#160;<br/>
0x00<b>&#160;</b><br/>
<b>FastClockTime</b>&#160;(8&#160;Bytes)&#160;<br/>
&#160;<br/><b>FastClockTime</b>&#160;is&#160;structured&#160;as&#160;follows:<b>&#160;</b><br/>
<b>Byte Offset&#160;</b><br/>
<b>Typ&#160;</b><br/>
<b>Name&#160;</b><br/>
<b>Wert&#160;</b><br/>
<b>&#160;</b><br/>
0&#160;<br/>
UINT8&#160;<br/>
&#160;<br/>
0x66&#160;<br/>
&#160;<br/>
1&#160;<br/>
UINT8&#160;<br/>
&#160;<br/>
0x25&#160;<br/>
&#160;<br/>
2&#160;<br/>
UINT8&#160;<br/>
<b>DDDh&#160;hhhh&#160;</b><br/>
&#160;<br/>
fast&#160;clock&#160;day&#160;of the week&#160;and&#160;hour&#160;<br/>
3&#160;<br/>
UINT8&#160;<br/>
00<b>mm&#160;mmmm</b>&#160;<br/>
&#160;<br/>
fast&#160;clock&#160;minute&#160;<br/>
4&#160;<br/>
UINT8&#160;<br/>
<b>SH</b>ss&#160;ssss&#160;<br/>
&#160;<br/>
fast&#160;clock&#160;second,&#160;<br/>including&#160;STOP&#160;and&#160;HALT&#160;flag&#160;<br/>
5&#160;<br/>
UINT8&#160;<br/>
00<b>rr&#160;rrrr</b>&#160;<br/>
&#160;<br/>
fast&#160;clock&#160;rate&#160;<br/>
6&#160;<br/>
UINT8&#160;<br/>
<b>FcSettings&#160;</b><br/>
&#160;<br/>
fast&#160;clock&#160;settings&#160;flags&#160;<br/>
7&#160;<br/>
UINT8&#160;<br/>
XOR-Byte&#160;<br/>
&#160;<br/>
XOR&#160;checksum&#160;across&#160;Data&#160;&#160;<br/>
&#160;<br/><b>DDD&#160;</b><br/>
<b>&#160;</b>The&#160;current&#160;fast&#160;clock&#160;day&#160;of&#160;the&#160;week&#160;in&#160;3 bits. Value&#160;range&#160;0 =&#160;Monday&#160;to 6&#160;=&#160;Sunday.&#160;<br/>
<b>&#160;<br/>hhhhh</b>&#160;&#160;&#160;<br/>
The&#160;current&#160;fast&#160;clock&#160;hour&#160;in 5&#160;bits, value range&#160;0 to&#160;23.&#160;<br/>
&#160;<br/><b>mmmmmm</b>&#160;<br/>
The&#160;current&#160;fast&#160;clock&#160;minute&#160;in 6&#160;bits, value&#160;range 0&#160;to 59.&#160;<br/>
&#160;<br/>
<b>S</b>&#160;<br/>
<b>STOP&#160;flag:</b>&#160;the&#160;fast&#160;clock&#160;is&#160;not running.&#160;&#160;&#160;<br/>The&#160;reason&#160;may&#160;be&#160;that&#160;the&#160;fast clock&#160;is&#160;not&#160;enabled,&#160;or&#160;the rate =&#160;0,&#160;etc.&#160;<br/>
&#160;<br/>
<b>H</b>&#160;<br/>
<b>HALT&#160;flag:</b>&#160;the&#160;fast&#160;clock&#160;has&#160;been temporarily&#160;paused.&#160;&#160;&#160;<br/>The&#160;reason&#160;can&#160;be&#160;an&#160;emergency&#160;stop&#160;or&#160;a short circuit on the&#160;main&#160;track.&#160;<br/>
&#160;<br/><b>ssssss</b>&#160;&#160;<br/>
The&#160;current&#160;fast&#160;clock&#160;second&#160;in 6&#160;bits, value range&#160;0&#160;to 59.&#160;<br/>
<b>&#160;<br/>rrrrrr&#160;</b><br/>
&#160;The&#160;current&#160;fast clock&#160;rate&#160;(acceleration&#160;factor)&#160;in 6&#160;bits, value range 0&#160;to&#160;63:&#160;&#160;<br/>(0 ...&#160;fast clock&#160;cannot run)&#160;<br/>1 ...&#160;real&#160;time&#160;<br/>2 ...&#160;model&#160;time runs&#160;twice&#160;as&#160;fast&#160;<br/>3 ...&#160;model&#160;time runs&#160;three times&#160;as&#160;fast&#160;<br/>and so&#160;on.&#160;&#160;<br/>
&#160;<br/><b>FcSettings</b>&#160;<br/>
The&#160;persistent&#160;fast clock&#160;settings&#160;flags,&#160;bit-coded.&#160;<br/>
&#160;<br/>
&#160;<br/>
Meaning&#160;of&#160;the&#160;bits&#160;see<a href="z21.html#74">&#160;<i><b>12.3&#160;</b></i>LAN_FAST_CLOCK_SETTINGS_GET.</a>&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
73/78&#160;<br/>
<hr/>
<a name=74></a><img src="docs/z21-74_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>12.3&#160;&#160;LAN_FAST_CLOCK_SETTINGS_GET&#160;</b></i><br/>
&#160;<br/>The&#160;following&#160;command&#160;can be&#160;used&#160;to read the persistent&#160;fast clock&#160;settings.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x05&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xCE</b>&#160;<br/>
0x00&#160;<br/>
0x04&#160;<br/>
&#160;<br/>Reply&#160;from Z21:&#160;<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x08&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xCE</b>&#160;<br/>
0x00&#160;<br/>
<b>FcSettings&#160;</b><br/>
<b>Rate&#160;</b><br/>
<b>StartDDDhhhhh&#160;</b><br/>
<b>StartMMMMMM&#160;</b><br/>
&#160;<br/>The&#160;individual&#160;parameters&#160;in Data are&#160;each&#160;8 bits&#160;wide.&#160;<br/>&#160;<br/><b>FcSettings</b>&#160;<br/>
&#160;<br/>
The&#160;fast clock&#160;settings&#160;flags,&#160;bit-coded, see&#160;below.&#160;<br/>
&#160;<br/><b>Rate&#160;</b><br/>
&#160;<br/>
The&#160;desired&#160;fast clock&#160;rate&#160;(acceleration&#160;factor).&#160;&#160;<br/>Value&#160;range&#160;0 to 63:&#160;&#160;<br/>(0 ...&#160;fast&#160;clock&#160;cannot run,&#160;not recommended)&#160;<br/>1 ...&#160;real&#160;time&#160;<br/>2 ...&#160;model&#160;time runs&#160;twice&#160;as&#160;fast&#160;<br/>3 ...&#160;model&#160;time runs&#160;three times&#160;as&#160;fast&#160;<br/>and so&#160;on.&#160;&#160;<br/>
&#160;<br/><b>StartDDDhhhhh</b>&#160;<br/>
Default start&#160;time:&#160;weekday&#160;and&#160;hour when switching&#160;on the&#160;command&#160;station.&#160;<br/>DDD is&#160;the&#160;day&#160;of&#160;the&#160;week&#160;in&#160;3 bits. Value range&#160;0 =&#160;Monday&#160;to&#160;6 =&#160;Sunday.&#160;<br/>hhhhh is&#160;the&#160;hour&#160;in&#160;5 bits,&#160;value&#160;range 0&#160;to 23.&#160;<br/>
&#160;<br/><b>StartMMMMMM</b>&#160;<br/>
Default start&#160;time:&#160;minute&#160;when switching&#160;on the&#160;command station.&#160;&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
MMMMMM is&#160;the&#160;minute&#160;in&#160;6 bits, value range&#160;0 to&#160;59&#160;<br/>
&#160;<br/>&#160;<br/>Bitmasks&#160;for&#160;<b>Fcsettings</b>:&#160;<br/>#define fcFastClockLocoNetEn&#160;<br/>
&#160;<br/>
0x01&#160;//&#160;activate output on&#160;LocoNet (polled)&#160;<br/>
#define fcFastClockXBUSEn&#160;&#160;&#160;<br/>
&#160;<br/>
0x02&#160;//&#160;activate broadcast on&#160;XBUS&#160;<br/>
//&#160;&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
0x04 // reserved&#160;<br/>
#define fcFastClockDCCEn&#160;&#160;&#160;<br/>
&#160;<br/>
0x08&#160;//&#160;activate DCC broadcast on&#160;main&#160;track&#160;<br/>
#define fcFastClockMRclockEn&#160;<br/>
&#160;<br/>
0x10&#160;//&#160;enable&#160;sending&#160;MRclock&#160;multicasts&#160;<br/>
//&#160;&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
0x20&#160;// reserved&#160;<br/>
#define fcFastClockEmergenyHaltEn&#160;<br/>
0x40&#160;//&#160;halt&#160;fast clock on emergency stop&#160;aut.&#160;<br/>
#define fcFastClockEnabled&#160;&#160;<br/>
&#160;<br/>
0x80&#160;//&#160;activate fast clock&#160;<br/>
&#160;<br/>All&#160;bits&#160;declared&#160;here&#160;as&#160;&#34;reserved&#34;&#160;are reserved&#160;for&#160;future extensions&#160;and should&#160;neither&#160;be evaluated&#160;<br/>nor&#160;changed.&#160;<br/>&#160;<br/>The&#160;flag&#160;<b>fcFastClockEmergenyHaltEn</b>&#160;causes&#160;the&#160;fast&#160;clock&#160;to&#160;be automatically&#160;paused&#160;during an&#160;<br/>emergency&#160;stop&#160;or short circuit.&#160;&#160;<br/>&#160;<br/>The&#160;bit&#160;<b>fcFastClockEnabled</b>&#160;is&#160;<i>the</i>&#160;enable flag&#160;for&#160;the fast clock.&#160;Similar&#160;to&#160;<b>Rate,&#160;</b>it&#160;is&#160;not only&#160;changed via&#160;<br/>the<a href="z21.html#75">&#160;LAN_FAST_CLOCK_SETTINGS_SET&#160;</a>command&#160;described&#160;below,&#160;but&#160;also&#160;indirectly&#160;via&#160;<br/><a href="z21.html#71">LAN_FAST_CLOCK_CONTROL, i</a>.e.,&#160;by&#160;starting&#160;or&#160;stopping&#160;the&#160;fast clock.&#160;<br/>&#160;<br/>The&#160;<b>factory defaults</b>&#160;are&#160;FcSettings=0x4F, Rate=1,&#160;StartDDDhhhhh=0,&#160;and&#160;StartMMMMMM=0.&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
74/78&#160;<br/>
<hr/>
<a name=75></a><img src="docs/z21-75_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>12.4&#160;&#160;LAN_FAST_CLOCK_SETTINGS_SET&#160;</b></i><br/>
&#160;<br/>The&#160;persistent&#160;fast clock&#160;settings&#160;can&#160;be specifically&#160;overwritten with&#160;the&#160;following&#160;commands.&#160;<br/>The&#160;individual&#160;parameters&#160;in Data are&#160;each&#160;8 bits&#160;wide.&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x05&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xCF</b>&#160;<br/>
0x00&#160;<br/>
<b>FcSettings</b>&#160;<br/>
&#160;<br/>This&#160;will&#160;only&#160;overwrite the&#160;fast&#160;clock&#160;settings&#160;flags&#160;<b>FcSettings</b>.&#160;<br/>&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x06&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xCF</b>&#160;<br/>
0x00&#160;<br/>
<b>FcSettings</b>&#160;<br/>
<b>Rate&#160;</b><br/>
&#160;<br/>This&#160;will&#160;only&#160;overwrite the&#160;fast clock&#160;settings&#160;flags&#160;<b>FcSettings</b>&#160;and&#160;the&#160;fast clock&#160;<b>Rate</b>.&#160;<br/>&#160;<br/>&#160;<br/>Request to&#160;Z21:<b>&#160;</b><br/>
<b>DataLen&#160;</b><br/>
<b>Header&#160;</b><br/>
<b>Data</b>&#160;<br/>
0x08&#160;<br/>
0x00<b>&#160;</b><br/>
<b>0xCF</b>&#160;<br/>
0x00&#160;<br/>
<b>FcSettings</b>&#160;<br/>
<b>Rate</b>&#160;<br/>
<b>StartDDDhhhhh</b>&#160;<br/>
<b>StartMMMMMM</b>&#160;<br/>
&#160;<br/>This&#160;overrides&#160;the&#160;fast clock&#160;settings&#160;flags&#160;<b>FcSettings,</b>&#160;the&#160;fast clock&#160;<b>Rate&#160;</b>and the&#160;<b>default&#160;start&#160;time</b>.&#160;<br/>The&#160;default start&#160;time is&#160;the&#160;time that&#160;is&#160;adopted when&#160;the&#160;Z21&#160;is&#160;powered&#160;on.&#160;<br/>&#160;<br/>Description&#160;of the&#160;individual&#160;fields&#160;see&#160;above<a href="z21.html#74">&#160;<i><b>12.3&#160;</b></i>LAN_FAST_CLOCK_SETTINGS_GET.</a>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>Reply&#160;from Z21:&#160;<b>&#160;<br/></b>None.&#160;<br/>
<i>&#160;</i><br/>
<b>&#160;<br/></b>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
75/78&#160;<br/>
<hr/>
<a name=76></a><img src="docs/z21-76_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<b>Appendix&#160;A&#160;–&#160;Command&#160;overview&#160;</b><br/>
<i><b>Client&#160;to&#160;Z21&#160;</b></i><br/>
&#160;<br/>These messages&#160;can&#160;be&#160;sent&#160;from&#160;a client to&#160;a&#160;Z21&#160;or&#160;zLink&#160;device.&#160;<br/>&#160;<br/>
<b>Header&#160;&#160;Data&#160;</b><br/>
<b>Name</b>&#160;<br/>
<b>LAN&#160;</b><br/>
<b>zLink&#160;</b><br/>
X-Header&#160;<br/>
DB0&#160;<br/>
Parameter&#160;<br/>
<b>Z21&#160;</b><br/>
<b>z21&#160;</b><br/>
<b>Booster&#160;</b><br/>
<b>Decoder&#160;</b><br/>
<b>Z21&#160;XL&#160;</b><br/>
<b>z21start&#160;</b><br/>
<b>10806&#160;</b><br/>
<b>10836&#160;</b><br/>
<b>10807&#160;</b><br/>
<b>10837&#160;</b><br/>
<b>10869&#160;</b><br/>
0x10&#160;<br/>
-&#160;<br/>
<a href="z21.html#11">LAN_GET_SERIAL_NUMBER&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x18&#160;<br/>
-&#160;<br/>
<a href="z21.html#20">LAN_GET_CODE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x1A&#160;<br/>
-&#160;<br/>
<a href="z21.html#19">LAN_GET_HWINFO&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x30&#160;<br/>
-&#160;<br/>
<a href="z21.html#11">LAN_LOGOFF&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x21&#160;<br/>
0x21&#160;<br/>
-&#160;<br/>
<a href="z21.html#11">LAN_X_GET_VERSION&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x21&#160;<br/>
0x24&#160;<br/>
-&#160;<br/>
<a href="z21.html#12">LAN_X_GET_STATUS&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x21&#160;<br/>
0x80&#160;<br/>
-&#160;<br/>
<a href="z21.html#12">LAN_X_SET_TRACK_POWER_OFF&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x21&#160;<br/>
0x81&#160;<br/>
-&#160;<br/>
<a href="z21.html#12">LAN_X_SET_TRACK_POWER_ON&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;(4)&#160;<br/>
0x40&#160;<br/>
0x22&#160;<br/>
0x11&#160;<br/>
Register&#160;<br/>
<a href="z21.html#44">LAN_X_DCC_READ_REGISTER&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0x23&#160;<br/>
0x11&#160;<br/>
CV-Address&#160;<br/>
<a href="z21.html#37">LAN_X_CV_READ&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x23&#160;<br/>
0x12&#160;<br/>
Register,&#160;Value&#160;<br/>
<a href="z21.html#44">LAN_X_DCC_WRITE_REGISTER&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0x24&#160;<br/>
0x12&#160;<br/>
CV-Address,&#160;Value&#160;<br/>
<a href="z21.html#37">LAN_X_CV_WRITE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x24&#160;<br/>
0xFF&#160;<br/>
Register,&#160;Value&#160;<br/>
<a href="z21.html#43">LAN_X_MM_WRITE_BYTE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0x43&#160;<br/>
Turnout&#160;address&#160;<br/>
<a href="z21.html#31">LAN_X_GET_TURNOUT_INFO&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x44&#160;<br/>
Accessory decoder&#160;address&#160;<br/>
<a href="z21.html#36">LAN_X_GET_EXT_ACCESSORY_INFO&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
✓&#160;(3)&#160;<br/>
0x40&#160;<br/>
0x53&#160;<br/>
Turnout&#160;address,&#160;&#160;command&#160;<br/>
<a href="z21.html#31">LAN_X_SET_TURNOUT&#160;</a><br/>
✓&#160;<br/>
✓&#160;(1)&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x54&#160;<br/>
Accessory decoder&#160;address,&#160;State&#160;<br/>
<a href="z21.html#35">LAN_X_SET_EXT_ACCESSORY&#160;</a><br/>
✓&#160;<br/>
✓&#160;(1)&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x80&#160;<br/>
-&#160;<br/>
<a href="z21.html#15">LAN_X_SET_STOP&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
✓&#160;(5)&#160;<br/>
0x40&#160;<br/>
0x92&#160;<br/>
Loco&#160;address&#160;<br/>
<a href="z21.html#29">LAN_X_SET_LOCO_E_STOP&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0xE3&#160;<br/>
0x44&#160;<br/>
Loco&#160;address&#160;<br/>
<a href="z21.html#29">LAN_X_PURGE_LOCO&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0xE3&#160;<br/>
0xF0&#160;<br/>
Loco&#160;address&#160;<br/>
<a href="z21.html#23">LAN_X_GET_LOCO_INFO&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0xE4&#160;<br/>
0x1s&#160;<br/>
Loco&#160;address,&#160;&#160;Speed&#160;<br/>
<a href="z21.html#24">LAN_X_SET_LOCO_DRIVE&#160;</a><br/>
✓&#160;<br/>
✓&#160;(1)&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0xE4&#160;<br/>
0xF8&#160;<br/>
Loco&#160;address,&#160;&#160;Function&#160;<br/>
<a href="z21.html#25">LAN_X_SET_LOCO_FUNCTION&#160;</a><br/>
✓&#160;<br/>
✓&#160;(1)&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0xE4&#160;<br/>
Group&#160;&#160;Loco&#160;address,&#160;Function&#160;group&#160;<br/>
<a href="z21.html#26">LAN_X_SET_LOCO_FUNCTION_GROUP&#160;</a><br/>
✓&#160;<br/>
✓&#160;(1)&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0xE4&#160;<br/>
0x5F&#160;<br/>
Loco&#160;address,&#160;Binary&#160;state&#160;<br/>
<a href="z21.html#27">LAN_X_SET_LOCO_BINARY_STATE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0xE6&#160;<br/>
0x30&#160;<br/>
POM-Param,&#160;Option&#160;0xEC&#160;<br/>
<a href="z21.html#39">LAN_X_CV_POM_WRITE_BYTE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0xE6&#160;<br/>
0x30&#160;<br/>
POM-Param,&#160;Option&#160;0xE8&#160;<br/>
<a href="z21.html#39">LAN_X_CV_POM_WRITE_BIT&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0xE6&#160;<br/>
0x30&#160;<br/>
POM-Param,&#160;Option&#160;0xE4&#160;<br/>
<a href="z21.html#40">LAN_X_CV_POM_READ_BYTE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0xE6&#160;<br/>
0x31&#160;<br/>
POM-Param,&#160;Option&#160;0xEC&#160;<br/>
<a href="z21.html#41">LAN_X_CV_POM_ACCESSORY_WRITE_BYTE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0xE6&#160;<br/>
0x31&#160;<br/>
POM-Param,&#160;Option&#160;0xE8&#160;<br/>
<a href="z21.html#41">LAN_X_CV_POM_&#160;ACCESSORY_WRITE_BIT&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0xE6&#160;<br/>
0x31&#160;<br/>
POM-Param,&#160;Option&#160;0xE4&#160;<br/>
<a href="z21.html#42">LAN_X_CV_POM_&#160;ACCESSORY_READ_BYTE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0xF1&#160;<br/>
0x0A&#160;<br/>
-&#160;<br/>
<a href="z21.html#15">LAN_X_GET_FIRMWARE_VERSION&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x50&#160;<br/>
Broadcast-Flags&#160;<br/>
<a href="z21.html#16">LAN_SET_BROADCASTFLAGS&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x51&#160;<br/>
-&#160;<br/>
<a href="z21.html#17">LAN_GET_BROADCASTFLAGS&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x60&#160;<br/>
Loco&#160;address&#160;<br/>
<a href="z21.html#21">LAN_GET_LOCOMODE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x61&#160;<br/>
Loco&#160;address,&#160;Mode&#160;<br/>
<a href="z21.html#21">LAN_SET_LOCOMODE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x70&#160;<br/>
Accessory decoder&#160;address&#160;<br/>
<a href="z21.html#22">LAN_GET_TURNOUTMODE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x71&#160;<br/>
Accessory decoder&#160;address,&#160;Mode&#160;<br/>
<a href="z21.html#22">LAN_SET_TURNOUTMODE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x81&#160;<br/>
Group&#160;index&#160;<br/>
<a href="z21.html#45">LAN_RMBUS_GETDATA&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x82&#160;<br/>
Address&#160;<br/>
<a href="z21.html#46">LAN_RMBUS_PROGRAMMODULE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x85&#160;<br/>
-&#160;<br/>
<a href="z21.html#19">LAN_SYSTEMSTATE_GETDATA&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x89&#160;<br/>
Address&#160;<br/>
<a href="z21.html#48">LAN_RAILCOM_GETDATA&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
0xA2&#160;<br/>
LocoNet&#160;message&#160;<br/>
<a href="z21.html#51">LAN_LOCONET_FROM_LAN&#160;</a><br/>
✓&#160;<br/>
✓&#160;(1)(2)&#160;<br/>
&#160;<br/>
&#160;<br/>
0xA3&#160;<br/>
Loco&#160;address&#160;<br/>
<a href="z21.html#52">LAN_LOCONET_DISPATCH_ADDR&#160;</a><br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
0xA4&#160;<br/>
Type,&#160;Report&#160;address&#160;<br/>
<a href="z21.html#52">LAN_LOCONET_DETECTOR&#160;</a><br/>
✓&#160;<br/>
✓&#160;(2)&#160;<br/>
&#160;<br/>
&#160;<br/>
0xC4&#160;<br/>
Type,&#160;NId&#160;<br/>
<a href="z21.html#57">LAN_CAN_DETECTOR&#160;</a><br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
0xC8&#160;<br/>
NetID&#160;<br/>
<a href="z21.html#59">LAN_CAN_DEVICE_GET_DESCRIPTION&#160;</a><br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
0xC9&#160;<br/>
NetID,&#160;Name&#160;<br/>
<a href="z21.html#59">LAN_CAN_DEVICE_SET_DESCRIPTION&#160;</a><br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
0xCB&#160;<br/>
NetID,&#160;PowerState&#160;<br/>
<a href="z21.html#61">LAN_CAN_BOOSTER_SET_TRACKPOWER&#160;</a><br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
0xCC&#160;<br/>
Fastclock&#160;Start/Stop/Get/Set&#160;Command&#160;<br/>
<a href="z21.html#71">LAN_FAST_CLOCK_CONTROL&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0xCE&#160;<br/>
Len&#160;<br/>
<a href="z21.html#74">LAN_FAST_CLOCK_SETTINGS_GET&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0xCF&#160;<br/>
Fastclock Settings&#160;<br/>
<a href="z21.html#75">LAN_FAST_CLOCK_SETTINGS_SET&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0xB2&#160;<br/>
BoosterPort,&#160;BoosterPowerState&#160;<br/>
<a href="z21.html#66">LAN_BOOSTER_SET_POWER&#160;</a><br/>
&#160;<br/>
&#160;<br/>
✓&#160;<br/>
&#160;<br/>
0xB8&#160;<br/>
-&#160;<br/>
<a href="z21.html#64">LAN_BOOSTER_GET_DESCRIPTION&#160;</a><br/>
&#160;<br/>
&#160;<br/>
✓&#160;<br/>
&#160;<br/>
0xB9&#160;<br/>
String&#160;<br/>
<a href="z21.html#64">LAN_BOOSTER_SET_DESCRIPTION&#160;</a><br/>
&#160;<br/>
&#160;<br/>
✓&#160;<br/>
&#160;<br/>
0xBB&#160;<br/>
-&#160;<br/>
<a href="z21.html#65">LAN_BOOSTER_SYSTEMSTATE_GETDATA&#160;</a><br/>
&#160;<br/>
&#160;<br/>
✓&#160;<br/>
&#160;<br/>
0xD8&#160;<br/>
-&#160;<br/>
<a href="z21.html#67">LAN_DECODER_GET_DESCRIPTION&#160;</a><br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0xD9&#160;<br/>
String&#160;<br/>
<a href="z21.html#67">LAN_DECODER_SET_DESCRIPTION&#160;</a><br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0xDB&#160;<br/>
-&#160;<br/>
<a href="z21.html#67">LAN_DECODER_SYSTEMSTATE_GETDATA&#160;</a><br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0xE8&#160;<br/>
0x06&#160;<br/>
-&#160;<br/>
<a href="z21.html#63">LAN_ZLINK_GET_HWINFO&#160;</a><br/>
&#160;<br/>
&#160;<br/>
✓&#160;(6)&#160;<br/>
✓&#160;(6)&#160;<br/>
<b>Table&#160;1:&#160;Messages from&#160;Client&#160;to&#160;Z21&#160;</b><br/>
(1)&#160;&#160;z21start:&#160;fully&#160;functional&#160;only&#160;with&#160;activation&#160;code&#160;(order&#160;number&#160;10814&#160;or&#160;10818)&#160;<br/>(2)&#160;&#160;z21,&#160;z21start:&#160;virtual&#160;LocoNet&#160;stack&#160;(for&#160;example&#160;GBM16XN&#160;with&#160;XPN&#160;interface)&#160;<br/>(3)&#160;&#160;from&#160;decoder&#160;FW&#160;V1.11&#160;<br/>(4)&#160;&#160;Decoder:&#160;Turn&#160;on&#160;signal&#160;lamps&#160;again&#160;(10837&#160;only)&#160;<br/>(5)&#160;&#160;Decoder:&#160;shows&#160;stop&#160;aspect&#160;if&#160;the&#160;second&#160;bit&#160;(0x02)&#160;is&#160;set&#160;in&#160;CV38&#160;(10837&#160;only)&#160;<br/>(6)&#160;&#160;Answered&#160;by&#160;the&#160;10838&#160;Z21&#160;pro&#160;LINK,&#160;not&#160;by&#160;its&#160;terminal&#160;device&#160;(booster&#160;or&#160;decoder)&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
76/78&#160;<br/>
<hr/>
<a name=77></a><img src="docs/z21-77_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>&#160;<br/>
<i><b>Z21&#160;to&#160;Client&#160;</b></i><br/>
&#160;<br/>These messages&#160;can&#160;be&#160;sent&#160;to&#160;a client&#160;from&#160;a Z21&#160;or&#160;zLink&#160;device.&#160;<br/>&#160;<br/>
<b>Header&#160;&#160;Data&#160;</b><br/>
<b>Name</b>&#160;<br/>
<b>LAN&#160;</b><br/>
<b>zLink&#160;</b><br/>
X-Header&#160;<br/>
DB0&#160;<br/>
Daten&#160;<br/>
<b>Z21&#160;</b><br/>
<b>z21&#160;</b><br/>
<b>Booster&#160;</b><br/>
<b>Decoder&#160;</b><br/>
<b>Z21&#160;XL&#160;</b><br/>
<b>z21start&#160;</b><br/>
<b>10806&#160;</b><br/>
<b>10836&#160;</b><br/>
<b>10807&#160;</b><br/>
<b>10837&#160;</b><br/>
<b>10869&#160;</b><br/>
0x10&#160;<br/>
Serialnumber&#160;<br/>
Reply&#160;<a href="z21.html#11">to&#160;LAN_GET_SERIAL_NUMBER&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x18&#160;<br/>
Code&#160;<br/>
Rep<a href="z21.html#20">ly to&#160;LAN_GET_CODE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x1A&#160;<br/>
HWType,&#160;FW&#160;Version&#160;(BCD)&#160;<br/>
Rep<a href="z21.html#19">ly to&#160;LAN_GET_HWINFO&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x43&#160;<br/>
Turnout&#160;information&#160;<br/>
<a href="z21.html#34">LAN_X_TURNOUT_INFO&#160;</a><br/>
✓&#160;<br/>
✓&#160;(1)&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x44&#160;<br/>
Accessory&#160;state&#160;information&#160;<br/>
<a href="z21.html#36">LAN_X_EXT_ACCESSORY_INFO&#160;</a><br/>
✓&#160;<br/>
✓&#160;(1)&#160;<br/>
&#160;<br/>
✓&#160;(3)&#160;<br/>
0x40&#160;<br/>
0x61&#160;<br/>
0x00&#160;<br/>
-&#160;<br/>
<a href="z21.html#13">LAN_X_BC_TRACK_POWER_OFF&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0x61&#160;<br/>
0x01&#160;<br/>
-&#160;<br/>
<a href="z21.html#13">LAN_X_BC_TRACK_POWER_ON&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0x61&#160;<br/>
0x02&#160;<br/>
-&#160;<br/>
<a href="z21.html#13">LAN_X_BC_PROGRAMMING_MODE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0x61&#160;<br/>
0x08&#160;<br/>
-&#160;<br/>
<a href="z21.html#13">LAN_X_BC_TRACK_SHORT_CIRCUIT&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;(4)&#160;<br/>
&#160;(4)&#160;<br/>
0x40&#160;<br/>
0x61&#160;<br/>
0x12&#160;<br/>
-&#160;<br/>
<a href="z21.html#37">LAN_X_CV_NACK_SC&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0x61&#160;<br/>
0x13&#160;<br/>
-&#160;<br/>
<a href="z21.html#38">LAN_X_CV_NACK&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x61&#160;<br/>
0x82&#160;<br/>
-&#160;<br/>
<a href="z21.html#14">LAN_X_UNKNOWN_COMMAND&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x62&#160;<br/>
0x22&#160;<br/>
State&#160;<br/>
<a href="z21.html#14">LAN_X_STATUS_CHANGED&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x63&#160;<br/>
0x21&#160;<br/>
XBus&#160;Version,&#160;ID&#160;<br/>
Rep<a href="z21.html#11">ly to&#160;LAN_X_GET_VERSION&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x64&#160;<br/>
0x14&#160;<br/>
CV-Result&#160;<br/>
<a href="z21.html#38">LAN_X_CV_RESULT&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0x40&#160;<br/>
0x81&#160;<br/>
-&#160;<br/>
<a href="z21.html#15">LAN_X_BC_STOPPED&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0xEF&#160;<br/>
Loco&#160;information&#160;&#160;<br/>
<a href="z21.html#28">LAN_X_LOCO_INFO&#160;</a><br/>
✓&#160;<br/>
✓&#160;(1)&#160;<br/>
&#160;<br/>
&#160;<br/>
0x40&#160;<br/>
0xF3&#160;<br/>
0x0A&#160;<br/>
Version&#160;(BCD)&#160;<br/>
Rep<a href="z21.html#15">ly to&#160;LAN_X_GET_FIRMWARE_VERSION&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x51&#160;<br/>
Broadcast-Flags&#160;<br/>
Rep<a href="z21.html#17">ly to&#160;LAN_GET_BROADCASTFLAGS&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
0x60&#160;<br/>
Loco&#160;address, Mode&#160;<br/>
Reply t<a href="z21.html#21">o&#160;LAN_GET_LOCOMODE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x70&#160;<br/>
Accessory&#160;decoder&#160;address,&#160;Mode&#160;<br/>
Reply&#160;<a href="z21.html#22">to&#160;LAN_GET_TURNOUTMODE&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x80&#160;<br/>
Group&#160;index,&#160;Feedback status&#160;<br/>
<a href="z21.html#45">LAN_RMBUS_DATACHANGED&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x84&#160;<br/>
SystemState&#160;<br/>
<a href="z21.html#18">LAN_SYSTEMSTATE_DATACHANGED&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0x88&#160;<br/>
RailCom&#160;data&#160;<br/>
<a href="z21.html#47">LAN_RAILCOM_DATACHANGED&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
0xA0&#160;<br/>
LocoNet-Meldung&#160;<br/>
<a href="z21.html#50">LAN_LOCONET_Z21_RX&#160;</a><br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
0xA1&#160;<br/>
LocoNet-Meldung&#160;<br/>
<a href="z21.html#50">LAN_LOCONET_Z21_TX&#160;</a><br/>
✓&#160;<br/>
✓&#160;(2)&#160;<br/>
&#160;<br/>
&#160;<br/>
0xA2&#160;<br/>
LocoNet-Meldung&#160;<br/>
<a href="z21.html#51">LAN_LOCONET_FROM_LAN&#160;</a><br/>
✓&#160;<br/>
✓&#160;(2)&#160;<br/>
&#160;<br/>
&#160;<br/>
0xA3&#160;<br/>
Loco&#160;address,&#160;Ergebnis&#160;<br/>
<a href="z21.html#52">LAN_LOCONET_DISPATCH_ADDR&#160;</a><br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
0xA4&#160;<br/>
Type,&#160;Feedback&#160;address,Info&#160;<br/>
<a href="z21.html#52">LAN_LOCONET_DETECTOR&#160;</a><br/>
✓&#160;<br/>
✓&#160;(2)&#160;<br/>
&#160;<br/>
&#160;<br/>
0xC4&#160;<br/>
Occupancy message&#160;<br/>
<a href="z21.html#57">LAN_CAN_DETECTOR&#160;</a><br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
0xC8&#160;<br/>
NetID,&#160;Name&#160;<br/>
Reply&#160;<a href="z21.html#59">to&#160;LAN_CAN_DEVICE_GET_DESCRIPTION&#160;</a><br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
0xCA&#160;<br/>
CANBoosterSystemState&#160;<br/>
<a href="z21.html#60">LAN_CAN_BOOSTER_SYSTEMSTATE_CHGD&#160;</a><br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
0xCD&#160;<br/>
Fastclock Time&#160;<br/>
<a href="z21.html#73">LAN_FAST_CLOCK_DATA&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0xCE&#160;<br/>
Fastclock Settings&#160;<br/>
<a href="z21.html#74">LAN_FAST_CLOCK_SETTINGS_GET&#160;</a><br/>
✓&#160;<br/>
✓&#160;<br/>
&#160;<br/>
&#160;<br/>
0xB8&#160;<br/>
String&#160;<br/>
Rep<a href="z21.html#64">ly to&#160;LAN_BOOSTER_GET_DESCRIPTION&#160;</a><br/>
&#160;<br/>
&#160;<br/>
✓&#160;<br/>
&#160;<br/>
0xBA&#160;<br/>
BoosterSystemState&#160;<br/>
<a href="z21.html#65">LAN_BOOSTER_SYSTEMSTATE_DATACHANGED&#160;</a><br/>
&#160;<br/>
&#160;<br/>
✓&#160;<br/>
&#160;<br/>
0xD8&#160;<br/>
String&#160;<br/>
Rep<a href="z21.html#67">ly to&#160;LAN_DECODER_GET_DESCRIPTION&#160;</a><br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0xDA&#160;<br/>
DecoderSystemState&#160;<br/>
<a href="z21.html#68">LAN_DECODER_SYSTEMSTATE_DATACHANGED&#160;</a><br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
✓&#160;<br/>
0xE8&#160;<br/>
0x06&#160;<br/>
&#160;Z_Hw_Info&#160;<br/>
Rep<a href="z21.html#63">ly to&#160;LAN_ZLINK_GET_HWINFO&#160;</a><br/>
&#160;<br/>
&#160;<br/>
✓&#160;(5)&#160;<br/>
✓&#160;(5)&#160;<br/>
<b>Table&#160;2:&#160;Messages from&#160;Z21&#160;to&#160;Clients&#160;</b><br/>
(1)&#160;&#160;z21start:&#160;fully&#160;functional&#160;only&#160;with&#160;activation&#160;code&#160;(order&#160;number&#160;10814&#160;or&#160;10818)&#160;<br/>(2)&#160;&#160;z21,&#160;z21start:&#160;virtual&#160;LocoNet&#160;stack&#160;(for&#160;example&#160;GBM16XN&#160;with&#160;XPN&#160;interface)&#160;<br/>(3)&#160;&#160;from&#160;decoder&#160;FW&#160;V1.11&#160;<br/>(4)&#160;&#160;Short-circuit&#160;is&#160;reported&#160;in&#160;the&#160;corresponding&#160;booster/decoder&#160;system&#160;state.&#160;<br/>(5)&#160;&#160;Answered&#160;by&#160;the&#160;10838&#160;Z21&#160;pro&#160;LINK,&#160;not&#160;by&#160;its&#160;terminal&#160;device&#160;(booster&#160;or&#160;decoder)&#160;<br/>&#160;<br/>
&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
77/78&#160;<br/>
<hr/>
<a name=78></a><img src="docs/z21-78_1.png"/><br/>
&#160;<br/>
Z21&#160;LAN&#160;Protocol&#160;Specification&#160;<br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;<br/>
&#160;<br/>
<b>List of figures&#160;<br/></b>&#160;<br/><a href="z21.html#8">Figure&#160;1 Example&#160;Sequence:&#160;Communication&#160;.............................................................................................&#160;8&#160;<br/></a><a href="z21.html#23">Figure&#160;2&#160;Example sequence:&#160;locomotive control........................................................................................&#160;23&#160;<br/></a><a href="z21.html#32">Figure&#160;3 DCC&#160;Sniff&#160;on&#160;track&#160;with&#160;Q=0&#160;........................................................................................................&#160;32&#160;<br/></a><a href="z21.html#33">Figure&#160;4 DCC&#160;Sniff&#160;on&#160;track&#160;with&#160;Q=1&#160;........................................................................................................&#160;33&#160;<br/></a><a href="z21.html#34">Figure&#160;5 Example&#160;Sequence:&#160;Turnout&#160;switching&#160;........................................................................................&#160;34&#160;<br/></a><a href="z21.html#38">Figure&#160;6 Example&#160;Sequence:&#160;CV&#160;Reading&#160;.................................................................................................&#160;38&#160;<br/></a><a href="z21.html#46">Figure&#160;7 Example&#160;Sequence:&#160;Programming&#160;the&#160;feedback&#160;module&#160;............................................................&#160;46&#160;<br/></a><a href="z21.html#49">Figure&#160;8 Example&#160;Sequence:&#160;Ethernet/LocoNet&#160;gateway&#160;.........................................................................&#160;49&#160;<br/></a><a href="z21.html#52">Figure&#160;9 Example&#160;Sequence:&#160;LocoNet Dispatch&#160;per&#160;LAN-Client&#160;...............................................................&#160;52&#160;</a><br/>
<b>&#160;<br/></b>&#160;<br/>&#160;<br/>&#160;<br/>&#160;<br/>
<b>List of tables&#160;<br/></b>&#160;<br/><a href="z21.html#76">Table&#160;1:&#160;Messages&#160;from&#160;Client to Z21&#160;.......................................................................................................&#160;76&#160;<br/></a><a href="z21.html#77">Table&#160;2:&#160;Messages&#160;from&#160;Z21 to Clients&#160;......................................................................................................&#160;77&#160;</a><br/>
<b>&#160;<br/></b>&#160;<br/>&#160;<br/>&#160;<br/>
Document&#160;Version 1.13&#160;en&#160;<br/>
06.11.2023&#160;<br/>
78/78&#160;<br/>
<hr/>
</body>
</html>
